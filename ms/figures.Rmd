---
title: "Manuscript figures"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(patchwork)
library(ggtext)
library(here)
library(sf)
library(rnaturalearth)
```

# Localities map

```{r, eval=FALSE}
ne_download(scale = 50, type = 'populated_places', category = 'cultural', 
            destdir = here("data", "raw", "cartographic"), load = FALSE)
ne_download(scale = 10, type = 'minor_islands', category = 'physical', 
            destdir = here("data", "raw", "cartographic"), load = FALSE)
```

```{r}
cities <- ne_load(scale = 50, type = 'populated_places', category = 'cultural', 
                  destdir = here("data", "raw", "cartographic"), returnclass = 'sf')
norcities <- filter(cities, NAME %in% c("Oslo", "Trondheim", "Bergen"))
norislands <- ne_load(scale = 10, type = 'minor_islands', category = 'physical', 
                destdir = here("data", "raw", "cartographic"), returnclass = 'sf') %>% 
  st_crop(xmin = 4, xmax = 32, ymin = 58, ymax = 72) %>% 
  st_transform(crs = 25833) # ETRS89 / UTM zone 33N

nor50 <- ne_countries(scale = 50, country = c("Norway"), returnclass = "sf") %>% 
  st_transform(crs = 25833)
nor10 <- ne_countries(scale = 10, country = "Norway", returnclass = "sf") %>% 
  st_transform(crs = 25833)

locs <- read_csv(here("data", "localities.csv"), col_types = cols()) %>% 
  st_as_sf(coords=c("utm33.easting", "utm33.northing"), crs = 25833)
locs <- mutate(locs, species.latin = factor(species.latin, 
                                            levels = c("Picea sitchensis / lutzii",
                                                       "Picea abies",
                                                       "Larix spp.",
                                                       "Pinus contorta")))
st_bbox(locs)

filter(locs, county %in% c("Rogaland","Hordaland")) %>% 
  st_bbox()
xlimits <- c(-69e3,10e3)
ylimits <- c(6.515e6,6.775e6)
inset <- st_polygon(list(matrix(c(xlimits[1],ylimits[1],
                         xlimits[2],ylimits[1],
                         xlimits[2],ylimits[2],
                         xlimits[1],ylimits[2],
                         xlimits[1],ylimits[1]), byrow = T, ncol = 2))) %>% 
  st_sfc(crs = 25833)

filter(locs, year.registered == 2019) %>% 
  st_bbox()
xlimits2 <- c(362e3,430e3)
ylimits2 <- c(7.255e6,7.355e6)
inset2 <- st_polygon(list(matrix(c(xlimits2[1],ylimits2[1],
                         xlimits2[2],ylimits2[1],
                         xlimits2[2],ylimits2[2],
                         xlimits2[1],ylimits2[2],
                         xlimits2[1],ylimits2[1]), byrow = T, ncol = 2))) %>% 
  st_sfc(crs = 25833)

g1 <- ggplot() +
  geom_sf(data = nor50, fill = "white") + 
  geom_sf(data = norcities) +
  geom_sf_text(data = norcities, aes(label = NAME), 
               nudge_y = c(-3e4,3e4,4e4), 
               nudge_x = c(0, 10e4, 0), size = 2) +
  geom_sf(data = locs, #st_jitter(locs, amount=5e3)
          mapping = aes(color = species.latin, shape = species.latin), 
          show.legend = "point", size = 1.5, alpha = 0.6) +
  scale_shape_manual(values = c(15, 16, 17, 18)) +
  geom_sf(data = inset, fill = NA, linetype = "longdash", color = 'black') + 
  geom_sf(data = inset2, fill = NA, linetype = "longdash", color = 'black') + 
  scale_color_manual(values = c('#984ea3','#377eb8','#4daf4a','#e41a1c')) + #Set1
  coord_sf(xlim = c(-60e3,730e3), ylim = c(6.5e6,7.8e6)) +
  theme_minimal() +
  theme(legend.position = c(0.35,0.88), legend.title = element_blank(), 
        legend.text = element_text(face = "italic"),
        axis.title.x=element_blank(), axis.title.y=element_blank(),
        panel.background = element_rect(fill = "ghostwhite"))

g2 <- ggplot() +
  geom_sf(data = nor10, fill = "white") + 
  geom_sf(data = norislands, fill = "white") + 
  geom_sf(data = norcities) +
  geom_sf(data = locs, 
          mapping = aes(color = species.latin, shape = species.latin), 
          show.legend = FALSE, size = 2, alpha = 0.7) + 
  scale_shape_manual(values = c(15, 16, 17, 18)) +
  scale_color_manual(values = c('#984ea3','#377eb8','#4daf4a','#e41a1c')) + #Set1
  coord_sf(xlim = xlimits, ylim = ylimits, datum = NA) +
  theme_minimal() +
  theme(plot.margin = margin(0, 0, 0, 0),
        panel.border = element_rect(fill = NA, size=1),
        panel.background = element_rect(fill = "ghostwhite"))

g3 <- ggplot() +
  geom_sf(data = nor10, fill = "white") + 
  geom_sf(data = norislands, fill = "white") + 
  geom_sf(data = locs, 
          mapping = aes(color = species.latin, shape = species.latin), 
          show.legend = FALSE, size = 2, alpha = 0.7) + 
  scale_shape_manual(values = c(15, 16, 17, 18)) +
  scale_color_manual(values = c('#984ea3','#377eb8','#4daf4a','#e41a1c')) + #Set1
  coord_sf(xlim = xlimits2, ylim = ylimits2, datum = NA) +
  theme_minimal() +
  theme(plot.margin = margin(0, 0, 0, 0),
        panel.border = element_rect(color = "black", fill = NA, size=1),
        panel.background = element_rect(fill = "ghostwhite"))

scalefactor <- 3.6
g2x <- diff(xlimits)
g2y <- diff(ylimits)
ggplot_build(g1)$layout$coord$limits
xmax <- 750e3
ymin <- 6.45e6
g12 <- g1 + 
  annotation_custom(ggplotGrob(g2), 
                    xmin = xmax - scalefactor*g2x, xmax = xmax, 
                    ymin = ymin, ymax = ymin + scalefactor*g2y) +
  annotate("segment", linetype = "dotted",
           x = xlimits[2], xend = xmax - scalefactor*g2x, 
           y = ylimits[1], yend = ymin)
  
g2x <- diff(xlimits2)
g2y <- diff(ylimits2)
st_bbox(locs)
xmin <- -80e3
ymin <- 7.11e6
g123 <- g12 + 
  annotation_custom(ggplotGrob(g3), 
                                xmin = xmin, xmax = xmin + scalefactor*g2x, 
                                ymin = ymin, ymax = ymin + scalefactor*g2y) +
  annotate("segment", linetype = "dotted",
           x = xlimits2[1], xend = xmin + scalefactor*g2x, 
           y = ylimits2[2], yend = ymin + scalefactor*g2y)
```

```{r}
ggsave(g123, filename= 'localities-map.pdf', path = here('ms', 'figures'),
  scale = 1, width = 7, height = 11, units = 'cm', dpi = 300)
```

# Locality example

Criteria for selecting example location:

- Sitka spruce
- Has mosaic types
- Sources mapped outside 500x500 m

Of those locations that fill these criteria, chose that with most wildlings: Meaasen (2019).

```{r}
plotting <- readRDS(here("output","percell-data.rds"))
meaasen <- plotting$`P.sitchensis-lutzii`$meaasen
st_bbox(meaasen)
```

```{r}
png(filename = here('ms', 'figures', 'locality-example', 'wildlings.png'),
    width = 10, height = 10, units = 'cm', res = 300)
plot(meaasen["wildlings"], main = 'wildlings', 
     key.pos = 1, key.width = lcm(1.4))
dev.off()

png(filename = here('ms', 'figures', 'locality-example', 'WALD.png'),
    width = 10, height = 10, units = 'cm', res = 300)
plot(meaasen["seeds.WALD"], main = 'WALD seed probability density', 
     key.pos = 1, key.width = lcm(1.4), logz = TRUE, at = c(-5,-4,-3))
dev.off()

png(filename = here('ms', 'figures', 'locality-example', 'T2.png'),
    width = 10, height = 10, units = 'cm', res = 300)
plot(meaasen["T2"], main = 'open shallow-soil ground', 
     key.pos = 1, key.width = lcm(1.4), nbreaks = 6)
dev.off()

png(filename = here('ms', 'figures', 'locality-example', 'T4.png'),
    width = 10, height = 10, units = 'cm', res = 300)
plot(meaasen["T4"], main = 'forest', 
     key.pos = 1, key.width = lcm(1.4), nbreaks = 6)
dev.off()
```

# Relative establishment

```{r}
results <- readRDS(here("output","results.rds"))
types <- read_csv(here('data', 'types.csv')) %>% 
  select(-vegheight) %>% 
  mutate(name = case_when(
    category == 'terrestrial' & is.na(structuring) ~ 
      name,
    category == 'terrestrial' & !is.na(structuring) ~ 
      paste0(paste0('**',name),'**'),
    category == 'wetland' & is.na(structuring) ~ 
      paste0(paste0('*',name),'*'),
    category == 'wetland' & !is.na(structuring) ~ 
      paste0(paste0('***',name),'***'))
  )

arith <- results$arithmetic %>% 
  bind_rows(.id = "species") %>% 
  filter(!(n == 0 & daa < 5)) %>% 
  rename(type = nin) %>% 
  left_join(types, by = 'type') %>% 
  select(-daa, -n, -density) %>% 
  mutate(modeled = FALSE)
  
est <- results$model.preds %>% 
  bind_rows(.id = "species") %>% 
  rename(type = nin) %>% 
  left_join(types, by = 'type') %>% 
  mutate(modeled = TRUE)

dat <- bind_rows(est, arith)
dat
tail(dat)
print(filter(types, type %in% dat$type), n=32)
```

```{r}
typerank <- filter(est.scaled, is.na(locality)) %>% 
  mutate(wgt = 1/(log(ci.u) - log(ci.l))) %>% 
  group_by(species) %>% 
  group_split() %>% 
  map(~ mutate(., fit.rank = percent_rank(.data$fit))) %>% 
  bind_rows() %>% 
  group_by(type) %>% 
  summarize(rank = weighted.mean(fit.rank, wgt)) %>% 
  arrange(rank)

plot <- dat %>% 
  left_join(typerank, by = 'type') %>%
  mutate(rank = if_else(is.na(rank), -1, rank)) %>%
  mutate(name = fct_reorder(name, rank))

str(plot)
```

```{r}
d <- filter(plot, species == "P.sitchensis-lutzii")
col <- '#984ea3'
g1 <- ggplot(data = d, mapping = aes(x = name)) + 
  scale_x_discrete(drop = FALSE) +
  geom_vline(xintercept = which(levels(d$name) == 'forest'), linetype = "dotted") +
  geom_point(data = filter(d, modeled == TRUE, !is.na(locality)),
             mapping = aes(y = fit), color = 'grey', alpha = 0.5, pch = 20,
             position = position_jitter(width = 0.1)) +
  geom_linerange(mapping = aes(ymin = ci.l, ymax = ci.u), color = col, size = 1) +
  geom_point(data = filter(d, modeled == TRUE, is.na(locality)),
             mapping = aes(y = fit), color = col, size = 2) +
  geom_point(data = filter(d, modeled == FALSE), mapping = aes(y = fit), 
             color = col, pch = 1, size = 2) +
  scale_y_log10(
    breaks = scales::trans_breaks("log10", function(x) 10^x),
    labels = scales::trans_format("log10", scales::math_format(10^.x)),
    minor_breaks = NULL) +
  coord_flip(ylim = c(1e-3, 1e2)) +
  labs(title = 'Picea sitchensis / lutzii', 
       x = 'ecosystem type', y = 'relative establishment probability') +
  theme_light() + 
  theme(axis.text.y = element_markdown(),
        plot.title = element_text(face = 'italic'))

d <- filter(plot, species == "P.abies")
col <- '#377eb8'
g2 <- ggplot(data = d, mapping = aes(x = name)) + 
  scale_x_discrete(drop = FALSE) +
  geom_vline(xintercept = which(levels(d$name) == 'forest'), linetype = "dotted") +
  geom_point(data = filter(d, modeled == TRUE, !is.na(locality)),
             mapping = aes(y = fit), color = 'grey', alpha = 0.5, pch = 20,
             position = position_jitter(width = 0.1)) +
  geom_linerange(mapping = aes(ymin = ci.l, ymax = ci.u), color = col, size = 1) +
  geom_point(data = filter(d, modeled == TRUE, is.na(locality)),
             mapping = aes(y = fit), color = col, size = 2) +
  geom_point(data = filter(d, modeled == FALSE), mapping = aes(y = fit), 
             color = col, pch = 1, size = 2) +
  scale_y_log10(
    breaks = scales::trans_breaks("log10", function(x) 10^x),
    labels = scales::trans_format("log10", scales::math_format(10^.x)),
    minor_breaks = NULL) +
  coord_flip(ylim = c(1e-3, 1e2)) +
  labs(title = 'Picea abies') +
  theme_light() +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x = element_blank(),
        plot.title = element_text(face = 'italic'))

d <- filter(plot, species == "Larix")
col <- '#4daf4a'
g3 <- ggplot(data = d, mapping = aes(x = name)) + 
  scale_x_discrete(drop = FALSE) +
  geom_vline(xintercept = which(levels(d$name) == 'forest'), linetype = "dotted") +
  geom_point(data = filter(d, modeled == TRUE, !is.na(locality)),
             mapping = aes(y = fit), color = 'grey', alpha = 0.5, pch = 20,
             position = position_jitter(width = 0.1)) +
  geom_linerange(mapping = aes(ymin = ci.l, ymax = ci.u), color =col, size = 1) +
  geom_point(data = filter(d, modeled == TRUE, is.na(locality)),
             mapping = aes(y = fit), color = col, size = 2) +
  geom_point(data = filter(d, modeled == FALSE), mapping = aes(y = fit), 
             color = col, pch = 1, size = 2) +
  scale_y_log10(
    breaks = scales::trans_breaks("log10", function(x) 10^x),
    labels = scales::trans_format("log10", scales::math_format(10^.x)),
    minor_breaks = NULL) +
  coord_flip(ylim = c(1e-3, 1e3)) +
  labs(title = 'Larix') +
  theme_light() +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x = element_blank(),
        plot.title = element_text(face = 'italic'))

d <- filter(plot, species == "P.contorta")
col <- '#e41a1c'
g4 <- ggplot(data = d, mapping = aes(x = name)) + 
  scale_x_discrete(drop = FALSE) +
  geom_vline(xintercept = which(levels(d$name) == 'forest'), linetype = "dotted") +
  geom_point(data = filter(d, modeled == TRUE, !is.na(locality)),
             mapping = aes(y = fit), color = 'grey', alpha = 0.5, pch = 20,
             position = position_jitter(width = 0.1)) +
  geom_linerange(mapping = aes(ymin = ci.l, ymax = ci.u), color = col, size = 1) +
  geom_point(data = filter(d, modeled == TRUE, is.na(locality)),
             mapping = aes(y = fit), color = col, size = 2) +
  geom_point(data = filter(d, modeled == FALSE), mapping = aes(y = fit), 
             color = col, pch = 1, size = 2) +
  scale_y_log10(
    breaks = scales::trans_breaks("log10", function(x) 10^x),
    labels = scales::trans_format("log10", scales::math_format(10^.x)),
    minor_breaks = NULL) +
  coord_flip(ylim = c(1e-2, 1e4)) +
  labs(title = 'Pinus contorta') +
  theme_light() +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x = element_blank(),
        plot.title = element_text(face = 'italic'))

g1234 <- g1 + g2 + g3 + g4 + 
  plot_layout(ncol = 4)
```

```{r}
ggsave(g1234, filename= 'relative-establishment.pdf', path = here('ms', 'figures'),
  scale = 1, width = 34, height = 21, units = 'cm', dpi = 300)
```



# Relative establishment hypotheses

```{r}
results.wetland <- readRDS(here("output","results-wetland.rds"))

dwet <- results.wetland %>% 
  bind_rows(.id = "species") %>% 
  mutate(category = case_when(
    category == 'terr' ~ 'terrestrial',
    category == 'wetl' ~ '*wetland*'
  ))

typerank <- filter(dwet, modeled) %>% 
  mutate(wgt = 1/(log(ci.u) - log(ci.l))) %>% 
  group_by(species) %>% 
  group_split() %>% 
  map(~ mutate(., fit.rank = percent_rank(.data$fit))) %>% 
  bind_rows() %>% 
  group_by(category) %>% 
  summarize(rank = weighted.mean(fit.rank, wgt)) %>% 
  arrange(rank)

plotwet <- dwet %>% 
  left_join(typerank, by = 'category') %>%
  mutate(category = fct_reorder(category, rank))

results.disturbance <- readRDS(here("output","results-disturbance.rds"))

ddisturb <- results.disturbance %>% 
  bind_rows(.id = "species") %>% 
  mutate(structuring = case_when(
    structuring == 'nodisturb' ~ 'no<br>disturbance',
    structuring == 'nadisturb' ~ '**natural<br>disturbance**',
    structuring == 'andisturb' ~ '**anthropogenic<br>disturbance**'
  ))

typerank <- filter(ddisturb, modeled) %>% 
  mutate(wgt = 1/(log(ci.u) - log(ci.l))) %>% 
  group_by(species) %>% 
  group_split() %>% 
  map(~ mutate(., fit.rank = percent_rank(.data$fit))) %>% 
  bind_rows() %>% 
  group_by(structuring) %>% 
  summarize(rank = weighted.mean(fit.rank, wgt)) %>% 
  arrange(rank)

plotdisturb <- ddisturb %>% 
  left_join(typerank, by = 'structuring') %>%
  mutate(structuring = fct_reorder(structuring, rank))

ylimits <- bind_rows(plotwet, plotdisturb) %>%
  pivot_longer(cols = c('ci.l', 'ci.u'), names_to = 'ci') %>%
  group_by(species) %>% 
  group_split() %>%
  map(~ range(pull(., value), na.rm = TRUE))
names(ylimits) <- bind_rows(plotwet, plotdisturb) %>% 
  pull(species) %>% 
  unique()
```

```{r}
d <- filter(plotwet, species == "P.sitchensis-lutzii")
col <- '#984ea3'
g1 <- ggplot(data = d, mapping = aes(x = category)) + 
  scale_x_discrete(drop = FALSE) +
  geom_vline(xintercept = which(levels(d$category) == 'terrestrial'), 
             linetype = "dotted") +
  geom_linerange(data = filter(d, modeled == TRUE), 
                 mapping = aes(ymin = ci.l, ymax = ci.u), color = col, size = 1) +
  geom_point(data = filter(d, modeled == TRUE),
             mapping = aes(y = fit), color = col, size = 2) +
  geom_point(data = filter(d, modeled == FALSE), mapping = aes(y = fit), 
             color = col, pch = 1, size = 2) +
  scale_y_continuous(
    trans = "log2",
    breaks = scales::breaks_log(base = 2),
    labels = scales::trans_format("log2", scales::math_format(2^.x)),
    minor_breaks = NULL) +
  coord_flip(ylim = ylimits$`P.sitchensis-lutzii`) +
  labs(title = 'Picea sitchensis / lutzii',  x = 'ecosystem\ncategory') +
  theme_light() + 
  theme(axis.text.y = element_markdown(),
        plot.title = element_text(face = 'italic'),
        axis.title.x = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x = element_blank()) 

d <- filter(plotwet, species == "P.abies")
col <- '#377eb8'
g2 <- ggplot(data = d, mapping = aes(x = category)) + 
  scale_x_discrete(drop = FALSE) +
  geom_vline(xintercept = which(levels(d$category) == 'terrestrial'), 
             linetype = "dotted") +
  geom_linerange(data = filter(d, modeled == TRUE), 
                 mapping = aes(ymin = ci.l, ymax = ci.u), color = col, size = 1) +
  geom_point(data = filter(d, modeled == TRUE),
             mapping = aes(y = fit), color = col, size = 2) +
  geom_point(data = filter(d, modeled == FALSE), mapping = aes(y = fit), 
             color = col, pch = 1, size = 2) +
  scale_y_continuous(
    trans = "log10",
    breaks = scales::breaks_log(base = 10),
    labels = scales::trans_format("log10", scales::math_format(10^.x)),
    minor_breaks = NULL) +
  coord_flip(ylim = ylimits$P.abies) +
  labs(title = 'Picea abies') +
  theme_light() +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x = element_blank(),
        plot.title = element_text(face = 'italic'))

d <- filter(plotwet, species == "Larix")
col <- '#4daf4a'
g3 <- ggplot(data = d, mapping = aes(x = category)) + 
  scale_x_discrete(drop = FALSE) +
  geom_vline(xintercept = which(levels(d$category) == 'terrestrial'), 
             linetype = "dotted") +
  geom_linerange(data = filter(d, modeled == TRUE), 
                 mapping = aes(ymin = ci.l, ymax = ci.u), color = col, size = 1) +
  geom_point(data = filter(d, modeled == TRUE),
             mapping = aes(y = fit), color = col, size = 2) +
  geom_point(data = filter(d, modeled == FALSE), mapping = aes(y = fit), 
             color = col, pch = 1, size = 2) +
  scale_y_continuous(
    trans = "log10",
    breaks = scales::breaks_log(base = 10),
    labels = scales::trans_format("log10", scales::math_format(10^.x)),
    minor_breaks = NULL) +
  coord_flip(ylim = ylimits$Larix) +
  labs(title = 'Larix') +
  theme_light() +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x = element_blank(),
        plot.title = element_text(face = 'italic'))

d <- filter(plotwet, species == "P.contorta")
col <- '#e41a1c'
g4 <- ggplot(data = d, mapping = aes(x = category)) + 
  scale_x_discrete(drop = FALSE) +
  geom_vline(xintercept = which(levels(d$category) == 'terrestrial'), 
             linetype = "dotted") +
  geom_linerange(data = filter(d, modeled == TRUE), 
                 mapping = aes(ymin = ci.l, ymax = ci.u), color = col, size = 1) +
  geom_point(data = filter(d, modeled == TRUE),
             mapping = aes(y = fit), color = col, size = 2) +
  geom_point(data = filter(d, modeled == FALSE), mapping = aes(y = fit), 
             color = col, pch = 1, size = 2) +
  scale_y_continuous(
    trans = "log10",
    breaks = scales::breaks_log(base = 10),
    labels = scales::trans_format("log10", scales::math_format(10^.x)),
    minor_breaks = NULL) +
  coord_flip(ylim = ylimits$P.contorta) +
  labs(title = 'Pinus contorta') +
  theme_light() +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x = element_blank(),
        plot.title = element_text(face = 'italic'))

d <- filter(plotdisturb, species == "P.sitchensis-lutzii")
col <- '#984ea3'
g5 <- ggplot(data = d, mapping = aes(x = structuring)) + 
  scale_x_discrete(drop = FALSE) +
  geom_vline(xintercept = which(levels(d$structuring) == 'no<br>disturbance'), 
             linetype = "dotted") +
  geom_linerange(data = filter(d, modeled == TRUE), 
                 mapping = aes(ymin = ci.l, ymax = ci.u), color = col, size = 1) +
  geom_point(data = filter(d, modeled == TRUE),
             mapping = aes(y = fit), color = col, size = 2) +
  geom_point(data = filter(d, modeled == FALSE), mapping = aes(y = fit), 
             color = col, pch = 1, size = 2) +
  scale_y_continuous(
    trans = "log2",
    breaks = scales::breaks_log(base = 2),
    labels = scales::trans_format("log2", scales::math_format(2^.x)),
    minor_breaks = NULL) +
  coord_flip(ylim = ylimits$`P.sitchensis-lutzii`) +
  labs(x = 'ecosystem\nstructuring', y = 'relative establishment probability') +
  theme_light() + 
  theme(axis.text.y = element_markdown(),
        plot.title = element_blank())

d <- filter(plotdisturb, species == "P.abies")
col <- '#377eb8'
g6 <- ggplot(data = d, mapping = aes(x = structuring)) + 
  scale_x_discrete(drop = FALSE) +
  geom_vline(xintercept = which(levels(d$structuring) == 'no<br>disturbance'), 
             linetype = "dotted") +
  geom_linerange(data = filter(d, modeled == TRUE), 
                 mapping = aes(ymin = ci.l, ymax = ci.u), color = col, size = 1) +
  geom_point(data = filter(d, modeled == TRUE),
             mapping = aes(y = fit), color = col, size = 2) +
  geom_point(data = filter(d, modeled == FALSE), mapping = aes(y = fit), 
             color = col, pch = 1, size = 2) +
  scale_y_continuous(
    trans = "log10",
    breaks = scales::breaks_log(base = 10),
    labels = scales::trans_format("log10", scales::math_format(10^.x)),
    minor_breaks = NULL) +
  coord_flip(ylim = ylimits$P.abies) +
  theme_light() +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x = element_blank(),
        plot.title = element_blank())

d <- filter(plotdisturb, species == "Larix")
col <- '#4daf4a'
g7 <- ggplot(data = d, mapping = aes(x = structuring)) + 
  scale_x_discrete(drop = FALSE) +
  geom_vline(xintercept = which(levels(d$structuring) == 'no<br>disturbance'), 
             linetype = "dotted") +
  geom_linerange(data = filter(d, modeled == TRUE), 
                 mapping = aes(ymin = ci.l, ymax = ci.u), color = col, size = 1) +
  geom_point(data = filter(d, modeled == TRUE),
             mapping = aes(y = fit), color = col, size = 2) +
  geom_point(data = filter(d, modeled == FALSE), mapping = aes(y = fit), 
             color = col, pch = 1, size = 2) +
  scale_y_continuous(
    trans = "log10",
    breaks = scales::breaks_log(base = 10),
    labels = scales::trans_format("log10", scales::math_format(10^.x)),
    minor_breaks = NULL) +
  coord_flip(ylim = ylimits$Larix) +
  theme_light() +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x = element_blank(),
        plot.title = element_blank())

d <- filter(plotdisturb, species == "P.contorta")
col <- '#e41a1c'
g8 <- ggplot(data = d, mapping = aes(x = structuring)) + 
  scale_x_discrete(drop = FALSE) +
  geom_vline(xintercept = which(levels(d$structuring) == 'no<br>disturbance'), 
             linetype = "dotted") +
  geom_linerange(data = filter(d, modeled == TRUE), 
                 mapping = aes(ymin = ci.l, ymax = ci.u), color = col, size = 1) +
  geom_point(data = filter(d, modeled == TRUE),
             mapping = aes(y = fit), color = col, size = 2) +
  geom_point(data = filter(d, modeled == FALSE), mapping = aes(y = fit), 
             color = col, pch = 1, size = 2) +
  scale_y_continuous(
    trans = "log10",
    breaks = scales::breaks_log(base = 10),
    labels = scales::trans_format("log10", scales::math_format(10^.x)),
    minor_breaks = NULL) +
  coord_flip(ylim = ylimits$P.contorta) +
  theme_light() +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x = element_blank(),
        plot.title = element_blank())


g <- 
  g1 + g2 + g3 + g4 + 
  g5 + g6 + g7 + g8 +
  plot_layout(ncol = 4)
```

```{r}
ggsave(g, filename= 'relative-establishment-hypotheses.pdf', path = here('ms', 'figures'),
  scale = 1, width = 28, height = 10, units = 'cm', dpi = 300)
```




# sessionInfo 

```{r sessionInfo}
sessionInfo()
```