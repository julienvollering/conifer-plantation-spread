---
title: "Manuscript tables"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
results <- readRDS(here("output","results.rds"))
```

# Dispersion

Dispersion in establishment *density* vs. dispersion in *modeled establishment* (among ecosystems for which both values are estimated).

```{r}
arith <- results$arithmetic %>% 
  bind_rows(.id = "species") %>% 
  filter(n > 0) %>% 
  select(species, nin, fit) %>% 
  mutate(modeled = FALSE)
  
est <- results$model.preds %>% 
  bind_rows(.id = "species") %>% 
  filter(is.na(locality)) %>% 
  select(species, nin, fit) %>% 
  mutate(modeled = TRUE)

stopifnot(nrow(arith) == nrow(est))

dat <- bind_rows(est, arith)
```

Proportional Variability from:
Heath, Joel P., and Peter Borowski. 2013. “Quantifying Proportional Variability.” PLoS ONE 8 (12): e84074. https://doi.org/10.1371/journal.pone.0084074.

```{r}
PV <- function(x) { 
  pairs <- combn(x, 2)
  D <- apply(pairs, 2, function(z) {1 - (min(z)/max(z))})
  return(sum(D)/ncol(pairs))
}
propvar <- dat %>% 
  group_by(species, modeled) %>% 
  summarize(PV = round(PV(fit), digits = 3))
```

```{r}
dispersion <- propvar %>%
  ungroup() %>% 
  mutate(modeled = ifelse(modeled, "establishment likelihood", "density")) %>% 
  pivot_wider(names_from = modeled, values_from = PV) %>% 
  slice(4,2,1,3) %>% 
  mutate(`species group` = c("Picea sitchensis / lutzii", "Picea abies", "Larix spp.", "Pinus contorta")) %>% 
  select(4,2,3)
write.csv(dispersion, here('ms', 'tables', 'dispersion.csv'), row.names = FALSE)
```

A simpler metric but more affected by outliers:

```{r}
sumofratios <- function(x) {
  pairs <- combn(x, 2)
  rat <- apply(pairs, 2, function(z) {max(z)/min(z)})
  return(sum(rat))
}
dat %>% 
  group_by(species, modeled) %>% 
  summarize(`sum of pairwise ratios` = sumofratios(fit))
```

# Correlations between density and establishment likelihood

```{r}
data <- transpose(results[c("arithmetic", "model.preds")])
table <- map(data, function(x) {
  joined <- left_join(x$arithmetic, x$model.preds, by = "nin") %>% 
    filter(is.na(locality)) 
  vct <- c(cor(joined$fit.x, joined$fit.y, use = "complete.obs", method = c("pearson")),
           cor(joined$fit.x, joined$fit.y, use = "complete.obs", method = c("spearman")))
  return(round(vct, 2))
})
table <- transpose(table) %>% 
  map(unlist) %>%
  set_names(c("Pearson", "Spearman")) %>% 
  as_tibble() %>% 
  add_column(`species group` = c("Picea sitchensis / lutzii", "Picea abies", "Larix spp.", "Pinus contorta"), .before = 1) 
write_csv(table, here('ms', 'tables', 'corr-between-estimates.csv'))
```

# Correlations between species in establishment

```{r}
fit <- map2(results$model.preds, names(results$model.preds),  
           ~ filter(.data = .x, is.na(locality)) %>% 
             select(nin, !!.y := fit))
fitdf <- reduce(fit, full_join, by = "nin") %>% 
  select(-nin)
colnames(fitdf) <- c("Picea sitchensis / lutzii", "Picea abies", "Larix spp.", "Pinus contorta")
table <- cor(fitdf, use= "pairwise.complete.obs", method = "spearman") %>% 
  round(digits = 2)
write.csv(table, here('ms', 'tables', 'corr-between-species.csv'), row.names = TRUE)
```

# Model comparisons

```{r}
modelcomp <- results$model.comp %>% 
  set_names(c("Picea sitchensis / lutzii", "Picea abies", "Larix spp.", "Pinus contorta")) %>% 
  bind_rows(.id = "species group") %>% 
  mutate(`seed dispersal estimate` = ifelse(`seed dispersal estimate` == "ExP",
                                            "Exponential Power",
                                            `seed dispersal estimate`))
write.csv(modelcomp, here('ms', 'tables', 'modelcomp.csv'), row.names = FALSE)
```

# Model summaries

```{r}
Psmod <- results$models$`P.sitchensis-lutzii`
Nre <- Psmod$modelInfo$reStruc$condReStruc$`1 | locality`$blockReps
Ps.tidy <- broom.mixed::tidy(Psmod)
Ps <- Ps.tidy %>% 
  arrange(component) %>% 
  mutate(component = if_else(component == 'cond', 
                             'Conditional Model', 
                             'Zero-inflation model')) %>% 
  mutate(ci.l = estimate - 1.96*std.error, ci.u = estimate + 1.96*std.error) %>% 
  mutate_if(is.double, ~ round(., digits = 2)) %>% 
  mutate(`95% CI` = if_else(is.na(std.error), NA_character_, 
                            paste0(ci.l, ', ', ci.u))) %>% 
  mutate(`SD (Intercept)` = if_else(effect == 'fixed', NA_real_, estimate),
         estimate = if_else(effect == 'fixed', estimate, NA_real_),
         N = if_else(effect == 'fixed', NA_real_, Nre),
         term = if_else(effect == 'fixed', term, 'locality')) %>% 
  select(`Mixture component` = component, Term = term, Estimate = estimate, 
         `95% CI`, `SD (Intercept)`, N)
write_csv(Ps, here('ms', 'tables', 'Ps-modelsummary.csv'))

Pamod <- results$models$P.abies
Nre <- Pamod$modelInfo$reStruc$condReStruc$`1 | locality`$blockReps
Pa.tidy <- broom.mixed::tidy(Pamod)
Pa <- Pa.tidy %>% 
  arrange(component) %>% 
  mutate(component = if_else(component == 'cond', 
                             'Conditional Model', 
                             'Zero-inflation model')) %>% 
  mutate(ci.l = estimate - 1.96*std.error, ci.u = estimate + 1.96*std.error) %>% 
  mutate_if(is.double, ~ round(., digits = 2)) %>% 
  mutate(`95% CI` = if_else(is.na(std.error), NA_character_, 
                            paste0(ci.l, ', ', ci.u))) %>% 
  mutate(`SD (Intercept)` = if_else(effect == 'fixed', NA_real_, estimate),
         estimate = if_else(effect == 'fixed', estimate, NA_real_),
         N = if_else(effect == 'fixed', NA_real_, Nre),
         term = if_else(effect == 'fixed', term, 'locality')) %>% 
  select(`Mixture component` = component, Term = term, Estimate = estimate, 
         `95% CI`, `SD (Intercept)`, N)
write_csv(Pa, here('ms', 'tables', 'Pa-modelsummary.csv'))

Lmod <- results$models$Larix
Nre <- Lmod$modelInfo$reStruc$condReStruc$`1 | locality`$blockReps
L.tidy <- broom.mixed::tidy(Lmod)
L <- L.tidy %>% 
  arrange(component) %>% 
  mutate(component = if_else(component == 'cond', 
                             'Conditional Model', 
                             'Zero-inflation model')) %>% 
  mutate(ci.l = estimate - 1.96*std.error, ci.u = estimate + 1.96*std.error) %>% 
  mutate_if(is.double, ~ round(., digits = 2)) %>% 
  mutate(`95% CI` = if_else(is.na(std.error), NA_character_, 
                            paste0(ci.l, ', ', ci.u))) %>% 
  mutate(`SD (Intercept)` = if_else(effect == 'fixed', NA_real_, estimate),
         estimate = if_else(effect == 'fixed', estimate, NA_real_),
         N = if_else(effect == 'fixed', NA_real_, Nre),
         term = if_else(effect == 'fixed', term, 'locality')) %>% 
  select(`Mixture component` = component, Term = term, Estimate = estimate, 
         `95% CI`, `SD (Intercept)`, N)
write_csv(L, here('ms', 'tables', 'L-modelsummary.csv'))

Pcmod <- results$models$P.contorta
Nre <- Pcmod$modelInfo$reStruc$condReStruc$`1 | locality`$blockReps
Pc.tidy <- broom.mixed::tidy(Pcmod)
Pc <- Pc.tidy %>% 
  arrange(component) %>% 
  mutate(component = if_else(component == 'cond', 
                             'Conditional Model', 
                             'Zero-inflation model')) %>% 
  mutate(ci.l = estimate - 1.96*std.error, ci.u = estimate + 1.96*std.error) %>% 
  mutate_if(is.double, ~ round(., digits = 2)) %>% 
  mutate(`95% CI` = if_else(is.na(std.error), NA_character_, 
                            paste0(ci.l, ', ', ci.u))) %>% 
  mutate(`SD (Intercept)` = if_else(effect == 'fixed', NA_real_, estimate),
         estimate = if_else(effect == 'fixed', estimate, NA_real_),
         N = if_else(effect == 'fixed', NA_real_, Nre),
         term = if_else(effect == 'fixed', term, 'locality')) %>% 
  select(`Mixture component` = component, Term = term, Estimate = estimate, 
         `95% CI`, `SD (Intercept)`, N)
write_csv(Pc, here('ms', 'tables', 'Pc-modelsummary.csv'))
```

# sessionInfo 

```{r sessionInfo}
sessionInfo()
```