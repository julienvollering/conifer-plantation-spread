---
title: "wildlings-NiN"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(sf)
library(units)
source(here("R","locality-functions.R"))
```

```{r types to groups, eval=FALSE}
ninfiles <- list.files(here("data","qc"), pattern = "nin.shp", recursive = TRUE)
codes <- character()
for (i in ninfiles) {
  shp <- st_read(here("data","qc",i), quiet = TRUE)
  code <- gsub("(.*?)(-.*)", "\\1", as.character(shp[[1]])) %>% 
    make.names()
  codes <- append(codes, code)
  shp <- mutate(shp, code = code)
  st_write(shp, here("data","qc",i), delete_layer = TRUE, quiet = TRUE)
}

codes <- unique(codes)
codes[order(substring(codes, 1, 1), as.numeric(substring(codes, 2)))]

grouping <- tribble(
  ~code, ~group,
  "T1", "rock",
  "T2", "rock",
  "T3", "tundra",
  "T4", "forest",
  "T6", "rock",
  "T13", "talus",
  "T16", "talus",
  "T17", "talus",
  "T18", "floodplain",
  "T21", "dune",
  "T27", "talus",
  "T29", "beach",
  "T30", "forest",
  "T31", "boreal heathland",
  "T32", "semi-natural grassland",
  "T33", "semi-natural grassland",
  "T34", "coastal heathland",
  "T35", "disturbed",
  "T37", "disturbed",
  "T38", "plantation forest",
  "T39", "disturbed",
  "T40", "disturbed",
  "T41", "cultivated grassland",
  "T42", "disturbed",
  "T43", "disturbed",
  "T44", "cultivated field",
  "T45", "cultivated grassland",
  "T35.T37.T39.T43", "disturbed",
  "T35.T37", "disturbed",
  "V1", "fen",
  "V2", "swamp",
  "V3", "bog",
  "V4", "spring",
  "V8", "swamp",
  "V9", "fen",
  "V10", "fen",
  "V11", "turf roof",
  "V12", "drained mire",
  "V13", "new wetland")

for (i in ninfiles) {
  shp <- st_read(here("data","qc",i), quiet = TRUE) %>% 
    mutate(code = as.character(code))
  shp <- left_join(shp, grouping, by = "code")
  st_write(shp, here("data","qc",i), delete_layer = TRUE, quiet = TRUE)
}
```

```{r check topology, eval=FALSE}
ninfiles <- list.files(here("data","qc"), pattern = "nin.shp", recursive = TRUE)
for (i in ninfiles) {
  shp <- st_read(here("data","qc",i), quiet = TRUE)
  if (!all(st_is_valid(shp))) {
    message(paste(i, "contains invalid topology"))
  }
}
```

```{r wildlings per polygon, include=FALSE}
species <- list.files(here("data","qc"))

perNiN <- list()

for (j in species) {
  message(j)
  localities <- list.files(here("data","qc",j))

  for (i in localities) {
    nin <- st_read(here("data","qc",j,i,"nin.shp"), quiet = TRUE) %>% 
      as_tibble %>% st_as_sf()
    wildlings <- st_read(here("data","qc",j,i,"wildlings.shp"), quiet = TRUE)
    wildling.density <- calc_density_by_field(poly = nin, pts = wildlings, field = group)
    perNiN[[j]][[i]] <- wildling.density
  }
}

perNiN.agg <- lapply(perNiN, function(x) {
  bind_rows(x) %>% 
    group_by(group) %>% 
    summarize(area = sum(area), n = sum(n)) %>% 
    mutate(density = n/area) %>%
    arrange(desc(density), desc(n), area) %>% 
    mutate(area = round(area), density = round(density, digits = 1))
})
```

```{r wildlings per polygon aggregated}
lapply(perNiN.agg, knitr::kable)
```

```{r wildlings per cell, eval=FALSE}
species <- list.files(here("data","qc"))

percell <- list()

for (j in species) {
  message(j)
  localities <- list.files(here("data","qc",j))
  
  for (i in localities) {
    message(i)
    nin <- st_read(here("data","qc",j,i,"nin.shp"), quiet = TRUE) %>% 
      as_tibble %>% st_as_sf()
    grd <- make_grid(nin, gridres = 10)
    
    grd <- add_dummies_to_grid(grd, nin, field = group) %>% 
      as_tibble() %>% st_as_sf()
    grd <- grd %>% 
      mutate(rsum = rowSums(st_set_geometry(grd, NULL), na.rm = TRUE)) %>% 
      filter(rsum >= 0.5) %>% 
      select(-rsum) %>% 
      mutate_at(vars(-geometry), round, digits = 3) 
    
    sources <- st_read(here("data","qc",j,i,"sources.shp"), quiet = TRUE)
    grd <- add_seed_shadow(grd, sources)
    
    source.poly <- st_read(here("data","qc",j,i,"source_polygon.shp"), quiet = TRUE) %>% 
      filter(FID == 0)
    if (file.exists(here("data","qc",j,i,"dtm1","data","dtm1.tif"))) {
      dtm <- raster::raster(here("data","qc",j,i,"dtm1","data","dtm1.tif")) %>% 
        raster::aggregate(fact = 2)
    } else {
      dtm <- raster::raster(here("data","qc",j,i,"dtm10","data","dtm10.tif"))
    }
    grd <- add_relative_elevation(grd, source.poly, dtm)
    
    wildlings <- st_read(here("data","qc",j,i,"wildlings.shp"), quiet = TRUE)
    grd <- add_wildlings(grd, wildlings)
    
    percell[[j]][[i]] <- select(grd, wildlings, everything())
  }
}

saveRDS(percell, here("output","percell-data.rds"))
```

```{r wildlings per cell aggregated}
percell <- readRDS(here("output","percell-data.rds"))

percell.agg <- percell
for (i in seq_along(percell)) {
  for (j in seq_along(percell[[i]])) {
    percell.agg[[i]][[j]] <- percell[[i]][[j]] %>% 
      st_set_geometry(NULL) %>% 
      add_column(locality = names(percell[[i]][j]))
  }
  percell.agg[[i]] <- bind_rows(percell.agg[[i]]) %>% 
    select(locality, wildlings, seeds, relelev, everything()) %>% 
    lapply(function(x) {replace_na(x, 0)}) %>% 
    as_tibble()
}
str(percell.agg)

for (i in names(percell.agg)) {  
  hist(percell.agg[[i]][["wildlings"]], xlab = "wildlings", main = i, xlim = c(0,20), breaks = 50)
}
```

