---
title: "Lidar vegetation"
output: html_document 
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(sf)
library(raster)
```

```{r read seed sources}
sources <- read_csv(here("data","raw","seedtraps","seedsources.csv")) %>% 
  st_as_sf(coords = c(1:2), crs = 25832) # ETRS89 / UTM zone 32N
```

```{r bounding box}
gridres <- 2
grd <- st_make_grid(sources, cellsize = gridres)
bb <- st_bbox(grd)

# hoydedata.no bounding box for download
st_transform(st_as_sfc(bb), crs = 25833) %>% 
  st_buffer(dist = 10) %>% 
  st_bbox()
```

Download LAZ and raster DTM from <hoydedata.no>.

Used LAStools (via wine on osX) to create maximum vegetation height raster:

1. Open terminal and cd to LAStools/bin folder (containing .exe files)
2. Run: wine lasview -i /Users/julienvollering/Desktop/PortableOffice/conifer-plantation-spread/data/raw/seedtraps/lidar/983/data/eksport_154025_983_1.laz
3. Run: wine lascanopy -i /Users/julienvollering/Desktop/PortableOffice/conifer-plantation-spread/data/raw/seedtraps/lidar/983/data/eksport_154025_983_1.laz -max -height_cutoff 0.0 -step 1 -o /Users/julienvollering/Desktop/PortableOffice/conifer-plantation-spread/data/raw/seedtraps/lidar/LAScanopy.asc
3. Run: wine las2dem -i /Users/julienvollering/Desktop/PortableOffice/conifer-plantation-spread/data/raw/seedtraps/lidar/983/data/eksport_154025_983_1.laz -o /Users/julienvollering/Desktop/PortableOffice/conifer-plantation-spread/data/raw/seedtraps/lidar/LASdem.asc -v -step 1 -keep_class 2

```{r vegetation height raster}
canopy <- raster(here("data","raw","seedtraps","lidar","LAScanopy_max.asc"))
dem <- raster(here("data","raw","seedtraps","lidar","LASdem.asc"))
vegheight <- canopy-dem
plot(vegheight)
hist(values(vegheight))
sum(values(vegheight) < 0, na.rm=TRUE) 
vegheight[values(vegheight) < 0] <- 0

writeRaster(vegheight, here("data","raw","seedtraps","lidar","vegheight.asc"))
```

```{r sessionInfo}
sessionInfo()
```