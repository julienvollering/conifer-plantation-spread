---
title: "Join dependent--independent variables"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(sf)
library(units)
```

# Height stratification

```{r}
hgtpts <- readRDS(here("output","dependentVar.rds"))

hgtpts %>% 
  group_by(species) %>% 
  uncount(weights = count) %>% 
  summarise(lowerquartilehgt = quantile(hgt, 0.25, na.rm = TRUE),
            upperquartilehgt = quantile(hgt, 0.75, na.rm = TRUE))
hgtpts %>% 
  group_by(species) %>% 
  uncount(weights = count) %>% 
  summarise(quantile80cm = ecdf(hgt)(80),
            quantile250cm = ecdf(hgt)(250))

classlimits <- tribble(
  ~class, ~lower, ~upper,
       1,     30,     80,
       2,    250,  10000
)
```

# Height assignment

```{r}
hgtptssplit <- hgtpts %>% 
  uncount(weights = count) %>%
  group_by(species, locality) %>% 
  group_split()

hgtptsEDhgt <- hgtptssplit %>% 
  map(~ pull(., hgt) %>% 
        discard(., ~ is.na(.)))

set.seed(42)
hgtptsimpute <- map2(hgtptssplit, hgtptsEDhgt, 
                     ~ mutate(.x, 
                              hgt_impute = ifelse(is.na(hgt), TRUE, FALSE),
                              hgt = ifelse(is.na(hgt), sample(.y, 1), hgt)))

hgtptsimpute %>% 
  bind_rows() %>% 
  group_by(species, locality) %>% 
  filter(hgt_impute)
```


```{r sessionInfo}
sessionInfo()
```