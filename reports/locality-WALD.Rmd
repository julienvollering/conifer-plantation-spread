---
title: "Locality WALD"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(sf)
library(units)
source(here("R","locality-functions.R"))
source(here("R","dispersal-functions.R"))
source(here("R","SkarpaasShea_2007.R"))
```

```{r species dispersal traits}
traits <- tribble(
  ~species, ~terminal.velocity, ~dispersal.season,
  "Larix", 1.0, c(12,1:5), # After Sandvik 2012 (for L. decidua), and Sullivan 1994 (for L. decidua)
  "P.abies", 0.58, c(11:12,1:5), # After Sandvik 2012 (but see Kaliniewicz et al. 2018), and Sullivan 1994
  "P.contorta", 0.82, c(9:12), # After Sandvik 2012
  "P.sitchesis-lutz", 0.94, c(10:12,1:2) # After Sandvik 2012 (but see Kaliniewicz et al. 2018), and Harris 1990
)
```

```{r wind data sites}
poi <- read_csv(here("data","raw","NORA10","poi-lonlat.csv"))
poi <- mutate(poi, site = 1:nrow(poi)) %>% 
  st_as_sf(coords=c("X", "Y"), crs = 4326)
```


```{r WALD seed shadows, eval=FALSE}
species <- list.files(here("data","qc"))

percell <- list()

for (j in species) {
  message(j)
  localities <- list.files(here("data","qc",j))
  
  for (i in localities) {
    message(i)
    nin <- st_read(here("data","qc",j,i,"nin.shp"), quiet = TRUE) %>% 
      as_tibble %>% st_as_sf() %>% 
      filter(group != "plantation forest")
    grd <- make_grid(nin, gridres = 10)
    
    grd <- add_dummies_to_grid(grd, nin, field = group) %>% 
      as_tibble() %>% st_as_sf()
    grd <- grd %>% 
      mutate(rsum = rowSums(st_set_geometry(grd, NULL), na.rm = TRUE)) %>% 
      filter(rsum >= 0.5) %>% 
      select(-rsum) %>% 
      mutate_at(vars(-geometry), round, digits = 3) 
    
    sources <- st_read(here("data","qc",j,i,"sources.shp"), quiet = TRUE)
   
    site <- st_transform(grd[1,], crs = st_crs(poi)) %>% 
      st_nearest_feature(poi)
    st_transform(grd[1,], crs = st_crs(poi)) %>%
      st_distance(poi[site,]) %>% 
      round() %>% 
      paste("meters away") %>% 
      message
    DD <- read_delim(here("data","raw","NORA10","nora10bc.WindDir.txt"), delim = ";") %>% 
      filter(SITE == site)
    FF <- read_delim(here("data","raw","NORA10","nora10bc.WindSpeed.txt"), delim = ";") %>% 
      filter(SITE == site)
    NORAwind <- left_join(DD, FF, by = "TIME") %>% 
      rename(DD = WD, FF = WS) %>% 
      mutate(TIME = as.character(TIME)) %>% 
      mutate(Mnth = substring(TIME, 5, 6)) %>% 
      drop_na()
    windobs <- NORAwind
  }
}

```

