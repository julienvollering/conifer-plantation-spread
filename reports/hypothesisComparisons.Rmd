---
title: "Compare groupings of ecosystem types hypothesized to differ"
output: 
  html_document:
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(here)
library(tidyverse)
library(glmmTMB)
```

```{r}
types <- read_csv(here('data','types.csv'))
datlist <- readRDS(here("output","data.rds"))
results <- readRDS(here("output","results.rds"))

terr <- filter(types, category == 'terrestrial') %>% pull(type)
wetl <- filter(types, category == 'wetland') %>% pull(type)
nodist <- filter(types, is.na(structuring)) %>% pull(type)
stress <- filter(types, structuring == 'environmental stress') %>% pull(type)
regdist <- filter(types, structuring == 'regulating disturbance') %>% pull(type)
desdist <- filter(types, structuring == 'destabilizing disturbance') %>% pull(type)
modandist <- filter(types, structuring == 'moderate anthropogenic disturbance') %>% pull(type)
strandist <- filter(types, structuring == 'strong anthropogenic disturbance') %>% pull(type)

locality.preds <- c('age','bio01','bio19','seeds.ExP','seeds.WALD','relelev')
datlist <- datlist %>% 
  map(~ mutate(., 
               terr = rowSums(select(., one_of(terr)), na.rm = TRUE),
               wetl = rowSums(select(., one_of(wetl)), na.rm = TRUE),
               nodist = rowSums(select(., one_of(nodist)), na.rm = TRUE),
               stress = rowSums(select(., one_of(stress)), na.rm = TRUE),
               regdist = rowSums(select(., one_of(regdist)), na.rm = TRUE),
               desdist = rowSums(select(., one_of(desdist)), na.rm = TRUE),
               modandist = rowSums(select(., one_of(modandist)), na.rm = TRUE),
               strandist = rowSums(select(., one_of(strandist)), na.rm = TRUE)) %>%
        filter(`plantation forest` < 0.5) %>% 
        filter_at(c('seeds.ExP', 'seeds.WALD'), all_vars(!is.na(.))) %>% 
        select(locality, wildlings, all_of(locality.preds), terr, wetl, nodist, 
               stress, regdist, desdist, modandist, strandist)
        )

str(datlist, 3)
```

# Loop through species

```{r}
results.hypothesis <- list()

for (i in seq_along(datlist)) { # i <- 1
  species <- names(datlist)[i]
  dat <- datlist[[i]]
  stopifnot(sum(complete.cases(dat)) == nrow(dat))

  dat <- mutate(dat, across(starts_with("seeds"), log))
  dat <- mutate(dat, across(starts_with("seeds"), ~ .x - mean(.x)))
  means <- dat[, c('age','bio01','bio19','relelev')] %>% map_dbl(mean)
  sds <- dat[, c('age','bio01','bio19','relelev')] %>% map_dbl(sd)
  for (j in c('age','bio01','bio19','relelev')) {
    dat <- modify_at(dat, .at = j, ~ (. - means[j]) / sds[j])
  }

  arith <- dat %>% 
    pivot_longer(c('terr', 'wetl'), 
                 names_to = "category", values_to = "cat.are") %>%
    pivot_longer(c('nodist', 'stress', 'regdist', 'desdist', 'modandist', 'strandist'), 
                 names_to = "structuring", values_to = "str.are") %>%
    mutate(are = (cat.are == str.are) * cat.are) %>% 
    filter(are > 0) %>% 
    group_by(category, structuring) %>% 
    summarize(daa = sum(are)/10, # units from are to decare
              n = sum(wildlings*are)) %>% 
    mutate(density = n/daa) %>%
    arrange(desc(density), desc(n), daa)
  scaler <- filter(arith, category == 'terr', structuring == 'nodist') %>% 
    pull(density)
  arith.scaled <- mutate(arith, fit = density/scaler) %>% 
    select(-density) %>% 
    mutate(modeled = FALSE)

  category <- filter(arith, n > 0) %>% pull(category) %>% unique()
  structuring <- filter(arith, n > 0) %>% pull(structuring) %>% unique()
  
  selmod <- results$models[[species]]
  covars <- intersect(c('age', 'bio01','bio19', 'relelev'),
                      attributes(attributes(selmod$frame)$terms)$term.labels)
  # dd <- data.frame(a = gl(2,6), b = gl(6,1,12))
  # model.matrix(~ a + b, dd)
  form <- as.formula(paste("wildlings ~ ", 
                           paste(covars, collapse= "+"), "+",
                           paste(category[!category == "terr"], collapse= "+"), "+",
                           paste(structuring[!structuring == "nodist"], collapse= "+"), "+",
                           "(1 | locality)"))
  eval(bquote(
    m <- glmmTMB(formula = form, data = dat, offset = .(selmod$call$offset), 
                 family = selmod$call$family, ziformula = selmod$call$ziformula)
  ))

  newdat <- expand_grid(category, structuring) %>%
    sjmisc::to_dummy() %>%
    setNames(c(category[order(category)], structuring[order(structuring)])) %>% 
    cbind(expand_grid(category, structuring)) %>% 
    mutate(locality = NA, seeds.WALD = 0, age = 0, bio01 = 0, bio19 = 0, relelev = 0)  
  link <- newdat %>%
    bind_cols(predict(m, newdat, se.fit = TRUE, type = "link")) %>%
    mutate(ci.l = fit - 1.96*se.fit, ci.u = fit + 1.96*se.fit) %>% 
    select(category, structuring, fit, ci.l, ci.u) %>% 
    mutate_at(c('fit', 'ci.l', 'ci.u'), ~ exp(.)) %>% 
    mutate(modeled = TRUE)
  scaler <- filter(link, category == "terr", structuring == "nodist") %>% 
    pull(fit)
  link.scaled <- mutate_at(link, c('fit', 'ci.l', 'ci.u'), 
                           ~ `/`(., scaler))

  results.hypothesis[[i]] <- list(arithmetic = arith.scaled, 
                                  model.preds = link.scaled)
}

names(results.hypothesis) <- names(datlist)
```

# Save results

```{r}
saveRDS(results.hypothesis, here("output","results-hypothesis.rds"))
```

# sessionInfo

```{r sessionInfo}
sessionInfo()
```

