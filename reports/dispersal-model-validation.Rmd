---
title: "Dispersal model validation"
output: html_document 
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(sf)
```

```{r wind Floro station}
windobs <- read_delim(here("data","raw","eKlima","obswind-stnr57710FLORO-20190604.txt"), 
                      delim = ";", na = "-9999", skip = 24) %>% 
  drop_na()
count(windobs, fDD)
count(windobs, fFF)
windobs <- filter(windobs, fDD == "OK" & fFF == "OK") %>% 
  select(-c("St.no", "fDD", "fFF"))

windobs %>% 
  group_by(Mnth) %>% 
  summarize(mean=mean(FF), sd=sd(FF))
```

```{r read seed sources}
sources <- read_csv(here("data","raw","seedtraps","seedsources.csv")) %>% 
  st_as_sf(coords = c(1:2), crs = 25832) # ETRS89 / UTM zone 32N
plot(sources["height"], key.pos = 4)
plot(sources["cones"], key.pos = 4)
hist(sources$cones)
```

```{r make grid geometry}
gridres <- 2
grd <- st_sf(st_make_grid(sources, cellsize = gridres))
pts <- st_sf(st_make_grid(sources, cellsize = gridres, what = "centers"))
bb <- st_bbox(grd)
nx <- unname(ceiling((bb$xmax - bb$xmin)/gridres))
ny <- unname(ceiling((bb$ymax - bb$ymin)/gridres))
paste(nx, "x", ny)
plot(grd[c(1,120:121),]) #features ordered SW to NE, by row
```

```{r add data to grid}
g <- st_join(grd, sources) # Note: grid cells with multiple seed sources are duplicated

vegheight <- raster::raster(here("data","raw","seedtraps","lidar","vegheight.tif"))
vegheight <- st_sf(vegheight = raster::extract(vegheight, pts), geometry = st_geometry(pts))
g <- st_join(g, vegheight)
p <- st_join(pts, g)
```

```{r seed density}
sector.breaks <- seq(0, 360, by=20)
i <- 50
seedsrc <- subset(p, !is.na(p$cones))[i,]
dX <- st_coordinates(seedsrc)[,1] - st_coordinates(p)[,1]
dY <- st_coordinates(seedsrc)[,2] - st_coordinates(p)[,2]
source(here("R","functions.R"))
landscape <- p %>% 
  mutate(angle = angle(dX, dY)) %>% # compass bearing FROM landscape TO source (matches wind directions)
  mutate(sector = cut(angle, sector.breaks, include.lowest = TRUE)) %>% 
  mutate(dist.to.seedsrc = as.numeric(st_distance(p, seedsrc)))

j <- 1
sect <- levels(landscape$sector)[j]
vegh <- landscape %>% 
  filter(sector == sect) %>% 
  pull(vegheight) %>% 
  mean()
dispersal.season <- c(9:12,1:2) # after Harris, A. S. 1990.
wind <- windobs %>% 
  filter(Mnth %in% dispersal.season) %>%
  mutate(sector = cut(DD, sector.breaks, include.lowest = TRUE)) %>%
  filter(sector == sect) %>%
  sample_n(100, weight = FF) %>% # assume probability of abscission is directly related to wind speed
  pull(FF)

k <- 1
source(here("R","SkarpaasShea_2007.R"))
mod <- function(x, H = seedsrc$height, 
                Fm = 0.94, # m/s, after Sandvik, H. 2012. 
                Um = wind[k], zm = 10, # measured 10 m above ground at station 
                h = vegh) {
  d <- calc_d(h)
  z0 <- calc_z0(h)
  ustar <- calc_ustar(Um, zm, d, z0)
  U <- calc_U(H, ustar, d, z0)
  sigma <- calc_sigma(z = H, d, ustar, U)
  nu <- calc_nu(H, U, Fm)
  lambda <- calc_lambda(H, sigma)
  statmod::dinvgauss(x, mean=nu, shape=lambda)
}
mod()

group_by(landscape, sector) %>% 
  summarize(mean(vegheight, na.rm = TRUE))

tab <- as_tibble(landscape) %>% 
  mutate(sector = as.character(sector)) %>% 
  filter(sector == sect)

m <- matrix(data = NA, nrow = nrow(tab), ncol = length(wind))


```


```{r sessionInfo}
sessionInfo()
```