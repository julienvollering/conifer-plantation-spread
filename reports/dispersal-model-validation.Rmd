---
title: "Dispersal model validation"
output: html_document 
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(sf)
```

```{r wind Floro station}
windobs <- read_delim(here("data","raw","eKlima","obswind-stnr57710FLORO-20190604.txt"), 
                      delim = ";", na = "-9999", skip = 24) %>% 
  drop_na()
count(windobs, fDD)
count(windobs, fFF)
windobs <- filter(windobs, fDD == "OK" & fFF == "OK") %>% 
  select(-c("St.no", "fDD", "fFF"))

windobs %>% 
  group_by(Mnth) %>% 
  summarize(mean=mean(FF), sd=sd(FF))
```

```{r read seed sources}
sources <- read_csv(here("data","raw","seedtraps","seedsources.csv")) %>% 
  st_as_sf(coords = c(1:2), crs = 25832) # ETRS89 / UTM zone 32N
plot(sources["height"], key.pos = 4)
plot(sources["cones"], key.pos = 4)
hist(sources$cones)
```

```{r make grid geometry}
gridres <- 2
grd <- st_sf(st_make_grid(sources, cellsize = gridres))
pts <- st_sf(st_make_grid(sources, cellsize = gridres, what = "centers"))
bb <- st_bbox(grd)
nx <- unname(ceiling((bb$xmax - bb$xmin)/gridres))
ny <- unname(ceiling((bb$ymax - bb$ymin)/gridres))
paste(nx, "x", ny)
plot(grd[c(1,120:121),]) #features ordered SW to NE, by row
```

```{r add data to grid}
g <- st_join(grd, sources)

vegheight <- raster::raster(here("data","raw","seedtraps","lidar","vegheight.tif"))
vegheight <- st_sf(vegheight = raster::extract(vegheight, pts), geometry = st_geometry(pts))
g <- st_join(g, vegheight)
p <- st_join(pts, g)
```

```{r wind sectors}
sector.breaks <- seq(0,360,by=20)
i <- 50
src <- subset(p, !is.na(p$cones))[i,]
dX <- st_coordinates(src)[,1] - st_coordinates(p)[,1]
dY <- st_coordinates(src)[,2] - st_coordinates(p)[,2]
source(here("R","functions.R"))
landscape <- p %>% 
  mutate(angle = angle(dX, dY)) %>% # compass bearing FROM landscape TO source (matches wind directions)
  mutate(sector = cut(angle, sector.breaks, include.lowest = TRUE))

j <- levels(landscape$sector)[1]
sector <- filter(landscape, sector == j)
set.seed(42)
wind <- windobs %>% 
  mutate(sector = cut(DD, sector.breaks, include.lowest = TRUE)) %>%
  filter(sector == j) %>%
  sample_n(100, weight = FF) %>% 
  pull(FF)
```


```{r sessionInfo}
sessionInfo()
```