---
title: "Climate data"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(sf)
```

# Windstations

```{r, windstation coords}
windstations <- read_delim(here("data", "raw", "eKlima", "NOwindstationsEklima.txt"), 
                     delim = ";", na=c("-9999"), col_types = cols())
windstations <- filter(windstations, !grepl("\\*", Name))
files <- list.files(here("data", "raw", "eKlima"), 
                    pattern = "metastations", full.names = TRUE)
stationsmeta <- lapply(files, read_delim, delim = ";", col_types = cols()) %>%
  lapply(select, Stnr:Name, Utm_e:Utm_zone) %>% 
  bind_rows() %>% 
  distinct(Stnr, .keep_all = TRUE)
  
windstations <- left_join(windstations, stationsmeta, by = "Stnr") %>% 
  drop_na()
```

Stations for which wind data on eKlima were not available or poor quality:

```{r remove stations without data}
windstations <- windstations %>% 
  filter(Stnr != 47498) %>%  # Etne II
  filter(Stnr != 49490) %>%  # Ullensvang
  filter(Stnr != 44640) # Stavanger VÃ¥land
```

```{r windstation map, warning=FALSE}
library(rnaturalearth)
nor <- rnaturalearth::ne_countries(scale = "large", country = "Norway", 
                                   returnclass = "sf") %>% 
  st_crop(xmin = 4, xmax = 32, ymin = 58, ymax = 72) %>% 
  st_transform(crs = 25833) # ETRS89 / UTM zone 33N

windstations <- st_as_sf(windstations, crs = 25833, coords = c("Utm_e","Utm_n"))

ggplot() +
  geom_sf(data = nor) + 
  geom_sf(data = windstations, colour = "red")
```

```{r POI with windstations}
plantations <- read_csv(here("data", "localities.csv"), col_types = cols()) %>% 
  select("locality", "county", "utm33.easting", "utm33.northing") %>% 
  st_as_sf(coords=c("utm33.easting", "utm33.northing"))

broervika <- tibble(locality = "Broervika", 
                   county = "Sogn og Fjordane", 
                   geometry = st_sfc(st_point(c(-34167, 6839532)))) %>% 
  st_as_sf()

poi <- rbind(broervika, plantations) %>% 
  st_set_crs(25833) # ETRS89 / UTM zone 33N

nearest <- st_nearest_feature(poi, windstations)
poi$windst.nr <- windstations$Stnr[nearest]
poi$windst.name <- windstations$Name.x[nearest]
poi$windst.dist <- st_distance(poi, windstations[nearest, ], by_element = TRUE) %>% 
  as.numeric
poi$windst.dist <- round(poi$windst.dist/1000)
```

```{r, results='asis'}
as_tibble(poi) %>% 
  arrange(windst.dist) %>% 
  distinct(locality, .keep_all = TRUE) %>% 
  knitr::kable()
```

```{r windstation distances}
ggplot(poi, aes(windst.dist))  +
  geom_histogram(aes(fill=county), binwidth = 2) + 
  labs(title="Distance to nearest windstation by county",
       x="distance to nearest windstation (km)")

ggplot() +
  geom_sf(data = nor) + 
  geom_sf(data = poi, color = "black") +
  geom_sf(data = windstations[nearest, ], color="red") + 
  labs(title="POIs and nearest wind stations", 
       subtitle="POIs = black, windstations = red")
```

# NORA10

## Request 1

Coordinates sent to MET:

```{r}
poi <- read_csv(here("data","raw","NORA10","poi-lonlat.csv"))

poi.sp <- poi %>% 
  st_as_sf(coords = c("X", "Y"), crs = 4326)
ggplot() + geom_sf(data = poi.sp)
sum(poi$Y > 65)
which(poi$Y > 65)
```

Includes 11 sites outside the extent of the data coverage. 

Data from MET:

```{r}
DD <- read_delim(here("data","raw","NORA10","nora10bc.WindDir.txt"), delim = ";")
DD$SITE %>% unique
drop_na(DD)$SITE %>% unique()

FF <- read_delim(here("data","raw","NORA10","nora10bc.WindSpeed.txt"), delim = ";")
FF$SITE %>% unique
drop_na(FF)$SITE %>% unique()
```

11 sites with NA data are relegated to the end of the text file (sites 33-44). Remove these from the list of coordinates before joining.

```{r}
poi <- filter(poi, Y < 65)
DD <- drop_na(DD)
FF <- drop_na(FF)
```

```{r}
NORAwind <- inner_join(DD, FF, by = c("SITE", "TIME")) %>% 
  rename(DD = WD, FF = WS) %>% 
  mutate(TIME = as.character(TIME)) %>% 
  mutate(Mnth = as.numeric(substring(TIME, 5, 6)))
```

## Request 2

```{r}
DD2 <- read_delim(here("data","raw","NORA10","nora10bc.WindDir2.txt"), delim = ";")
FF2 <- read_delim(here("data","raw","NORA10","nora10bc.WindSpeed2.txt"), delim = ";")
NORAwind2 <- inner_join(DD2, FF2, by = c("SITE", "TIME")) %>% 
  rename(DD = WD, FF = WS) %>% 
  mutate(TIME = as.character(TIME)) %>% 
  mutate(Mnth = as.numeric(substring(TIME, 5, 6))) 
```

```{r check2, include=FALSE}
poi2.sp <- poi2 %>% 
  st_as_sf(coords = c("X", "Y"), crs = 4326)
which(st_distance(poi2.sp) < units::set_units(2e3, 'm'), arr.ind = TRUE) %>% 
  as_tibble() %>% 
  filter(row != col)

st_distance(poi2.sp[7,], poi2.sp[14,])
filter(NORAwind2, SITE == 7)
filter(NORAwind2, SITE == 14)
openair::windRose(filter(NORAwind2, SITE == 7), ws = 'FF', wd = 'DD')
openair::windRose(filter(NORAwind2, SITE == 14), ws = 'FF', wd = 'DD')
```

```{r}

bind_rows(NORAwind, NORAwind2) %>% tail
write_csv(NORAwind, here("data","raw","NORA10","NORAwind.csv"))

st_as_sf(poi, coords = c("X", "Y"), crs = 4326) %>% 
  st_transform(25833) %>% 
  mutate(SITE = 1:nrow(poi)) %>% 
  filter(SITE %in% NORAwind$SITE) %>%  
  st_write(here("data","raw","NORA10","NORAsites.shp"), delete_dsn=TRUE)
```

```{r}
NORAwind %>%
  mutate(SITE = as_factor(SITE), Mnth = as.numeric(Mnth)) %>% 
  group_by(SITE, Mnth) %>% 
  summarize(mean=mean(FF), sd=sd(FF)) %>% 
  ggplot(aes(Mnth, mean, color = SITE)) + geom_line()
```

THREDDS attempt:

```{r}
library(raster)
?brick
temp <- brick("https://thredds.met.no/thredds/dodsC/nora10ei/wam10ei_20171221.nc", 
              varname = 'wind_speed')
temp
plot(subset(temp,1))

temp <- brick("https://thredds.met.no/thredds/dodsC/wisline/NoraBC25/windspeed_10m/windspeed_10m_201412.nc", 
              varname = 'windspeed_10m')
temp
plot(subset(temp,3))
```

# eKlima wind

Frequency data for two stations where observations are unavailable from eKlima are transformed into observation data with identical format as the downloaded observation data.

```{r, eval=FALSE, include=FALSE}
files <- list.files(here("data","raw","eKlima","obswindfreq"), full.names = TRUE)
N <- 1e3
for (i in seq_along(files)) {
  freq <- read_delim(files[i], delim = ";", na = "-9999", skip = 18)
  freq <- t(freq)
  colnames(freq) <- freq[1,]
  freq <- freq[-(1:2),]
  long <- as_tibble(cbind(DD = rownames(freq), freq)) %>% 
    mutate_all(as.numeric) %>% 
    select(1:7) %>% 
    gather(key = minspeed, value = frequency, -1) %>% 
    drop_na()
  sum(long$frequency)
  
  DD <- vector("list", length = nrow(long))
  FF <- vector("list", length = nrow(long))
  set.seed(42)
  for (j in 1:nrow(long)) {
    dir <- long$DD[j]
    spe <- long$minspeed[j]
    dec <- long$frequency[j]/100
    DD[[j]] <- rep(dir, dec * N)
    FF[[j]] <- if (spe == "0.1") {
      runif(dec * N, min = 0, max = 6.2) %>% round(1)
    } else if (spe == "6.4") {
      runif(dec * N, min = 6.4, max = 12.5) %>% round(1)
    } else if (spe == "12.6") {
      runif(dec * N, min = 12.6, max = 18.8) %>% round(1)
    } else if (spe == "18.8") {
      runif(dec * N, min = 18.8, max = 25) %>% round(1)
    } else {
      runif(dec * N, min = 25, max = 30) %>% round(1)
    }
  }
  outpath <- sub("obswindfreq", "obswind", files[i])
  writeLines(rep("\n", 23) %>% paste(collapse = " "), con = outpath)
  tibble(St.no = as.numeric(substr(basename(files[i]), 5, 9)), 
         Year = NA_real_, Mnth = 12, Date = NA_real_, `Time(NMT)` = NA_real_, 
         DD = flatten_dbl(DD), fDD = "OK", FF = flatten_dbl(FF), fFF = "OK") %>% 
    write_delim(path = outpath, delim = ";", na = "-9999", append = TRUE, 
                col_names = TRUE)
}
```

Observation data from eKlima:

```{r}
EKLIMAwind <- list.files(here("data","raw","eKlima","obswind"), full.names = TRUE) %>% 
  lapply(read_delim, delim = ";", na = "-9999", skip = 24)
EKLIMAwind <- lapply(EKLIMAwind, function(y) filter(y, fFF == "OK" & fDD == "OK")) %>% 
  lapply(FUN = function(y) mutate(y, FF = as.numeric(FF), DD = as.numeric(DD))) %>% 
  bind_rows()
write_csv(EKLIMAwind, here("data","raw","eKlima","EKLIMAwind.csv"))

windstations %>%
  filter(Stnr %in% EKLIMAwind$St.no) %>% 
  select(Stnr) %>% 
  st_write(here("data","raw","eKlima","EKLIMAsites.shp"), delete_dsn=TRUE)
```

```{r}
EKLIMAwind %>% 
  mutate(St.no = as_factor(St.no)) %>% 
  group_by(St.no, Mnth) %>% 
  summarize(mean=mean(FF), sd=sd(FF)) %>% 
  ggplot(aes(Mnth, mean, color = St.no)) + geom_line()
```

# Vegetation sections and zones

```{r}
sect <- raster::raster(here("data","raw","Bakkestuen","seksjoner.tif"))
zone <- raster::raster(here("data","raw","Bakkestuen","soner.tif"))
df <- raster::rasterToPoints(raster::stack(sect, zone), spatial = TRUE) 
chelsa <- list.files(here("data","raw","CHELSA"), pattern = ".tif", 
                     full.names = TRUE) %>% 
  raster::stack()
bb <- sp::spTransform(df, raster::crs(chelsa)) %>% sp::bbox()
chelsa <- raster::crop(chelsa, bb)
df <- raster::extract(chelsa, df, sp = TRUE)
df <- as_tibble(df) %>% select(-x, -y)
correl <- cor(df, use = "complete")[-(1:2),1:2]
correl[order(correl[,1]), 1, drop=FALSE]
correl[order(correl[,2]), 2, drop=FALSE]
```

Bio19 (precip coldest qtr) correlates best with sections, and Bio1 (annual mean temp) correlates best with zones.

```{r sessionInfo}
sessionInfo()
```