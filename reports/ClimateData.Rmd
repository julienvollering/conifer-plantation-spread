---
title: "Climate data"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(sf)
```

# Windstations

```{r, windstation coords}
windstations <- read_delim(here("data", "raw", "eKlima", "NOwindstationsEklima.txt"), 
                     delim = ";", na=c("-9999"), col_types = cols())
windstations <- filter(windstations, !grepl("\\*", Name))
files <- list.files(here("data", "raw", "eKlima"), 
                    pattern = "metastations", full.names = TRUE)
stationsmeta <- lapply(files, read_delim, delim = ";", col_types = cols()) %>%
  lapply(select, Stnr:Name, Utm_e:Utm_zone) %>% 
  bind_rows() %>% 
  distinct(Stnr, .keep_all = TRUE)
  
windstations <- left_join(windstations, stationsmeta, by = "Stnr") %>% 
  drop_na()
```

Stations for which wind data on eKlima were not available or poor quality:

```{r remove stations without data}
windstations <- windstations %>% 
  filter(Stnr != 47498) %>%  # Etne II
  filter(Stnr != 49490) %>%  # Ullensvang
  filter(Stnr != 44640) # Stavanger VÃ¥land
```

```{r windstation map, warning=FALSE}
library(rnaturalearth)
nor <- rnaturalearth::ne_countries(scale = "large", country = "Norway", 
                                   returnclass = "sf") %>% 
  st_crop(xmin = 4, xmax = 32, ymin = 58, ymax = 72) %>% 
  st_transform(crs = 25833) # ETRS89 / UTM zone 33N

windstations <- st_as_sf(windstations, crs = 25833, coords = c("Utm_e","Utm_n"))

ggplot() +
  geom_sf(data = nor) + 
  geom_sf(data = windstations, colour = "red")
```

```{r POI with windstations}
poi <- read_csv(here("data", "localities.csv")) %>% 
  select("locality", "county", "utm33.easting", "utm33.northing") %>% 
  st_as_sf(coords=c("utm33.easting", "utm33.northing")) %>% 
  st_set_crs(25833)

nearest <- st_nearest_feature(poi, windstations)
poi$windst.nr <- windstations$Stnr[nearest]
poi$windst.name <- windstations$Name.x[nearest]
poi$windst.dist <- st_distance(poi, windstations[nearest, ], by_element = TRUE) %>% 
  as.numeric
poi$windst.dist <- round(poi$windst.dist/1000)
```

```{r, results='asis'}
as_tibble(poi) %>% 
  arrange(windst.dist) %>% 
  distinct(locality, .keep_all = TRUE) %>% 
  knitr::kable()
```

```{r windstation distances}
ggplot(poi, aes(windst.dist))  +
  geom_histogram(aes(fill=county), binwidth = 2) + 
  labs(title="Distance to nearest windstation by county",
       x="distance to nearest windstation (km)")

ggplot() +
  geom_sf(data = nor) + 
  geom_sf(data = poi, color = "black") +
  geom_sf(data = windstations[nearest, ], color="red") + 
  labs(title="POIs and nearest wind stations", 
       subtitle="POIs = black, windstations = red")
```

# NORA10BC

Data request nr 2 from MET (for sites in Sandven et al. 2019):

```{r}
poi2 <- read_csv(here("data","raw","NORA10","poi2-lonlat.csv"))
DD2 <- read_delim(here("data","raw","NORA10","nora10bc.WindDir.poi2.txt"), 
                  delim = ";")
FF2 <- read_delim(here("data","raw","NORA10","nora10bc.WindSpeed.poi2.txt"), 
                  delim = ";")
```

```{r eye test 2, eval=FALSE, include=FALSE}
poi2.sp <- poi2 %>% 
  st_as_sf(coords = c("X", "Y"), crs = 4326)
which(st_distance(poi2.sp) < units::set_units(2e3, 'm'), arr.ind = TRUE) %>% 
  as_tibble() %>% 
  filter(row != col)
NORAwind2 <- inner_join(DD2, FF2, by = c("SITE", "TIME"))

st_distance(poi2.sp[7,], poi2.sp[14,])
openair::windRose(filter(NORAwind2, SITE == 7), ws = 'WS', wd = 'WD')
openair::windRose(filter(NORAwind2, SITE == 14), ws = 'WS', wd = 'WD')
```

Data request nr 3 from MET (for sites in southern Norway excluding Sandven et al. 2019):

```{r}
poi3 <- read_csv(here("data","raw","NORA10","poi3-lonlat.csv"))
DD3 <- read_delim(here("data","raw","NORA10","nora10bc.WindDir.poi3.txt"), 
                  delim = ";")
FF3 <- read_delim(here("data","raw","NORA10","nora10bc.WindSpeed.poi3.txt"), 
                  delim = ";")
```

```{r eye test 3, eval=FALSE, include=FALSE}
poi3.sp <- poi3 %>% 
  st_as_sf(coords = c("X", "Y"), crs = 4326)
which(st_distance(poi3.sp) < units::set_units(1e3, 'm'), arr.ind = TRUE) %>% 
  as_tibble() %>% 
  filter(row != col)
NORAwind3 <- inner_join(DD3, FF3, by = c("SITE", "TIME"))

st_distance(poi3.sp[8,], poi3.sp[9,])
openair::windRose(filter(NORAwind3, SITE == 8), ws = 'WS', wd = 'WD')
openair::windRose(filter(NORAwind3, SITE == 9), ws = 'WS', wd = 'WD')
st_distance(poi3.sp[23,], poi3.sp[27,])
openair::windRose(filter(NORAwind3, SITE == 23), ws = 'WS', wd = 'WD')
openair::windRose(filter(NORAwind3, SITE == 27), ws = 'WS', wd = 'WD')
```

Row-bind data requests and write formatted:

```{r}
poi3 <- mutate(poi3, site = site + nrow(poi2))
DD3 <- mutate(DD3, SITE = SITE + nrow(poi2))
FF3 <- mutate(FF3, SITE = SITE + nrow(poi2))

bind_rows(poi2, poi3) %>% 
  st_as_sf(coords = c('X','Y'), crs = 4326) %>%
  st_transform(crs = 25833) %>% 
  st_write(here("data","raw","NORA10","NORA10BCsites.shp"), delete_dsn=TRUE)

DD <- bind_rows(DD2, DD3)
FF <- bind_rows(FF2, FF3)
NORA10BC <- inner_join(DD, FF, by = c("SITE", "TIME")) %>% 
  rename(DD = WD, FF = WS) %>% 
  mutate(TIME = as.character(TIME)) %>% 
  mutate(Mnth = as.numeric(substring(TIME,5,6))) %>% 
  select(-TIME)
write_csv(NORA10BC, here("data","raw","NORA10","NORA10BCwind.csv"))
```

```{r}
NORA10BC %>%
  mutate(SITE = as_factor(SITE), Mnth = as.numeric(Mnth)) %>% 
  group_by(SITE, Mnth) %>% 
  summarize(mean=mean(FF), sd=sd(FF)) %>% 
  ggplot(aes(Mnth, mean, color = SITE)) + geom_line()
```

# NORA10

Note: NORA10BC (BC = bias corrected) is not available for northern Norway, but its parent data --- NORA10 --- is.

Data request nr 3 from MET (for sites in northern Norway):

```{r}
poi4 <- read_csv(here("data","raw","NORA10","poi4-lonlat.csv"))
DD4 <- read_delim(here("data","raw","NORA10","nora10.WindDir.poi4.txt"), 
                  delim = ";")
FF4 <- read_delim(here("data","raw","NORA10","nora10.WindSpeed.poi4.txt"), 
                  delim = ";")
```

```{r eye test 4, eval=FALSE, include=FALSE}
poi4.sp <- poi4 %>% 
  st_as_sf(coords = c("X", "Y"), crs = 4326)
which(st_distance(poi4.sp) < units::set_units(1e3, 'm'), arr.ind = TRUE) %>% 
  as_tibble() %>% 
  filter(row != col)
NORAwind4 <- inner_join(DD4, FF4, by = c("SITE", "TIME"))

st_distance(poi4.sp[6,], poi4.sp[7,])
openair::windRose(filter(NORAwind4, SITE == 6), ws = 'WS', wd = 'WD')
openair::windRose(filter(NORAwind4, SITE == 7), ws = 'WS', wd = 'WD')
```

Write formatted:

```{r}
poi4 <- mutate(poi4, site = site + nrow(poi2) + nrow(poi3))
DD4 <- mutate(DD4, SITE = SITE + nrow(poi2) + nrow(poi3))
FF4 <- mutate(FF4, SITE = SITE + nrow(poi2) + nrow(poi3))

poi4 %>% 
  st_as_sf(coords = c('X','Y'), crs = 4326) %>%
  st_transform(crs = 25833) %>% 
  st_write(here("data","raw","NORA10","NORA10sites.shp"), delete_dsn=TRUE)

NORA10 <- inner_join(DD4, FF4, by = c("SITE", "TIME")) %>% 
  rename(DD = WD, FF = WS) %>% 
  mutate(TIME = as.character(TIME)) %>% 
  mutate(Mnth = as.numeric(substring(TIME,5,6))) %>% 
  select(-TIME)
write_csv(NORA10, here("data","raw","NORA10","NORA10wind.csv"))
```

```{r}
NORA10 %>%
  mutate(SITE = as_factor(SITE), Mnth = as.numeric(Mnth)) %>% 
  group_by(SITE, Mnth) %>% 
  summarize(mean=mean(FF), sd=sd(FF)) %>% 
  ggplot(aes(Mnth, mean, color = SITE)) + geom_line()
```

# eKlima wind

Frequency data for two stations where observations are unavailable from eKlima are transformed into observation data with identical format as the downloaded observation data.

```{r, eval=FALSE, include=FALSE}
files <- list.files(here("data","raw","eKlima","obswindfreq"), full.names = TRUE)
N <- 1e3
for (i in seq_along(files)) {
  freq <- read_delim(files[i], delim = ";", na = "-9999", skip = 18)
  freq <- t(freq)
  colnames(freq) <- freq[1,]
  freq <- freq[-(1:2),]
  long <- as_tibble(cbind(DD = rownames(freq), freq)) %>% 
    mutate_all(as.numeric) %>% 
    select(1:7) %>% 
    gather(key = minspeed, value = frequency, -1) %>% 
    drop_na()
  sum(long$frequency)
  
  DD <- vector("list", length = nrow(long))
  FF <- vector("list", length = nrow(long))
  set.seed(42)
  for (j in 1:nrow(long)) {
    dir <- long$DD[j]
    spe <- long$minspeed[j]
    dec <- long$frequency[j]/100
    DD[[j]] <- rep(dir, dec * N)
    FF[[j]] <- if (spe == "0.1") {
      runif(dec * N, min = 0, max = 6.2) %>% round(1)
    } else if (spe == "6.4") {
      runif(dec * N, min = 6.4, max = 12.5) %>% round(1)
    } else if (spe == "12.6") {
      runif(dec * N, min = 12.6, max = 18.8) %>% round(1)
    } else if (spe == "18.8") {
      runif(dec * N, min = 18.8, max = 25) %>% round(1)
    } else {
      runif(dec * N, min = 25, max = 30) %>% round(1)
    }
  }
  outpath <- sub("obswindfreq", "obswind", files[i])
  writeLines(rep("\n", 23) %>% paste(collapse = " "), con = outpath)
  tibble(St.no = as.numeric(substr(basename(files[i]), 5, 9)), 
         Year = NA_real_, Mnth = 12, Date = NA_real_, `Time(NMT)` = NA_real_, 
         DD = flatten_dbl(DD), fDD = "OK", FF = flatten_dbl(FF), fFF = "OK") %>% 
    write_delim(path = outpath, delim = ";", na = "-9999", append = TRUE, 
                col_names = TRUE)
}
```

Observation data from eKlima:

```{r}
EKLIMAwind <- list.files(here("data","raw","eKlima","obswind"), full.names = TRUE) %>% 
  lapply(read_delim, delim = ";", na = "-9999", skip = 24)
EKLIMAwind <- lapply(EKLIMAwind, function(y) filter(y, fFF == "OK" & fDD == "OK")) %>% 
  lapply(FUN = function(y) mutate(y, FF = as.numeric(FF), DD = as.numeric(DD))) %>% 
  bind_rows() %>% 
  select(St.no, Mnth, DD, FF)
write_csv(EKLIMAwind, here("data","raw","eKlima","EKLIMAwind.csv"))

windstations %>%
  filter(Stnr %in% EKLIMAwind$St.no) %>% 
  select(Stnr) %>% 
  st_write(here("data","raw","eKlima","EKLIMAsites.shp"), delete_dsn=TRUE)
```

```{r}
EKLIMAwind %>% 
  mutate(St.no = as_factor(St.no)) %>% 
  group_by(St.no, Mnth) %>% 
  summarize(mean=mean(FF), sd=sd(FF)) %>% 
  ggplot(aes(Mnth, mean, color = St.no)) + geom_line()
```

# Vegetation sections and zones

```{r}
sect <- raster::raster(here("data","raw","Bakkestuen","seksjoner.tif"))
zone <- raster::raster(here("data","raw","Bakkestuen","soner.tif"))
df <- raster::rasterToPoints(raster::stack(sect, zone), spatial = TRUE) 
chelsa <- list.files(here("data","raw","CHELSA"), pattern = ".tif", 
                     full.names = TRUE) %>% 
  raster::stack()
bb <- sp::spTransform(df, raster::crs(chelsa)) %>% sp::bbox()
chelsa <- raster::crop(chelsa, bb)
df <- raster::extract(chelsa, df, sp = TRUE)
df <- as_tibble(df) %>% select(-x, -y)
correl <- cor(df, use = "complete")[-(1:2),1:2]
correl[order(correl[,1]), 1, drop=FALSE]
correl[order(correl[,2]), 2, drop=FALSE]
```

Bio19 (precip coldest qtr) correlates best with sections, and Bio1 (annual mean temp) correlates best with zones.

```{r sessionInfo}
sessionInfo()
```