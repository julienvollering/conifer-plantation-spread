---
title: "Modeling relative establishment probability"
output: 
  html_document:
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, error=TRUE)
```

```{r}
library(here)
library(tidyverse)
source(here("R","functions.R"))
library(glmmTMB)
library(DHARMa)
library(furrr)
```

# Load data

```{r}
types <- read_csv(here('data','types.csv'))
contrasttype <- "T4"
contrasthgtclass <- 2
nottypes <- c('species', 'locality','wildlings','age','bio01','bio19',
              'seeds.ExP','seeds.WALD','relelev','geometry','are')
```


```{r}
IV <- readRDS(here("output","independentVars.rds")) %>% 
  st_as_sf()
IV <- IV %>% 
  filter(`plantation forest` < 0.5) %>% 
  select(-`plantation forest`) %>% 
  rowwise() %>% 
  mutate(are = sum(c_across(any_of(types$type)))) %>% 
  filter(are >= 0.5) %>% 
  ungroup()
filter(IV, are > 1.01)
filter(IV, T4 > 0.5) %>%
  select(species, are, any_of(types$type)) %>% 
  group_split(species)
IV <- select(IV, -are)

DV <- readRDS(here("output","dependentVar.rds"))
nrseeds <- length(unique(DV$randomseed))
nrhgtclasses <- length(unique(DV$hgtclass))

DV %>% 
  filter(randomseed == 1) %>% 
  group_split(species) %>% 
  map2(group_split(IV, species), ~ add_wildlings(.y,.x)) %>% 
  bind_rows() %>% 
  st_drop_geometry() %>% 
  group_by(species) %>% 
  summarize(per.are = mean(wildlings)) %>% 
  mutate(per.hectare = per.are * 100) # overall wildlings per hectare
```

```{r}
IV <- IV %>% 
  group_split(species) %>% 
  map(~ mutate(., 
               across(c(age,bio01,bio19,relelev), ~ as.vector(scale(.))),
               across(c(seeds.ExP,seeds.WALD), ~ as.vector(scale(log(.), scale = FALSE))))) %>% 
  bind_rows()
```

# P.sitchensis-lutzii

```{r}
IVi <- filter(IV, species == "P.sitchensis-lutzii") %>% 
  remove_zero_cols()
summary(IVi)
typenames <- names(IVi)[!names(IVi) %in% nottypes]

DVi <- filter(DV, species == "P.sitchensis-lutzii")
```

## Wildling densities

Disregards height classes.

```{r}
dat <- add_wildlings(IVi, filter(DVi, randomseed == 1)) %>% 
  st_drop_geometry()

Ps_arith <- pivot_longer(dat, one_of(typenames), names_to = "nin", values_to = "are") %>%
  group_by(nin) %>% 
  summarize(daa = sum(are)/10, # units from are to decare
            n = sum(wildlings*are), .groups = "drop_last") %>% 
  mutate(density = n/daa) %>%
  arrange(desc(density), desc(n), daa)
scaler <- filter(Ps_arith, nin == contrasttype) %>% 
  pull(density)
Ps_arith <- mutate(Ps_arith, fit = density/scaler)
```

```{r, echo=FALSE, results='asis'}
knitr::kable(Ps_arith, digits = 1)
```

## Height-blind model

Disregards height classes.

Comparing:

1. distribution family (poisson vs. negative binomial vs. generalized poisson)
2. dispersal predictor (seeds.WALD vs. seeds.ExP vs null)

```{r}
modeltypes <- typenames[!(typenames %in% c(contrasttype, identify_completeseparation(dat, typenames)))]
modellocalities <- c(NA, unique(pull(dat, locality)))
newdat <- rbind(0, diag(length(modeltypes))) %>% 
  as_tibble(.name_repair = "minimal") %>% 
  set_names(modeltypes) %>% 
  mutate(nin = c(contrasttype, modeltypes), .before = 1) %>% 
  slice(rep(1:n(), each = length(modellocalities))) %>% 
  mutate(locality = rep(modellocalities, length(c(contrasttype, modeltypes))),
         age = 0, bio01 = 0, bio19 = 0, seeds.ExP = 0, seeds.WALD = 0, relelev = 0,
         .before = 1)
```

### distribution family

```{r}
mf <- paste_modelformula(dat, typenames, contrasttype)
m.poissonWALD <- glmmTMB(mf, dat, offset = seeds.WALD, family = "poisson", 
                         ziformula = ~ age + (1 | locality))
summary(m.poissonWALD)
simulationOutput <- simulateResiduals(fittedModel = m.poissonWALD)
testDispersion(simulationOutput)

m.nbinom2WALD <- glmmTMB(mf, dat, offset = seeds.WALD, family = "nbinom2",
                         ziformula = ~ age + (1 | locality))
summary(m.nbinom2WALD) 
simulationOutput <- simulateResiduals(fittedModel = m.nbinom2WALD)
testDispersion(simulationOutput) 

m.genpoisWALD <- glmmTMB(mf, dat, offset = seeds.WALD, family = "genpois",
                         ziformula = ~ age + (1 | locality))
summary(m.genpoisWALD) 
simulationOutput <- simulateResiduals(fittedModel = m.genpoisWALD)
testDispersion(simulationOutput)
```

### dispersal predictor

```{r}
m.genpoisExP <- glmmTMB(mf, dat, offset = seeds.ExP, family = "genpois",
                        ziformula = ~ age + (1 | locality))
summary(m.genpoisExP)

m.genpoisNULL <- glmmTMB(mf, dat, offset = NULL, family = "genpois",
                         ziformula = ~ age + (1 | locality))
summary(m.genpoisNULL)
```

```{r, include=FALSE}
Ps_modelcomp <- bbmle::ICtab(m.genpoisWALD, m.genpoisNULL, base = TRUE, 
                             delta = TRUE, sort = FALSE) %>% 
  as_tibble() %>% 
  add_column(`seed dispersal estimate` = c('WALD', 'none'), .before = 1) %>% 
  add_row(`seed dispersal estimate` = 'ExP', AIC = NA, dAIC = NA, df = NA, .before = 2) 
```

### Residual diagnostics + predictions

```{r}
simulationOutput <- simulateResiduals(fittedModel = m.genpoisWALD)
plot(simulationOutput)
testZeroInflation(simulationOutput)
```

```{r}
Ps_link <- newdat %>% 
  bind_cols(predict(m.genpoisWALD, newdat, se.fit = TRUE, type = "link")) %>% 
  select(locality, fit, se.fit, nin)
```

```{r, include=FALSE}
sensmod <- update(m.genpoisWALD, 
                  update.formula(formula(m.genpoisWALD), ~ . + seeds.WALD), 
                  offset = NULL)
newdat <- filter(newdat, is.na(locality))
Ps_cond_sens <- newdat %>% 
  mutate(fit = predict(sensmod, newdat, se.fit = FALSE, type = "conditional")) %>% 
  select(nin, fit)
```

## Height-stratified models

```{r}
dat <- DVi %>% 
  group_split(randomseed, hgtclass) %>% 
  map(~ add_wildlings(IVi, .) %>% 
        st_drop_geometry())
newdat <- filter(newdat, is.na(locality))
  
safe_predict <- safely(predict_from_genpoisWALDmodel)
plan(multisession, workers = availableCores()-1)
res <- dat %>% # 3.6 hours for 10 successfully fitted models on 7 workers
  future_map(~ safe_predict(., newdat, typenames, contrasttype))
transpose(res)$error
saveRDS(res, here('output', 'res-Ps-byheight.rds'))

modres <- transpose(res)$result
for (i in seq_along(modres)) {
  if(!is.null(modres[[i]])) {
    modres[[i]] <- modres[[i]] %>% 
      mutate(randomseed = rep(seq_len(nrseeds), each = nrhgtclasses)[i],
             hgtclass = rep(seq_len(nrhgtclasses), nrseeds)[i], .before = 1)
  }
}
modres <- modres %>% 
  bind_rows() %>% 
  select(randomseed, hgtclass, fit, se.fit, nin)
```

```{r}
Ps_link <- Ps_link %>% 
  bind_rows(modres)

rm(m.poissonWALD, m.nbinom2WALD, m.genpoisWALD, m.genpoisExP, m.genpoisNULL)
```

# P.abies

```{r}
IVi <- filter(IV, species == "P.abies") %>% 
  remove_zero_cols()
summary(IVi)
typenames <- names(IVi)[!names(IVi) %in% nottypes]

DVi <- filter(DV, species == "P.abies")
```

## Wildling densities

Disregards height classes.

```{r}
dat <- add_wildlings(IVi, filter(DVi, randomseed == 1)) %>% 
  st_drop_geometry()

Pa_arith <- pivot_longer(dat, one_of(typenames), names_to = "nin", values_to = "are") %>%
  group_by(nin) %>% 
  summarize(daa = sum(are)/10, # units from are to decare
            n = sum(wildlings*are), .groups = "drop_last") %>% 
  mutate(density = n/daa) %>%
  arrange(desc(density), desc(n), daa)
scaler <- filter(Pa_arith, nin == contrasttype) %>% 
  pull(density)
Pa_arith <- mutate(Pa_arith, fit = density/scaler)
```

```{r, echo=FALSE, results='asis'}
knitr::kable(Pa_arith, digits = 1)
```

## Height-blind model

Disregards height classes.

Comparing:

1. distribution family (poisson vs. negative binomial vs. generalized poisson)
2. dispersal predictor (seeds.WALD vs. seeds.ExP vs null)

```{r}
modeltypes <- typenames[!(typenames %in% c(contrasttype, identify_completeseparation(dat, typenames)))]
modellocalities <- c(NA, unique(pull(dat, locality)))
newdat <- rbind(0, diag(length(modeltypes))) %>% 
  as_tibble(.name_repair = "minimal") %>% 
  set_names(modeltypes) %>% 
  mutate(nin = c(contrasttype, modeltypes), .before = 1) %>% 
  slice(rep(1:n(), each = length(modellocalities))) %>% 
  mutate(locality = rep(modellocalities, length(c(contrasttype, modeltypes))),
         age = 0, bio01 = 0, bio19 = 0, seeds.ExP = 0, seeds.WALD = 0, relelev = 0,
         .before = 1)
```

### distribution family

```{r}
mf <- paste_modelformula(dat, typenames, contrasttype)
m.poissonWALD <- glmmTMB(mf, dat, offset = seeds.WALD, family = "poisson", 
                         ziformula = ~ age + (1 | locality))
summary(m.poissonWALD)
simulationOutput <- simulateResiduals(fittedModel = m.poissonWALD)
testDispersion(simulationOutput)

m.nbinom2WALD <- glmmTMB(mf, dat, offset = seeds.WALD, family = "nbinom2",
                         ziformula = ~ age + (1 | locality))
summary(m.nbinom2WALD)
simulationOutput <- simulateResiduals(fittedModel = m.nbinom2WALD)
testDispersion(simulationOutput) 

m.genpoisWALD <- glmmTMB(mf, dat, offset = seeds.WALD, family = "genpois",
                         ziformula = ~ age + (1 | locality))
summary(m.genpoisWALD) 
simulationOutput <- simulateResiduals(fittedModel = m.genpoisWALD)
testDispersion(simulationOutput) 
```

### dispersal predictor

```{r}
m.genpoisExP <- glmmTMB(mf, dat, offset = seeds.ExP, family = "genpois",
                        ziformula = ~ age + (1 | locality))
summary(m.genpoisExP)

m.genpoisNULL <- glmmTMB(mf, dat, offset = NULL, family = "genpois",
                         ziformula = ~ age + (1 | locality))
summary(m.genpoisNULL)
```

```{r, include=FALSE}
Pa_modelcomp <- bbmle::ICtab(m.genpoisWALD, m.genpoisNULL, base = TRUE, 
                             delta = TRUE, sort = FALSE) %>% 
  as_tibble() %>% 
  add_column(`seed dispersal estimate` = c('WALD', 'none'), .before = 1) %>% 
  add_row(`seed dispersal estimate` = 'ExP', AIC = NA, dAIC = NA, df = NA, .before = 2) 
```

### Residual diagnostics + predictions

```{r}
simulationOutput <- simulateResiduals(fittedModel = m.genpoisWALD)
plot(simulationOutput)
testZeroInflation(simulationOutput)
```

```{r}
Pa_link <- newdat %>% 
  bind_cols(predict(m.genpoisWALD, newdat, se.fit = TRUE, type = "link")) %>% 
  select(locality, fit, se.fit, nin)
```

```{r, include=FALSE}
sensmod <- update(m.genpoisWALD, 
                  update.formula(formula(m.genpoisWALD), ~ . + seeds.WALD), 
                  offset = NULL)
newdat <- filter(newdat, is.na(locality))
Pa_cond_sens <- newdat %>% 
  mutate(fit = predict(sensmod, newdat, se.fit = FALSE, type = "conditional")) %>% 
  select(nin, fit)
```

## Height-stratified models

```{r}
dat <- DVi %>% 
  group_split(randomseed, hgtclass) %>% 
  map(~ add_wildlings(IVi, .) %>% 
        st_drop_geometry())
newdat <- filter(newdat, is.na(locality))
  
safe_predict <- safely(predict_from_genpoisWALDmodel)
plan(multisession, workers = availableCores()-1)
res <- dat %>% # 
  future_map(~ safe_predict(., newdat, typenames, contrasttype))
transpose(res)$error
saveRDS(res, here('output', 'res-Pa-byheight.rds'))

modres <- transpose(res)$result
for (i in seq_along(modres)) {
  if(!is.null(modres[[i]])) {
    modres[[i]] <- modres[[i]] %>% 
      mutate(randomseed = rep(seq_len(nrseeds), each = nrhgtclasses)[i],
             hgtclass = rep(seq_len(nrhgtclasses), nrseeds)[i], .before = 1)
  }
}
modres <- modres %>% 
  bind_rows() %>% 
  select(randomseed, hgtclass, fit, se.fit, nin)
```

```{r}
Pa_link <- Pa_link %>% 
  bind_rows(modres)

rm(m.poissonWALD, m.nbinom2WALD, m.genpoisWALD, m.genpoisExP, m.genpoisNULL)
```

# Larix

```{r}
IVi <- filter(IV, species == "Larix") %>% 
  remove_zero_cols()
summary(IVi)
typenames <- names(IVi)[!names(IVi) %in% nottypes]

DVi <- filter(DV, species == "Larix")
```

## Wildling densities

Disregards height classes.

```{r}
dat <- add_wildlings(IVi, filter(DVi, randomseed == 1)) %>% 
  st_drop_geometry()

L_arith <- pivot_longer(dat, one_of(typenames), names_to = "nin", values_to = "are") %>%
  group_by(nin) %>% 
  summarize(daa = sum(are)/10, # units from are to decare
            n = sum(wildlings*are), .groups = "drop_last") %>% 
  mutate(density = n/daa) %>%
  arrange(desc(density), desc(n), daa)
scaler <- filter(L_arith, nin == contrasttype) %>% 
  pull(density)
L_arith <- mutate(L_arith, fit = density/scaler)
```

```{r, echo=FALSE, results='asis'}
knitr::kable(L_arith, digits = 1)
```

## Height-blind model

Disregards height classes.

Comparing:

1. distribution family (poisson vs. negative binomial vs. generalized poisson)
2. dispersal predictor (seeds.WALD vs. seeds.ExP vs null)

```{r}
modeltypes <- typenames[!(typenames %in% c(contrasttype, identify_completeseparation(dat, typenames)))]
modellocalities <- c(NA, unique(pull(dat, locality)))
newdat <- rbind(0, diag(length(modeltypes))) %>% 
  as_tibble(.name_repair = "minimal") %>% 
  set_names(modeltypes) %>% 
  mutate(nin = c(contrasttype, modeltypes), .before = 1) %>% 
  slice(rep(1:n(), each = length(modellocalities))) %>% 
  mutate(locality = rep(modellocalities, length(c(contrasttype, modeltypes))),
         age = 0, bio01 = 0, bio19 = 0, seeds.ExP = 0, seeds.WALD = 0, relelev = 0,
         .before = 1)
```

### distribution family

```{r}
mf <- paste_modelformula(dat, typenames, contrasttype)
m.poissonWALD <- glmmTMB(mf, dat, offset = seeds.WALD, family = "poisson", 
                         ziformula = ~ age + (1 | locality))
summary(m.poissonWALD)
simulationOutput <- simulateResiduals(fittedModel = m.poissonWALD)
testDispersion(simulationOutput)

m.nbinom2WALD <- glmmTMB(mf, dat, offset = seeds.WALD, family = "nbinom2",
                         ziformula = ~ age + (1 | locality))
summary(m.nbinom2WALD)
simulationOutput <- simulateResiduals(fittedModel = m.nbinom2WALD)
testDispersion(simulationOutput)

m.genpoisWALD <- glmmTMB(mf, dat, offset = seeds.WALD, family = "genpois",
                         ziformula = ~ age + (1 | locality))
summary(m.genpoisWALD)
simulationOutput <- simulateResiduals(fittedModel = m.genpoisWALD)
testDispersion(simulationOutput) 
```

### dispersal predictor

```{r}
m.genpoisExP <- glmmTMB(mf, dat, offset = seeds.ExP, family = "genpois",
                        ziformula = ~ age + (1 | locality))
summary(m.genpoisExP)

m.genpoisNULL <- glmmTMB(mf, dat, offset = NULL, family = "genpois",
                        ziformula = ~ age + (1 | locality))
summary(m.genpoisNULL)
```

```{r, include=FALSE}
L_modelcomp <- bbmle::ICtab(m.genpoisWALD, m.genpoisExP, base = TRUE, 
                             delta = TRUE, sort = FALSE) %>% 
  as_tibble() %>% 
  add_column(`seed dispersal estimate` = c('WALD', 'ExP'), .before = 1) %>% 
  add_row(`seed dispersal estimate` = 'none', AIC = NA, dAIC = NA, df = NA) 
```

### Residual diagnostics + predictions

```{r}
simulationOutput <- simulateResiduals(fittedModel = m.genpoisWALD)
plot(simulationOutput)
testZeroInflation(simulationOutput)
```

```{r}
L_link <- newdat %>% 
  bind_cols(predict(m.genpoisWALD, newdat, se.fit = TRUE, type = "link")) %>% 
  select(locality, fit, se.fit, nin)
```

```{r, include=FALSE}
sensmod <- update(m.genpoisWALD, 
                  update.formula(formula(m.genpoisWALD), ~ . + seeds.WALD), 
                  offset = NULL)
newdat <- filter(newdat, is.na(locality))
L_cond_sens <- newdat %>% 
  mutate(fit = predict(sensmod, newdat, se.fit = FALSE, type = "conditional")) %>% 
  select(nin, fit)
```

## Height-stratified models

```{r}
dat <- DVi %>% 
  group_split(randomseed, hgtclass) %>% 
  map(~ add_wildlings(IVi, .) %>% 
        st_drop_geometry())
newdat <- filter(newdat, is.na(locality))
  
safe_predict <- safely(predict_from_genpoisWALDmodel)
plan(multisession, workers = availableCores()-1)
res <- dat %>%
  future_map(~ safe_predict(., newdat, typenames, contrasttype))
transpose(res)$error
saveRDS(res, here('output', 'res-L-byheight.rds'))

modres <- transpose(res)$result
for (i in seq_along(modres)) {
  if(!is.null(modres[[i]])) {
    modres[[i]] <- modres[[i]] %>% 
      mutate(randomseed = rep(seq_len(nrseeds), each = nrhgtclasses)[i],
             hgtclass = rep(seq_len(nrhgtclasses), nrseeds)[i], .before = 1)
  }
}
modres <- modres %>% 
  bind_rows() %>% 
  select(randomseed, hgtclass, fit, se.fit, nin)
```

```{r}
L_link <- L_link %>% 
  bind_rows(modres)

rm(m.poissonWALD, m.nbinom2WALD, m.genpoisWALD, m.genpoisExP, m.genpoisNULL)
```

# All species

```{r}
species <- c("P.sitchensis-lutzii", "P.abies", "Larix")

arith.list <- list(Ps_arith, Pa_arith, L_arith) %>% 
  set_names(species)

modelcomp.list <- list(Ps_modelcomp, Pa_modelcomp, L_modelcomp) %>% 
  set_names(species)

pred.tbl <- list(Ps_link, Pa_link, L_link) %>% 
  set_names(species) %>% 
  bind_rows(.id = "species") %>% 
  mutate(ci.l = fit - 1.96*se.fit, ci.u = fit + 1.96*se.fit) %>% 
  mutate(across(c('fit', 'ci.l', 'ci.u'), ~ exp(.))) %>% 
  select(-se.fit) %>% 
  group_by(species, randomseed, hgtclass) %>% 
  group_split(.keep = TRUE) %>% 
  map(function(x) {
    scaler <- filter(x, nin == contrasttype, is.na(locality)) %>% 
      pull(fit)
    mutate(x, across(c('fit', 'ci.l', 'ci.u'), ~ `/`(., scaler)))
  }) %>% 
  bind_rows()

results <- list(arithmetic = arith.list, 
                model.comp = modelcomp.list,
                model.preds = pred.tbl)
str(results, 2)
saveRDS(results, here("output","results.rds"))
```

```{r, include=FALSE}
pred_sens.tbl <- list(Ps_cond_sens, Pa_cond_sens, L_cond_sens) %>% 
  set_names(species) %>% 
  bind_rows(.id = "species") %>% 
  group_by(species) %>% 
  group_split(.keep = TRUE) %>% 
  map(function(x) {
    scaler <- filter(x, nin == contrasttype) %>% 
      pull(fit)
    mutate(x, fit = fit/scaler)
  }) %>% 
  bind_rows()

saveRDS(pred_sens.tbl, here("output","results-sensitivity.rds"))
```

```{r sessionInfo}
sessionInfo()
```
