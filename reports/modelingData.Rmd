---
title: "Modeling relative establishment probability"
output: 
  html_document:
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(here)
library(tidyverse)
library(glmmTMB)
library(DHARMa)
```

```{r}
datlist <- readRDS(here("output","data.rds"))
locality.preds <- c('age','bio01','bio19','seeds.ExP','seeds.WALD','relelev')
contrast <- "T4"
excluded <- "plantation forest"
```

# P.sitchensis-lutz

```{r}
Ps_dat <- Filter(function(x)!all(is.na(x)), datlist$`P.sitchensis-lutz`)
```

```{r}
Ps_arith <- pivot_longer(Ps_dat, 10:ncol(Ps_dat), names_to = "nin", values_to = "are") %>%
  group_by(nin) %>% 
  summarize(daa = sum(are)/10, # units from are to decare
            n = sum(wildlings*are)) %>% 
  mutate(density = n/daa) %>%
  arrange(desc(density), desc(n), daa)
scaler <- filter(Ps_arith, nin == contrast) %>% 
  pull(density)
Ps_arith <- mutate(Ps_arith, fit = density/scaler)
```

```{r, echo=FALSE, results='asis'}
knitr::kable(Ps_arith, digits = 1)
```

```{r}
perfectlyseparated <- c('T18', 'T3', 'T33', 'spring')
removed <- c(perfectlyseparated, excluded)
Ps_dat <- Ps_dat %>% 
  filter_at(removed, all_vars(. < 0.5)) %>% 
  filter(!(is.na(seeds.ExP) | is.na(seeds.ExP))) %>% 
  select(-c('species'))
```

```{r}
Ps_means <- Ps_dat[, locality.preds] %>% map_dbl(mean)
Ps_sds <- Ps_dat[, locality.preds] %>% map_dbl(sd)
for (i in locality.preds) {
  Ps_dat <- modify_at(Ps_dat, .at = i, ~ (. - Ps_means[i])/Ps_sds[i])
}
summary(Ps_dat)

paste(names(Ps_dat)[!(names(Ps_dat) %in% c(contrast, removed))], collapse = " + ")
```

### Compare WALD vs ExP

```{r}
Ps_f1 <- formula("wildlings ~ seeds.WALD * age + bio01 + bio19 + relelev + 
                 cultivated + disturbed + T32 + fen + T34 + T13 + T2 + T1 + 
                 swamp + T27 + T17 + bog + T6 + T31 + T16 + T29 + T12 + T24 + 
                 T21 + (1 | locality)")
Ps_m1 <- glmmTMB(Ps_f1, Ps_dat, family = "nbinom2", ziformula = ~ 0)
summary(Ps_m1)
```

```{r}
Ps_f2 <- formula("wildlings ~ seeds.ExP * age + bio01 + bio19 + relelev + 
                 cultivated + disturbed + T32 + fen + T34 + T13 + T2 + T1 + 
                 swamp + T27 + T17 + bog + T6 + T31 + T16 + T29 + T12 + T24 + 
                 T21 + (1 | locality)")
Ps_m2 <- glmmTMB(Ps_f2, Ps_dat, family = "nbinom2", ziformula = ~ 0)
summary(Ps_m2)
```

```{r, echo=FALSE}
bbmle::AICtab(Ps_m1, Ps_m2)
```

Continue with WALD.

### Compare zero inflation effects

```{r}
Ps_m3 <- glmmTMB(Ps_f1, Ps_dat, family = "nbinom2", ziformula = ~ 1)
summary(Ps_m3)
```

```{r}
Ps_m4 <- glmmTMB(Ps_f1, Ps_dat, family = "nbinom2", ziformula = ~ age)
summary(Ps_m4)
```

```{r}
Ps_m5 <- glmmTMB(Ps_f1, Ps_dat, family = "nbinom2", ziformula = ~ age + (1 | locality))
summary(Ps_m5)
```

```{r, echo=FALSE}
bbmle::AICtab(Ps_m1, Ps_m3, Ps_m4, Ps_m5)
```

m5 is better than m1, m3, and m4: much better AIC, clear zero-inflation effects

```{r}
simulationOutput <- simulateResiduals(fittedModel = Ps_m5)
plot(simulationOutput)
testDispersion(simulationOutput)
testZeroInflation(simulationOutput)
```

Diagnostics look OK.

### Interpret relative establishment probability

```{r}
selmod <- Ps_m5
terms <- attributes(selmod$frame)$terms 
newdat <- attributes(terms)$factors %>% 
  as_tibble() %>% 
  select(-`seeds.WALD:age`) %>% 
  mutate(seeds.WALD = (Ps_means["seeds.WALD"] - Ps_means["seeds.WALD"]) / Ps_sds["seeds.WALD"],
         age = (Ps_means["age"] - Ps_means["age"]) / Ps_sds["age"],
         bio01 = (Ps_means["bio01"] - Ps_means["bio01"]) / Ps_sds["bio01"],
         bio19 = (Ps_means["bio19"] - Ps_means["bio19"]) / Ps_sds["bio19"],
         relelev = (Ps_means["relelev"] - Ps_means["relelev"]) / Ps_sds["relelev"],
         locality = NA_character_) %>% 
  distinct()
newdat <- newdat %>% 
  mutate(nin = names(newdat)[apply(newdat, 1, match, x = 1)]) %>% 
  replace_na(list(nin = "T4"))
```

```{r}
Ps_link <- bind_cols(newdat, predict(selmod, newdat, se.fit = TRUE, type = "link"))
Ps_link <- mutate(Ps_link, ci.l = fit - 1.96*se.fit, ci.u = fit + 1.96*se.fit) %>% 
  select(-se.fit) %>% 
  mutate_at(c('fit', 'ci.l', 'ci.u'), ~ exp(.))
scaler <- filter(Ps_link, nin == "T4") %>% 
  pull(fit)
link.scaled <- mutate_at(Ps_link, c('fit', 'ci.l', 'ci.u'), ~ `/`(., scaler))
```

```{r}
gg <- ggplot(link.scaled, aes(reorder(nin, fit), fit)) + 
  geom_linerange(mapping = aes(ymin = ci.l, ymax = ci.u)) + 
  geom_point()  + 
  geom_point(data = filter(Ps_arith, nin %in% link.scaled$nin), 
             col = "grey", pch = 1)
gg + scale_y_log10() + coord_flip()
```

```{r, eval=FALSE, include=FALSE}
cond <- bind_cols(newdat, predict(selmod, newdat, se.fit = TRUE, type = "conditional"))
cond <- mutate(cond, se.l = fit - se.fit, se.u = fit + se.fit) %>% 
  mutate_at(.vars = c('fit', 'se.l', 'se.u'), ~ log(.)) %>% 
  mutate(ci.l = fit + 1.96*(se.l - fit),
         ci.u = fit + 1.96*(se.u - fit)) %>% 
  mutate_at(.vars = c('fit', 'se.l', 'se.u', 'ci.l', 'ci.u'), ~ exp(.))
scaler <- filter(cond, nin == "T4") %>% 
  pull(fit)
cond.scaled <- mutate_at(cond, .vars = c('fit', 'se.l', 'se.u', 'ci.l', 'ci.u'),
                         ~ `/`(., scaler))

gg <- ggplot(cond.scaled, aes(nin, fit)) + 
  geom_linerange(mapping = aes(ymin = ci.l, ymax = ci.u)) + 
  geom_point()  + 
  geom_point(data = filter(Ps_arith, nin %in% cond.scaled$nin), 
             col = "grey", pch = 1)
gg + scale_y_log10() + coord_flip()
```

```{r}
newdat.locality <- newdat %>% 
  select(-locality) %>% 
  expand_grid(locality = c(NA_character_, unique(Ps_dat$locality)))
resp.locality <- newdat.locality %>% 
  bind_cols(fit = predict(selmod, newdat.locality, type = "response"))
scaler <- filter(resp.locality, nin == "T4" & is.na(locality)) %>% 
  pull(fit)
resp.locality.scaled <- mutate_at(resp.locality, 'fit', ~ `/`(., scaler))

gg <- ggplot(resp.locality.scaled, aes(reorder(nin, fit), fit)) + 
  geom_point(data = filter(resp.locality.scaled, !is.na(locality)), 
             mapping = aes(color = locality), cex = 0.5, show.legend = FALSE)  + 
  geom_point(data = filter(resp.locality.scaled, is.na(locality)))  + 
  geom_point(data = filter(Ps_arith, nin %in% resp.locality.scaled$nin), 
             color = "grey50",pch = 1)
gg + scale_y_log10() + coord_flip()
```

```{r}
rezi <- ranef(Ps_m5)$zi$locality
rezi <- tibble(locality = rownames(rezi), rezi = rezi[,1]) %>% 
  arrange(desc(rezi))
cordat <- Ps_dat %>% 
  select(locality, bio01, bio19) %>% 
  distinct() %>% 
  left_join(rezi)
pairs(cordat[2:4])
cor(cordat[2:4])
```

```{r}
Ps_m6 <- glmmTMB(Ps_f1, Ps_dat, family = "nbinom2", 
                 ziformula = ~ age + bio01 + bio19 + (1 | locality))
summary(Ps_m6)
bbmle::AICtab(Ps_m5, Ps_m6)

selmod <- Ps_m6
terms <- attributes(selmod$frame)$terms 
newdat <- attributes(terms)$factors %>% 
  as_tibble() %>% 
  select(-`seeds.WALD:age`) %>% 
  mutate(seeds.WALD = (Ps_means["seeds.WALD"] - Ps_means["seeds.WALD"]) / Ps_sds["seeds.WALD"],
         age = (Ps_means["age"] - Ps_means["age"]) / Ps_sds["age"],
         bio01 = (Ps_means["bio01"] - Ps_means["bio01"]) / Ps_sds["bio01"],
         bio19 = (Ps_means["bio19"] - Ps_means["bio19"]) / Ps_sds["bio19"],
         relelev = (Ps_means["relelev"] - Ps_means["relelev"]) / Ps_sds["relelev"],
         locality = NA_character_) %>% 
  distinct()
newdat <- newdat %>% 
  mutate(nin = names(newdat)[apply(newdat, 1, match, x = 1)]) %>% 
  replace_na(list(nin = "T4"))

newdat.locality <- newdat %>% 
  select(-locality) %>% 
  expand_grid(locality = c(NA_character_, unique(Ps_dat$locality)))
resp.locality <- newdat.locality %>% 
  bind_cols(fit = predict(selmod, newdat.locality, type = "response"))
scaler <- filter(resp.locality, nin == "T4" & is.na(locality)) %>% 
  pull(fit)
resp.locality.scaled <- mutate_at(resp.locality, 'fit', ~ `/`(., scaler))

gg <- ggplot(resp.locality.scaled, aes(reorder(nin, fit), fit)) + 
  geom_point(data = filter(resp.locality.scaled, !is.na(locality)), 
             mapping = aes(color = locality), cex = 0.5, show.legend = FALSE)  + 
  geom_point(data = filter(resp.locality.scaled, is.na(locality)))  + 
  geom_point(data = filter(Ps_arith, nin %in% resp.locality.scaled$nin), 
             color = "grey50",pch = 1)
gg + scale_y_log10() + coord_flip()
```


# Larix

```{r}
L_dat <- Filter(function(x)!all(is.na(x)), datlist$Larix)
```

```{r}
L_arith <- pivot_longer(L_dat, 10:ncol(L_dat), names_to = "nin", values_to = "are") %>%
  group_by(nin) %>% 
  summarize(daa = sum(are)/10, # units from are to decare
            n = sum(wildlings*are)) %>% 
  mutate(density = n/daa) %>%
  arrange(desc(density), desc(n), daa)
scaler <- filter(L_arith, nin == contrast) %>% 
  pull(density)
L_arith <- mutate(L_arith, fit = density/scaler)
```

```{r, echo=FALSE, results='asis'}
knitr::kable(L_arith, digits = 1)
```

```{r}
perfectlyseparated <- c('T18', 'T30', 'T2', 'T27', 'swamp', 'T13')
removed <- c(perfectlyseparated, excluded)
L_dat <- L_dat %>% 
  filter_at(removed, all_vars(. < 0.5)) %>% 
  filter(!(is.na(seeds.ExP) | is.na(seeds.ExP))) %>% 
  select(-c('species'))
```

```{r}
L_means <- L_dat[, locality.preds] %>% map_dbl(mean)
L_sds <- L_dat[, locality.preds] %>% map_dbl(sd)
for (i in locality.preds) {
  L_dat <- modify_at(L_dat, .at = i, ~ (. - L_means[i])/L_sds[i])
}
summary(L_dat)

paste(names(L_dat)[!(names(L_dat) %in% c(contrast, removed))], collapse = " + ")
```

### Compare WALD vs ExP

```{r}
L_f1 <- formula("wildlings ~ seeds.WALD * age + bio01 + bio19 + relelev + 
                cultivated + disturbed + T32 + fen + T34 + T1 + T17 + 
                (1 | locality)")
L_m1 <- glmmTMB(L_f1, L_dat, family = "nbinom2", ziformula = ~ 0)
summary(L_m1)
```

```{r}
L_f2 <- formula("wildlings ~ seeds.ExP * age + bio01 + bio19 + relelev + 
                cultivated + disturbed + T32 + fen + T34 + T1 + T17 + 
                (1 | locality)")
L_m2 <- glmmTMB(L_f2, L_dat, family = "nbinom2", ziformula = ~ 0)
summary(L_m2)
```

```{r, echo=FALSE}
bbmle::AICtab(L_m1, L_m2)
```

Continue with WALD.

### Compare zero inflation effects

```{r}
L_m3 <- glmmTMB(L_f1, L_dat, family = "nbinom2", ziformula = ~ 1)
summary(L_m3)
```

```{r}
L_m4 <- glmmTMB(L_f1, L_dat, family = "nbinom2", ziformula = ~ age)
summary(L_m4)
```

```{r}
L_m5 <- glmmTMB(L_f1, L_dat, family = "nbinom2", ziformula = ~ age + (1 | locality))
summary(L_m5)
```

```{r, echo=FALSE}
bbmle::AICtab(L_m1, L_m3, L_m4, L_m5)
```

m5 is better than m1, m3, and m4: much better AIC, clear zero-inflation effects

```{r}
simulationOutput <- simulateResiduals(fittedModel = L_m5)
plot(simulationOutput)
testDispersion(simulationOutput)
testZeroInflation(simulationOutput)
```

Diagnostics look OK.

### Interpret relative establishment probability

```{r}
selmod <- L_m5
terms <- attributes(selmod$frame)$terms 
newdat <- attributes(terms)$factors %>% 
  as_tibble() %>% 
  select(-`seeds.WALD:age`) %>% 
  mutate(seeds.WALD = (Ps_means["seeds.WALD"] - L_means["seeds.WALD"]) / L_sds["seeds.WALD"],
         age = (Ps_means["age"] - L_means["age"]) / L_sds["age"],
         bio01 = (Ps_means["bio01"] - L_means["bio01"]) / L_sds["bio01"],
         bio19 = (Ps_means["bio19"] - L_means["bio19"]) / L_sds["bio19"],
         relelev = (Ps_means["relelev"] - L_means["relelev"]) / L_sds["relelev"],
         locality = NA_character_) %>% 
  distinct()
newdat <- newdat %>% 
  mutate(nin = names(newdat)[apply(newdat, 1, match, x = 1)]) %>% 
  replace_na(list(nin = "T4"))
```

```{r}
L_link <- bind_cols(newdat, predict(selmod, newdat, se.fit = TRUE, type = "link"))
L_link <- mutate(L_link, ci.l = fit - 1.96*se.fit, ci.u = fit + 1.96*se.fit) %>% 
  select(-se.fit) %>% 
  mutate_at(c('fit', 'ci.l', 'ci.u'), ~ exp(.))
scaler <- filter(L_link, nin == "T4") %>% 
  pull(fit)
link.scaled <- mutate_at(L_link, c('fit', 'ci.l', 'ci.u'), ~ `/`(., scaler))
```

```{r}
gg <- ggplot(link.scaled, aes(reorder(nin, fit), fit)) + 
  geom_linerange(mapping = aes(ymin = ci.l, ymax = ci.u)) + 
  geom_point()  + 
  geom_point(data = filter(L_arith, nin %in% link.scaled$nin), 
             col = "grey", pch = 1)
gg + scale_y_log10() + coord_flip()
```

```{r, eval=FALSE, include=FALSE}
cond <- bind_cols(newdat, predict(selmod, newdat, se.fit = TRUE, type = "conditional"))
cond <- mutate(cond, se.l = fit - se.fit, se.u = fit + se.fit) %>% 
  mutate_at(.vars = c('fit', 'se.l', 'se.u'), ~ log(.)) %>% 
  mutate(ci.l = fit + 1.96*(se.l - fit),
         ci.u = fit + 1.96*(se.u - fit)) %>% 
  mutate_at(.vars = c('fit', 'se.l', 'se.u', 'ci.l', 'ci.u'), ~ exp(.))
scaler <- filter(cond, nin == "T4") %>% 
  pull(fit)
cond.scaled <- mutate_at(cond, .vars = c('fit', 'se.l', 'se.u', 'ci.l', 'ci.u'),
                         ~ `/`(., scaler))

gg <- ggplot(cond.scaled, aes(reorder(nin, fit), fit)) + 
  geom_linerange(mapping = aes(ymin = ci.l, ymax = ci.u)) + 
  geom_point()  + 
  geom_point(data = filter(L_arith, nin %in% cond.scaled$nin), 
             col = "grey", pch = 1)
gg + scale_y_log10() + coord_flip()
```

```{r}
newdat.locality <- newdat %>% 
  select(-locality) %>% 
  expand_grid(locality = c(NA_character_, unique(L_dat$locality)))
resp.locality <- newdat.locality %>% 
  bind_cols(fit = predict(selmod, newdat.locality, type = "response"))
scaler <- filter(resp.locality, nin == "T4" & is.na(locality)) %>% 
  pull(fit)
resp.locality.scaled <- mutate_at(resp.locality, 'fit', ~ `/`(., scaler))

gg <- ggplot(resp.locality.scaled, aes(reorder(nin, fit), fit)) + 
  geom_point(data = filter(resp.locality.scaled, !is.na(locality)), 
             mapping = aes(color = locality), cex = 0.5, show.legend = FALSE)  + 
  geom_point(data = filter(resp.locality.scaled, is.na(locality)))  + 
  geom_point(data = filter(L_arith, nin %in% resp.locality.scaled$nin), 
             color = "grey50",pch = 1)
gg + scale_y_log10() + coord_flip()
```

# P.abies

```{r}
Pa_dat <- Filter(function(x)!all(is.na(x)), datlist$P.abies)
```

```{r}
Pa_arith <- pivot_longer(Pa_dat, 10:ncol(Pa_dat), names_to = "nin", values_to = "are") %>%
  group_by(nin) %>% 
  summarize(daa = sum(are)/10, # units from are to decare
            n = sum(wildlings*are)) %>% 
  mutate(density = n/daa) %>%
  arrange(desc(density), desc(n), daa)
scaler <- filter(Pa_arith, nin == contrast) %>% 
  pull(density)
Pa_arith <- mutate(Pa_arith, fit = density/scaler)
```

```{r, echo=FALSE, results='asis'}
knitr::kable(Pa_arith, digits = 1)
```

```{r}
perfectlyseparated <- c('T6', 'T31', 'T2')
removed <- c(perfectlyseparated, excluded)
Pa_dat <- Pa_dat %>% 
  filter_at(removed, all_vars(. < 0.5)) %>% 
  filter(!(is.na(seeds.ExP) | is.na(seeds.ExP))) %>% 
  select(-c('species'))
```

```{r}
Pa_means <- Pa_dat[, locality.preds] %>% map_dbl(mean)
Pa_sds <- Pa_dat[, locality.preds] %>% map_dbl(sd)
for (i in locality.preds) {
  Pa_dat <- modify_at(Pa_dat, .at = i, ~ (. - Pa_means[i])/Pa_sds[i])
}
summary(Pa_dat)

paste(names(Pa_dat)[!(names(Pa_dat) %in% c(contrast, removed))], collapse = " + ")
```

### Compare WALD vs ExP

```{r}
Pa_f1 <- formula("wildlings ~ seeds.WALD * age + bio01 + bio19 + relelev + 
                 cultivated + disturbed + T32 + fen + T1 + swamp + spring + bog + 
                 (1 | locality)")
Pa_m1 <- glmmTMB(Pa_f1, Pa_dat, family = "nbinom2", ziformula = ~ 0)
summary(Pa_m1)
```

```{r}
Pa_f2 <- formula("wildlings ~ seeds.ExP * age + bio01 + bio19 + relelev + 
                 cultivated + disturbed + T32 + fen + T1 + swamp + spring + bog +
                 (1 | locality)")
Pa_m2 <- glmmTMB(Pa_f2, Pa_dat, family = "nbinom2", ziformula = ~ 0)
summary(Pa_m2)
```

```{r, echo=FALSE}
bbmle::AICtab(Pa_m1, Pa_m2)
```

Continue with WALD.

### Compare zero inflation effects

```{r}
Pa_m3 <- glmmTMB(Pa_f1, Pa_dat, family = "nbinom2", ziformula = ~ 1)
summary(Pa_m3)
```

```{r}
Pa_m4 <- glmmTMB(Pa_f1, Pa_dat, family = "nbinom2", ziformula = ~ age)
summary(Pa_m4)
```

```{r}
Pa_m5 <- glmmTMB(Pa_f1, Pa_dat, family = "nbinom2", ziformula = ~ age + (1 | locality))
summary(Pa_m5)
```

```{r, echo=FALSE}
bbmle::AICtab(Pa_m1, Pa_m3, Pa_m4, Pa_m5)
```

m5 is better than m1, m3, and m4: much better AIC, zero-inflation effects

Drop insignificant interaction term?

```{r}
Pa_f6 <- update.formula(Pa_f1, ~ . - seeds.WALD:age)
Pa_m6 <- glmmTMB(Pa_f6, Pa_dat, family = "nbinom2", ziformula = ~ age + (1 | locality))
summary(Pa_m6)
```

```{r, echo=FALSE}
bbmle::AICtab(Pa_m5, Pa_m6)
```

```{r}
simulationOutput <- simulateResiduals(fittedModel = Pa_m6)
plot(simulationOutput)
testDispersion(simulationOutput)
testZeroInflation(simulationOutput)
```

Diagnostics look bad --- particularly dispersion test.

```{r}
Pa_m7 <- glmmTMB(Pa_f6, Pa_dat, family = "genpois", ziformula = ~ age + (1 | locality))
summary(Pa_m7)
```

```{r}
simulationOutput <- simulateResiduals(fittedModel = Pa_m7)
plot(simulationOutput)
testDispersion(simulationOutput)
testZeroInflation(simulationOutput)
```

Better diagnostics with generalized poisson --- including dispersion test.

```{r}
Pa_m8 <- glmmTMB(Pa_f6, Pa_dat, family = poisson, ziformula = ~ age + (1 | locality))
summary(Pa_m8)
```

```{r}
simulationOutput <- simulateResiduals(fittedModel = Pa_m8)
plot(simulationOutput)
testDispersion(simulationOutput)
testZeroInflation(simulationOutput)
```

Better diagnostics with poisson --- including dispersion test.

```{r, echo=FALSE}
bbmle::AICtab(Pa_m6, Pa_m7, Pa_m8)
```

Continue with generalized poisson model: best AIC and OK diagnostics. 

### Interpret relative establishment probability

```{r}
selmod <- Pa_m7
terms <- attributes(selmod$frame)$terms 
newdat <- attributes(terms)$factors %>% 
  as_tibble() %>% 
  mutate(seeds.WALD = (Ps_means["seeds.WALD"] - Pa_means["seeds.WALD"]) / Pa_sds["seeds.WALD"],
         age = (Ps_means["age"] - Pa_means["age"]) / Pa_sds["age"],
         bio01 = (Ps_means["bio01"] - Pa_means["bio01"]) / Pa_sds["bio01"],
         bio19 = (Ps_means["bio19"] - Pa_means["bio19"]) / Pa_sds["bio19"],
         relelev = (Ps_means["relelev"] - Pa_means["relelev"]) / Pa_sds["relelev"],
         locality = NA_character_) %>% 
  distinct()
newdat <- newdat %>% 
  mutate(nin = names(newdat)[apply(newdat, 1, match, x = 1)]) %>% 
  replace_na(list(nin = "T4"))
```

```{r}
Pa_link <- bind_cols(newdat, predict(selmod, newdat, se.fit = TRUE, type = "link"))
Pa_link <- mutate(Pa_link, ci.l = fit - 1.96*se.fit, ci.u = fit + 1.96*se.fit) %>% 
  select(-se.fit) %>% 
  mutate_at(c('fit', 'ci.l', 'ci.u'), ~ exp(.))
scaler <- filter(Pa_link, nin == "T4") %>% 
  pull(fit)
link.scaled <- mutate_at(Pa_link, c('fit', 'ci.l', 'ci.u'), ~ `/`(., scaler))
```

```{r}
gg <- ggplot(link.scaled, aes(reorder(nin, fit), fit)) + 
  geom_linerange(mapping = aes(ymin = ci.l, ymax = ci.u)) + 
  geom_point()  + 
  geom_point(data = filter(Pa_arith, nin %in% link.scaled$nin), 
             col = "grey", pch = 1)
gg + scale_y_log10() + coord_flip()
```

```{r, eval=FALSE, include=FALSE}
cond <- bind_cols(newdat, predict(selmod, newdat, se.fit = TRUE, type = "conditional"))
cond <- mutate(cond, se.l = fit - se.fit, se.u = fit + se.fit) %>% 
  mutate_at(.vars = c('fit', 'se.l', 'se.u'), ~ log(.)) %>% 
  mutate(ci.l = fit + 1.96*(se.l - fit),
         ci.u = fit + 1.96*(se.u - fit)) %>% 
  mutate_at(.vars = c('fit', 'se.l', 'se.u', 'ci.l', 'ci.u'), ~ exp(.))
scaler <- filter(cond, nin == "T4") %>% 
  pull(fit)
cond.scaled <- mutate_at(cond, .vars = c('fit', 'se.l', 'se.u', 'ci.l', 'ci.u'),
                         ~ `/`(., scaler))

gg <- ggplot(cond.scaled, aes(reorder(nin, fit), fit)) + 
  geom_linerange(mapping = aes(ymin = ci.l, ymax = ci.u)) + 
  geom_point()  + 
  geom_point(data = filter(Pa_arith, nin %in% cond.scaled$nin), 
             col = "grey", pch = 1)
gg + scale_y_log10() + coord_flip()
```

```{r}
newdat.locality <- newdat %>% 
  select(-locality) %>% 
  expand_grid(locality = c(NA_character_, unique(Pa_dat$locality)))
resp.locality <- newdat.locality %>% 
  bind_cols(fit = predict(selmod, newdat.locality, type = "response"))
scaler <- filter(resp.locality, nin == "T4" & is.na(locality)) %>% 
  pull(fit)
resp.locality.scaled <- mutate_at(resp.locality, 'fit', ~ `/`(., scaler))

gg <- ggplot(resp.locality.scaled, aes(reorder(nin, fit), fit)) + 
  geom_point(data = filter(resp.locality.scaled, !is.na(locality)), 
             mapping = aes(color = locality), cex = 0.5, show.legend = FALSE)  + 
  geom_point(data = filter(resp.locality.scaled, is.na(locality)))  + 
  geom_point(data = filter(Pa_arith, nin %in% resp.locality.scaled$nin), 
             color = "grey50",pch = 1)
gg + scale_y_log10() + coord_flip()
```

# P.contorta

```{r}
Pc_dat <- Filter(function(x)!all(is.na(x)), datlist$P.contorta)
```

```{r}
Pc_arith <- pivot_longer(Pc_dat, 10:ncol(Pc_dat), names_to = "nin", values_to = "are") %>%
  group_by(nin) %>% 
  summarize(daa = sum(are)/10, # units from are to decare
            n = sum(wildlings*are)) %>% 
  mutate(density = n/daa) %>%
  arrange(desc(density), desc(n), daa)
scaler <- filter(Pc_arith, nin == contrast) %>% 
  pull(density)
Pc_arith <- mutate(Pc_arith, fit = density/scaler)
```

```{r, echo=FALSE, results='asis'}
knitr::kable(Pc_arith, digits = 1)
```

```{r}
perfectlyseparated <- c('cultivated', 'T27', 'T32')
removed <- c(perfectlyseparated, excluded)
Pc_dat <- Pc_dat %>% 
  filter_at(removed, all_vars(. < 0.5)) %>% 
  filter(!(is.na(seeds.ExP) | is.na(seeds.ExP) | is.na(relelev))) %>% 
  select(-c('species'))
```

```{r}
Pc_means <- Pc_dat[, locality.preds] %>% map_dbl(mean)
Pc_sds <- Pc_dat[, locality.preds] %>% map_dbl(sd)
for (i in locality.preds) {
  Pc_dat <- modify_at(Pc_dat, .at = i, ~ (. - Pc_means[i])/Pc_sds[i])
}
summary(Pc_dat)

paste(names(Pc_dat)[!(names(Pc_dat) %in% c(contrast, removed))], collapse = " + ")
```

### Compare WALD vs ExP

```{r}
Pc_f1 <- formula("wildlings ~ seeds.WALD * age + bio01 + bio19 + relelev + 
                 disturbed + fen + T34 + T1 + swamp + T30 + bog + (1 | locality)")
Pc_m1 <- glmmTMB(Pc_f1, Pc_dat, family = "nbinom2", ziformula = ~ 0)
summary(Pc_m1)
```

```{r}
Pc_f2 <- formula("wildlings ~ seeds.ExP * age + bio01 + bio19 + relelev + 
                 disturbed + fen + T34 + T1 + swamp + T30 + bog + (1 | locality)")
Pc_m2 <- glmmTMB(Pc_f2, Pc_dat, family = "nbinom2", ziformula = ~ 0)
summary(Pc_m2)
```

```{r, echo=FALSE}
bbmle::AICtab(Pc_m1, Pc_m2)
```

Continue with WALD.

### Compare zero inflation effects

```{r}
Pc_m3 <- glmmTMB(Pc_f1, Pc_dat, family = "nbinom2", ziformula = ~ 1)
summary(Pc_m3)
```

```{r, eval=FALSE}
Pc_m4 <- glmmTMB(Pc_f1, Pc_dat, family = "nbinom2", ziformula = ~ age)
# Warning messages:
# 1: In fitTMB(TMBStruc) :
# Model convergence problem; non-positive-definite Hessian matrix. See vignette('troubleshooting')
```

```{r, eval=FALSE}
Pc_m5 <- glmmTMB(Pc_f1, Pc_dat, family = "nbinom2", ziformula = ~ age + (1 | locality))
# Warning messages:
# 1: In fitTMB(TMBStruc) :
# Model convergence problem; non-positive-definite Hessian matrix. See vignette('troubleshooting')
# 2: In fitTMB(TMBStruc) :
# Model convergence problem; false convergence (8). See vignette('troubleshooting')
```

Overparameterized models? bio01 and bio19 show largest coefficients (5-6) while insignificant for other species. Try dropping them.

```{r, eval=FALSE}
Pc_f6 <- update.formula(Pc_f1, ~ . - bio01 - bio19)
Pc_m6 <- glmmTMB(Pc_f6, Pc_dat, family = "nbinom2", ziformula = ~ age + (1 | locality))
# Warning messages:
# 1: In fitTMB(TMBStruc) :
# Model convergence problem; non-positive-definite Hessian matrix. See vignette('troubleshooting')
```

```{r}
Pc_m7 <- glmmTMB(Pc_f1, Pc_dat, family = "genpois", ziformula = ~ age + (1 | locality))
summary(Pc_m7)
```

Huge overdispersion parameter. Also huge coefficients for bio01 and bio19. 

```{r, echo=FALSE}
bbmle::AICtab(Pc_m3, Pc_m7)
```

```{r}
simulationOutput <- simulateResiduals(fittedModel = Pc_m7)
plot(simulationOutput)
testDispersion(simulationOutput)
testZeroInflation(simulationOutput)
```

Diagnostics look OK.

Continue with generalized poisson model: best AIC and OK diagnostics. 

### Interpret relative establishment probability

```{r}
selmod <- Pc_m7
terms <- attributes(selmod$frame)$terms 
newdat <- attributes(terms)$factors %>% 
  as_tibble() %>% 
  select(-`seeds.WALD:age`) %>% 
  mutate(seeds.WALD = (Ps_means["seeds.WALD"] - Pc_means["seeds.WALD"]) / Pc_sds["seeds.WALD"],
         age = (Ps_means["age"] - Pc_means["age"]) / Pc_sds["age"],
         bio01 = (Ps_means["bio01"] - Pc_means["bio01"]) / Pc_sds["bio01"],
         bio19 = (Ps_means["bio19"] - Pc_means["bio19"]) / Pc_sds["bio19"],
         relelev = (Ps_means["relelev"] - Pc_means["relelev"]) / Pc_sds["relelev"],
         locality = NA_character_) %>% 
  distinct()
newdat <- newdat %>% 
  mutate(nin = names(newdat)[apply(newdat, 1, match, x = 1)]) %>% 
  replace_na(list(nin = "T4"))
```

```{r}
Pc_link <- bind_cols(newdat, predict(selmod, newdat, se.fit = TRUE, type = "link"))
Pc_link <- mutate(Pc_link, ci.l = fit - 1.96*se.fit, ci.u = fit + 1.96*se.fit) %>% 
  select(-se.fit) %>% 
  mutate_at(c('fit', 'ci.l', 'ci.u'), ~ exp(.))
scaler <- filter(Pc_link, nin == "T4") %>% 
  pull(fit)
link.scaled <- mutate_at(Pc_link, c('fit', 'ci.l', 'ci.u'), ~ `/`(., scaler))
```

```{r}
gg <- ggplot(link.scaled, aes(reorder(nin, fit), fit)) + 
  geom_linerange(mapping = aes(ymin = ci.l, ymax = ci.u)) + 
  geom_point()  + 
  geom_point(data = filter(Pc_arith, nin %in% link.scaled$nin), 
             col = "grey", pch = 1)
gg + scale_y_log10() + coord_flip()
```

```{r, eval=FALSE, include=FALSE}
cond <- bind_cols(newdat, predict(selmod, newdat, se.fit = TRUE, type = "conditional"))
cond <- mutate(cond, se.l = fit - se.fit, se.u = fit + se.fit) %>% 
  mutate_at(.vars = c('fit', 'se.l', 'se.u'), ~ log(.)) %>% 
  mutate(ci.l = fit + 1.96*(se.l - fit),
         ci.u = fit + 1.96*(se.u - fit)) %>% 
  mutate_at(.vars = c('fit', 'se.l', 'se.u', 'ci.l', 'ci.u'), ~ exp(.))
scaler <- filter(cond, nin == "T4") %>% 
  pull(fit)
cond.scaled <- mutate_at(cond, .vars = c('fit', 'se.l', 'se.u', 'ci.l', 'ci.u'),
                         ~ `/`(., scaler))

gg <- ggplot(cond.scaled, aes(reorder(nin, fit), fit)) + 
  geom_linerange(mapping = aes(ymin = ci.l, ymax = ci.u)) + 
  geom_point()  + 
  geom_point(data = filter(L_arith, nin %in% cond.scaled$nin), 
             col = "grey", pch = 1)
gg + scale_y_log10() + coord_flip()
```

```{r}
newdat.locality <- newdat %>% 
  select(-locality) %>% 
  expand_grid(locality = c(NA_character_, unique(Pc_dat$locality)))
resp.locality <- newdat.locality %>% 
  bind_cols(fit = predict(selmod, newdat.locality, type = "response"))
scaler <- filter(resp.locality, nin == "T4" & is.na(locality)) %>% 
  pull(fit)
resp.locality.scaled <- mutate_at(resp.locality, 'fit', ~ `/`(., scaler))

gg <- ggplot(resp.locality.scaled, aes(reorder(nin, fit), fit)) + 
  geom_point(data = filter(resp.locality.scaled, !is.na(locality)), 
             mapping = aes(color = locality), cex = 0.5, show.legend = FALSE)  + 
  geom_point(data = filter(resp.locality.scaled, is.na(locality)))  + 
  geom_point(data = filter(L_arith, nin %in% resp.locality.scaled$nin), 
             color = "grey50",pch = 1)
gg + scale_y_log10() + coord_flip()
```

# All species

```{r}
link.list <- list(Ps_link, L_link, Pa_link, Pc_link)
names(link.list) <- c('Picea sitchensis/lutzii', 'Larix', 'Picea abies', 'Pinus contorta')
link <- bind_rows(link.list, .id = 'species')
scaler <- filter(link, species == 'Picea sitchensis/lutzii', nin == "T4") %>% 
  pull(fit)
link.scaled <- mutate_at(link, c('fit', 'ci.l', 'ci.u'), ~ `/`(., scaler))
```

```{r}
arith.list <- list(filter(Ps_arith, nin %in% Ps_link$nin), 
                   filter(L_arith, nin %in% L_link$nin),
                   filter(Pa_arith, nin %in% Pa_link$nin),
                   filter(Pc_arith, nin %in% Pc_link$nin))
names(arith.list) <- c('Picea sitchensis/lutzii', 'Larix', 'Picea abies', 'Pinus contorta')
arith <- bind_rows(arith.list, .id = 'species')
scaler <- filter(arith, species == 'Picea sitchensis/lutzii', nin == "T4") %>% 
  pull(density)
arith.scaled <- mutate(arith, fit = density/scaler)
```

```{r}
link.scaled[,c('species','nin','fit','ci.l','ci.u')]
gg <- ggplot(link.scaled, aes(fct_reorder(nin, fit, first), fit, color = species)) + 
  geom_linerange(mapping = aes(ymin = ci.l, ymax = ci.u), 
                 position = position_dodge(width = 0.5)) + 
  geom_point(position = position_dodge(width = 0.5))  + 
  geom_point(data = arith.scaled, pch = 1, position = position_dodge(width = 0.5))
gg + scale_y_log10() + coord_flip() + 
  labs(x = 'NiN type', y = 'relative establishment probability', title = 'Relative establishment across species and NiN types')
```

Filled points are model estimates with lines showing 95% confidence intervals. Open points are calculated directly from the number of wildlings per unit area.

# sessionInfo

```{r sessionInfo}
sessionInfo()
```

