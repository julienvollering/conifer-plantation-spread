---
title: "Modeling"
output: 
  html_document:
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(tidyverse)
library(glmmTMB)
library(DHARMa)
library(emmeans)
```

```{r}
datlist <- readRDS(here("output","data.rds"))
```

# Larix

```{r}
L_dat <- Filter(function(x)!all(is.na(x)), datlist$Larix)

excluded <- "plantation forest"
perfectlyseparated <- c('T18', 'T30', 'T2', 'T27', 'swamp', 'T13')
removed <- c(excluded, perfectlyseparated)
L_dat <- L_dat %>% 
  filter_at(removed, all_vars(. < 0.5)) %>% 
  filter(!(is.na(seeds.ExP) | is.na(seeds.ExP))) %>% 
  select(-c('species')) %>% 
  psycho::standardize(subset = list("seeds.WALD","seeds.ExP","age",
                                    "bio01","bio19","relelev"))
summary(L_dat)

contrast <- "T4"
paste(names(L_dat)[!(names(L_dat) %in% c(contrast, removed))], collapse = " + ")
```

Perfectly separated: T18, T30, T2, T27, swamp, T13 (0 wildlings, from wildlings-NiN.Rmd)

### Compare WALD vs ExP

```{r}
L_f1 <- formula("wildlings ~ seeds.WALD * age + bio01 + bio19 + relelev + cultivated + disturbed + T32 + fen + T34 + T1 + T17 + (1 | locality)")
L_m1 <- glmmTMB(L_f1, L_dat, family = "nbinom2", ziformula = ~ 0)
summary(L_m1)
```

```{r}
L_f2 <- formula("wildlings ~ seeds.ExP * age + bio01 + bio19 + relelev + cultivated + disturbed + T32 + fen + T34 + T1 + T17 + (1 | locality)")
L_m2 <- glmmTMB(L_f2, L_dat, family = "nbinom2", ziformula = ~ 0)
summary(L_m2)
```

```{r}
bbmle::AICtab(L_m1, L_m2)
```

Continue with WALD.

### Compare zero inflation effects

```{r}
L_m3 <- glmmTMB(L_f1, L_dat, family = "nbinom2", ziformula = ~ 1)
summary(L_m3)
```

```{r}
L_m4 <- glmmTMB(L_f1, L_dat, family = "nbinom2", ziformula = ~ age)
summary(L_m4)
```

```{r}
L_m5 <- glmmTMB(L_f1, L_dat, family = "nbinom2", ziformula = ~ age + (1 | locality))
summary(L_m5)
```

```{r}
bbmle::AICtab(L_m1, L_m3, L_m4, L_m5)
```

m5 is better than m1, m3, and m4: much better AIC, clear zero-inflation effects

```{r}
simulationOutput <- simulateResiduals(fittedModel = L_m5)
plot(simulationOutput)
testDispersion(simulationOutput)
testZeroInflation(simulationOutput)
```

Diagnostics look OK.

```{r}
L_m5$frame %>% map_dbl(mean)

nd <- expand_grid(seeds.WALD = 0, age = 0, bio01 = 0, bio19 = 0, relelev = 0,
                  cultivated = c(0,1), disturbed = c(0,1), T32 = c(0,1), 
                  fen = c(0,1), T34 = c(0,1), T1 = c(0,1), T17 = c(0,1), 
                  locality = NA_real_) %>% 
  mutate(sum = cultivated + disturbed + T32 + fen + T34 + T1 + T17) %>% 
  filter(sum %in% c(0,1)) %>% 
  select(-sum)

link <- cbind(nd, predict(L_m5, nd, se.fit = TRUE, type = "link")); link
resp <- cbind(nd, predict(L_m5, nd, se.fit = TRUE, type = "response")); resp
cond <- cbind(nd, predict(L_m5, nd, se.fit = TRUE, type = "conditional")); cond

ndz1 <- expand_grid(seeds.WALD = -1, age = -1, bio01 = -1, bio19 = -1, relelev = -1,
                      cultivated = c(0,1), disturbed = c(0,1), T32 = c(0,1), 
                      fen = c(0,1), T34 = c(0,1), T1 = c(0,1), T17 = c(0,1), 
                      locality = NA_real_) %>% 
  mutate(sum = cultivated + disturbed + T32 + fen + T34 + T1 + T17) %>% 
  filter(sum %in% c(0,1)) %>% 
  select(-sum) 
condz1 <- cbind(ndz1, predict(L_m5, ndz1, se.fit = TRUE, type = "conditional")); condz1

cond <- mutate(cond, NiN = c('T4','T17','T1','T34','fen','T32','disturbed','cultivated'))
condz1 <- mutate(condz1, NiN = c('T4','T17','T1','T34','fen','T32','disturbed','cultivated'))

ggplot(cond, aes(NiN, fit)) + geom_linerange(mapping = aes(ymin = fit - se.fit/2, ymax = fit + se.fit/2)) + scale_y_log10()
ggplot(condz1, aes(NiN, fit)) + geom_linerange(mapping = aes(ymin = fit - se.fit/2, ymax = fit + se.fit/2)) + scale_y_log10()

ggplot(cond, aes(NiN, fit)) + geom_linerange(mapping = aes(ymin = fit - se.fit, ymax = fit + se.fit)) + scale_y_log10()
```

Note: ratios of resp estimates are identical to ratios of cond estimates

# P.abies

```{r}
Pa_dat <- datlist$P.abies %>% 
  psycho::standardize(subset = list("seeds.WALD","seeds.ExP","age",
                                    "bio01","bio19","relelev"))
str(Pa_dat)
paste(names(Pa_dat), collapse = " + ")
```

Perfectly separated: T6, spring, T31, T2

```{r}
Pa_f1 <- formula("wildlings ~ seeds.WALD + age + bio01 + bio19 + relelev + cultivated + disturbed + T32 + fen + T4 + T1 + swamp + bog + (1 | locality)")
Pa_m1 <- glmmTMB(Pa_f1, Pa_dat, family = "nbinom2", ziformula = ~1, verbose = TRUE)
summary(Pa_m1)
```

```{r}
Pa_fzi2 <- formula("~ age")
Pa_m2 <- glmmTMB(Pa_f1, Pa_dat, family = "nbinom2", ziformula = Pa_fzi2, verbose = TRUE)
summary(Pa_m2)
ranef(Pa_m2)

bbmle::AICtab(Pa_m1, Pa_m2)
```

```{r}
simulationOutput <- simulateResiduals(fittedModel = Pa_m2)
plot(simulationOutput) # Highest predicted values (from ~90th percentile)
testDispersion(simulationOutput)
testZeroInflation(simulationOutput)
```

The model's highest predicted values (from ~90th percentile and up) tend to underestimate the observed values --- but not to a degree that look egregious. 

Could this be due to spatial autocorrelation at a scale smaller than the minimum polygon size?

# P.contorta

```{r}
Pc_dat <- datlist$P.contorta %>% 
  psycho::standardize(subset = list("seeds.WALD","seeds.ExP","age",
                                    "bio01","bio19","relelev"))
str(Pc_dat)
paste(names(Pc_dat)[map_lgl(Pc_dat, ~ !all(is.na(.)))], collapse = " + ")
```

Perfectly separated: cultivated, T27, T32

```{r}
Pc_f1 <- formula("wildlings ~ seeds.WALD + age + bio01 + bio19 + relelev + disturbed + fen + T34 + T4 + T1 + swamp + T30 + bog + (1 | locality)")
Pc_m1 <- glmmTMB(Pc_f1, Pc_dat, family = "nbinom2", ziformula = ~1, verbose = TRUE)
summary(Pc_m1)
```


# P.sitchensis


```{r sessionInfo}
sessionInfo()
```