---
title: "Modeling relative establishment probability"
output: 
  html_document:
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, error=TRUE)
```

```{r}
library(here)
library(tidyverse)
source(here("R","functions.R"))
library(glmmTMB)
library(DHARMa)
library(furrr)
```

# Load data

```{r}
types <- read_csv(here('data','types.csv'))
contrasttype <- "T4"
contrasthgtclass <- 2
nottypes <- c('species', 'locality','wildlings','age','bio01','bio19',
              'seeds.ExP','seeds.WALD','relelev','geometry','are')
```


```{r}
IV <- readRDS(here("output","independentVars.rds")) %>% 
  st_as_sf()
IV <- IV %>% 
  filter(`plantation forest` < 0.5) %>% 
  select(-`plantation forest`) %>% 
  rowwise() %>% 
  mutate(are = sum(c_across(any_of(types$type)))) %>% 
  filter(are >= 0.5) %>% 
  ungroup()
filter(IV, are > 1.01)
filter(IV, T4 > 0.5) %>%
  select(species, are, any_of(types$type)) %>% 
  group_split(species)
IV <- select(IV, -are)

DV <- readRDS(here("output","dependentVar.rds"))
nrseeds <- length(unique(DV$randomseed))
nrhgtclasses <- length(unique(DV$hgtclass))

DV %>% 
  filter(randomseed == 1) %>% 
  group_split(species) %>% 
  map2(group_split(IV, species), ~ add_wildlings(.y,.x)) %>% 
  bind_rows() %>% 
  st_drop_geometry() %>% 
  group_by(species) %>% 
  summarize(per.are = mean(wildlings)) %>% 
  mutate(per.hectare = per.are * 100) # overall wildlings per hectare
```

```{r}
IV <- IV %>% 
  group_split(species) %>% 
  map(~ mutate(., 
               across(c(age,bio01,bio19,relelev), ~ as.vector(scale(.))),
               across(c(seeds.ExP,seeds.WALD), ~ as.vector(scale(log(.), scale = FALSE))))) %>% 
  bind_rows()
```

# P.sitchensis-lutzii

```{r}
IVi <- filter(IV, species == "P.sitchensis-lutzii") %>% 
  remove_zero_cols()
summary(IVi)
typenames <- names(IVi)[!names(IVi) %in% nottypes]

DVi <- filter(DV, species == "P.sitchensis-lutzii")
```

## Wildling densities

Disregards height classes.

```{r}
dat <- add_wildlings(IVi, filter(DVi, randomseed == 1)) %>% 
  st_drop_geometry()

Ps_densities <- pivot_longer(dat, one_of(typenames), names_to = "nin", values_to = "are") %>%
  group_by(nin) %>% 
  summarize(daa = sum(are)/10, # units from are to decare
            n = sum(wildlings*are), .groups = "drop_last") %>% 
  mutate(density = n/daa) %>%
  arrange(desc(density), desc(n), daa)
scaler <- filter(Ps_densities, nin == contrasttype) %>% 
  pull(density)
Ps_densities <- mutate(Ps_densities, fit = density/scaler)
```

```{r, echo=FALSE, results='asis'}
knitr::kable(Ps_densities, digits = 1)
```

## Height-blind model

Disregards height classes.

Comparing:

1. distribution family (poisson vs. negative binomial vs. generalized poisson)
2. dispersal predictor (seeds.WALD vs. seeds.ExP vs null)

```{r}
modeltypes <- typenames[!(typenames %in% c(contrasttype, identify_completeseparation(dat, typenames)))]
modellocalities <- c(NA, unique(pull(dat, locality)))
newdat <- rbind(0, diag(length(modeltypes))) %>% 
  as_tibble(.name_repair = "minimal") %>% 
  set_names(modeltypes) %>% 
  mutate(nin = c(contrasttype, modeltypes), .before = 1) %>% 
  slice(rep(1:n(), each = length(modellocalities))) %>% 
  mutate(locality = rep(modellocalities, length(c(contrasttype, modeltypes))),
         age = 0, bio01 = 0, bio19 = 0, seeds.ExP = 0, seeds.WALD = 0, relelev = 0,
         .before = 1)
```

### distribution family

```{r}
mf <- paste_modelformula(dat, typenames, contrasttype)
m.poissonWALD <- glmmTMB(mf, dat, offset = seeds.WALD, family = "poisson", 
                         ziformula = ~ age + (1 | locality))
summary(m.poissonWALD)
simulationOutput <- simulateResiduals(fittedModel = m.poissonWALD)
testDispersion(simulationOutput)

m.nbinom2WALD <- glmmTMB(mf, dat, offset = seeds.WALD, family = "nbinom2",
                         ziformula = ~ age + (1 | locality))
summary(m.nbinom2WALD) 
simulationOutput <- simulateResiduals(fittedModel = m.nbinom2WALD)
testDispersion(simulationOutput) 

m.genpoisWALD <- glmmTMB(mf, dat, offset = seeds.WALD, family = "genpois",
                         ziformula = ~ age + (1 | locality))
summary(m.genpoisWALD) 
simulationOutput <- simulateResiduals(fittedModel = m.genpoisWALD)
testDispersion(simulationOutput)
```

### dispersal predictor

```{r}
m.genpoisExP <- glmmTMB(mf, dat, offset = seeds.ExP, family = "genpois",
                        ziformula = ~ age + (1 | locality))
summary(m.genpoisExP)

m.genpoisNULL <- glmmTMB(mf, dat, offset = NULL, family = "genpois",
                         ziformula = ~ age + (1 | locality))
summary(m.genpoisNULL)
```

```{r, include=FALSE}
Ps_dispersalcomp <- bbmle::ICtab(m.genpoisWALD, m.genpoisNULL, base = TRUE, 
                                 delta = TRUE, sort = FALSE) %>% 
  as_tibble() %>% 
  add_column(`seed dispersal estimate` = c('WALD', 'none'), .before = 1) %>% 
  add_row(`seed dispersal estimate` = 'ExP', AIC = NA, dAIC = NA, df = NA, .before = 2) 
```

### Residual diagnostics + predictions

```{r}
simulationOutput <- simulateResiduals(fittedModel = m.genpoisWALD)
plot(simulationOutput)
testZeroInflation(simulationOutput)
```

```{r}
Ps_link <- newdat %>% 
  bind_cols(predict(m.genpoisWALD, newdat, se.fit = TRUE, type = "link")) %>% 
  select(locality, fit, se.fit, nin)
```

```{r, include=FALSE}
sensmod <- update(m.genpoisWALD, 
                  update.formula(formula(m.genpoisWALD), ~ . + seeds.WALD), 
                  offset = NULL)
newdat <- filter(newdat, is.na(locality))
Ps_cond_sens <- newdat %>% 
  mutate(fit = predict(sensmod, newdat, se.fit = FALSE, type = "conditional")) %>% 
  select(nin, fit)
```

### Types-only null model

```{r}
mf <- formula(paste("wildlings ~", paste(modeltypes, collapse = " + ")))
m.typesonly <- glmmTMB(mf, dat, offset = NULL, family = "genpois",
                       ziformula = ~ age + (1 | locality))
summary(m.typesonly)
```

## Height-stratified models

```{r}
stratified <- DVi %>% 
  select(species, randomseed, hgtclass) %>% 
  nest(dv = geometry) %>% 
  mutate(data = map(dv, ~ add_wildlings(IVi, .))) %>%
  mutate(data = map(data, st_drop_geometry)) %>% 
  select(-dv)

possibly_fit <- possibly(fit_genpoisWALDmodel, otherwise = NA)
plan(multisession, workers = availableCores()-1)
stratified <- stratified %>% 
  mutate(model = future_map(data, ~ possibly_fit(., typenames, contrasttype)))

newdat <- filter(newdat, is.na(locality))
stratified <- stratified %>% 
  filter(!is.na(model)) %>% 
  mutate(preds = future_map(model, ~ predict(., newdat, se.fit = TRUE, type = "link"))) %>% 
  mutate(preds = map(preds, ~ bind_cols(., select(newdat, locality, nin))))

Ps_stratified <- stratified
```

```{r}
rm(m.poissonWALD, m.nbinom2WALD, m.genpoisWALD, m.genpoisExP, m.genpoisNULL,
   stratified)
```

# P.abies

```{r}
IVi <- filter(IV, species == "P.abies") %>% 
  remove_zero_cols()
summary(IVi)
typenames <- names(IVi)[!names(IVi) %in% nottypes]

DVi <- filter(DV, species == "P.abies")
```

## Wildling densities

Disregards height classes.

```{r}
dat <- add_wildlings(IVi, filter(DVi, randomseed == 1)) %>% 
  st_drop_geometry()

Pa_densities <- pivot_longer(dat, one_of(typenames), names_to = "nin", values_to = "are") %>%
  group_by(nin) %>% 
  summarize(daa = sum(are)/10, # units from are to decare
            n = sum(wildlings*are), .groups = "drop_last") %>% 
  mutate(density = n/daa) %>%
  arrange(desc(density), desc(n), daa)
scaler <- filter(Pa_densities, nin == contrasttype) %>% 
  pull(density)
Pa_densities <- mutate(Pa_densities, fit = density/scaler)
```

```{r, echo=FALSE, results='asis'}
knitr::kable(Pa_densities, digits = 1)
```

## Height-blind model

Disregards height classes.

Comparing:

1. distribution family (poisson vs. negative binomial vs. generalized poisson)
2. dispersal predictor (seeds.WALD vs. seeds.ExP vs null)

```{r}
modeltypes <- typenames[!(typenames %in% c(contrasttype, identify_completeseparation(dat, typenames)))]
modellocalities <- c(NA, unique(pull(dat, locality)))
newdat <- rbind(0, diag(length(modeltypes))) %>% 
  as_tibble(.name_repair = "minimal") %>% 
  set_names(modeltypes) %>% 
  mutate(nin = c(contrasttype, modeltypes), .before = 1) %>% 
  slice(rep(1:n(), each = length(modellocalities))) %>% 
  mutate(locality = rep(modellocalities, length(c(contrasttype, modeltypes))),
         age = 0, bio01 = 0, bio19 = 0, seeds.ExP = 0, seeds.WALD = 0, relelev = 0,
         .before = 1)
```

### distribution family

```{r}
mf <- paste_modelformula(dat, typenames, contrasttype)
m.poissonWALD <- glmmTMB(mf, dat, offset = seeds.WALD, family = "poisson", 
                         ziformula = ~ age + (1 | locality))
summary(m.poissonWALD)
simulationOutput <- simulateResiduals(fittedModel = m.poissonWALD)
testDispersion(simulationOutput)

m.nbinom2WALD <- glmmTMB(mf, dat, offset = seeds.WALD, family = "nbinom2",
                         ziformula = ~ age + (1 | locality))
summary(m.nbinom2WALD)
simulationOutput <- simulateResiduals(fittedModel = m.nbinom2WALD)
testDispersion(simulationOutput) 

m.genpoisWALD <- glmmTMB(mf, dat, offset = seeds.WALD, family = "genpois",
                         ziformula = ~ age + (1 | locality))
summary(m.genpoisWALD) 
simulationOutput <- simulateResiduals(fittedModel = m.genpoisWALD)
testDispersion(simulationOutput) 
```

### dispersal predictor

```{r}
m.genpoisExP <- glmmTMB(mf, dat, offset = seeds.ExP, family = "genpois",
                        ziformula = ~ age + (1 | locality))
summary(m.genpoisExP)

m.genpoisNULL <- glmmTMB(mf, dat, offset = NULL, family = "genpois",
                         ziformula = ~ age + (1 | locality))
summary(m.genpoisNULL)
```

```{r, include=FALSE}
Pa_dispersalcomp <- bbmle::ICtab(m.genpoisWALD, m.genpoisNULL, base = TRUE, 
                                 delta = TRUE, sort = FALSE) %>% 
  as_tibble() %>% 
  add_column(`seed dispersal estimate` = c('WALD', 'none'), .before = 1) %>% 
  add_row(`seed dispersal estimate` = 'ExP', AIC = NA, dAIC = NA, df = NA, .before = 2) 
```

### Residual diagnostics + predictions

```{r}
simulationOutput <- simulateResiduals(fittedModel = m.genpoisWALD)
plot(simulationOutput)
testZeroInflation(simulationOutput)
```

```{r}
Pa_link <- newdat %>% 
  bind_cols(predict(m.genpoisWALD, newdat, se.fit = TRUE, type = "link")) %>% 
  select(locality, fit, se.fit, nin)
```

```{r, include=FALSE}
sensmod <- update(m.genpoisWALD, 
                  update.formula(formula(m.genpoisWALD), ~ . + seeds.WALD), 
                  offset = NULL)
newdat <- filter(newdat, is.na(locality))
Pa_cond_sens <- newdat %>% 
  mutate(fit = predict(sensmod, newdat, se.fit = FALSE, type = "conditional")) %>% 
  select(nin, fit)
```

### Types-only null model

```{r}
mf <- formula(paste("wildlings ~", paste(modeltypes, collapse = " + ")))
m.typesonly <- glmmTMB(mf, dat, offset = NULL, family = "genpois",
                       ziformula = ~ age + (1 | locality))
summary(m.typesonly)
```

## Height-stratified models

```{r}
stratified <- DVi %>% 
  select(species, randomseed, hgtclass) %>% 
  nest(dv = geometry) %>% 
  mutate(data = map(dv, ~ add_wildlings(IVi, .))) %>%
  mutate(data = map(data, st_drop_geometry)) %>% 
  select(-dv)

possibly_fit <- possibly(fit_genpoisWALDmodel, otherwise = NA)
plan(multisession, workers = availableCores()-1)
stratified <- stratified %>% 
  mutate(model = future_map(data, ~ possibly_fit(., typenames, contrasttype)))

newdat <- filter(newdat, is.na(locality))
stratified <- stratified %>% 
  filter(!is.na(model)) %>% 
  mutate(preds = future_map(model, ~ predict(., newdat, se.fit = TRUE, type = "link"))) %>% 
  mutate(preds = map(preds, ~ bind_cols(., select(newdat, locality, nin))))

Pa_stratified <- stratified
```

```{r}
rm(m.poissonWALD, m.nbinom2WALD, m.genpoisWALD, m.genpoisExP, m.genpoisNULL,
   stratified)
```

# Larix

```{r}
IVi <- filter(IV, species == "Larix") %>% 
  remove_zero_cols()
summary(IVi)
typenames <- names(IVi)[!names(IVi) %in% nottypes]

DVi <- filter(DV, species == "Larix")
```

## Wildling densities

Disregards height classes.

```{r}
dat <- add_wildlings(IVi, filter(DVi, randomseed == 1)) %>% 
  st_drop_geometry()

L_densities <- pivot_longer(dat, one_of(typenames), names_to = "nin", values_to = "are") %>%
  group_by(nin) %>% 
  summarize(daa = sum(are)/10, # units from are to decare
            n = sum(wildlings*are), .groups = "drop_last") %>% 
  mutate(density = n/daa) %>%
  arrange(desc(density), desc(n), daa)
scaler <- filter(L_densities, nin == contrasttype) %>% 
  pull(density)
L_densities <- mutate(L_densities, fit = density/scaler)
```

```{r, echo=FALSE, results='asis'}
knitr::kable(L_densities, digits = 1)
```

## Height-blind model

Disregards height classes.

Comparing:

1. distribution family (poisson vs. negative binomial vs. generalized poisson)
2. dispersal predictor (seeds.WALD vs. seeds.ExP vs null)

```{r}
modeltypes <- typenames[!(typenames %in% c(contrasttype, identify_completeseparation(dat, typenames)))]
modellocalities <- c(NA, unique(pull(dat, locality)))
newdat <- rbind(0, diag(length(modeltypes))) %>% 
  as_tibble(.name_repair = "minimal") %>% 
  set_names(modeltypes) %>% 
  mutate(nin = c(contrasttype, modeltypes), .before = 1) %>% 
  slice(rep(1:n(), each = length(modellocalities))) %>% 
  mutate(locality = rep(modellocalities, length(c(contrasttype, modeltypes))),
         age = 0, bio01 = 0, bio19 = 0, seeds.ExP = 0, seeds.WALD = 0, relelev = 0,
         .before = 1)
```

### distribution family

```{r}
mf <- paste_modelformula(dat, typenames, contrasttype)
m.poissonWALD <- glmmTMB(mf, dat, offset = seeds.WALD, family = "poisson", 
                         ziformula = ~ age + (1 | locality))
summary(m.poissonWALD)
simulationOutput <- simulateResiduals(fittedModel = m.poissonWALD)
testDispersion(simulationOutput)

m.nbinom2WALD <- glmmTMB(mf, dat, offset = seeds.WALD, family = "nbinom2",
                         ziformula = ~ age + (1 | locality))
summary(m.nbinom2WALD)
simulationOutput <- simulateResiduals(fittedModel = m.nbinom2WALD)
testDispersion(simulationOutput)

m.genpoisWALD <- glmmTMB(mf, dat, offset = seeds.WALD, family = "genpois",
                         ziformula = ~ age + (1 | locality))
summary(m.genpoisWALD)
simulationOutput <- simulateResiduals(fittedModel = m.genpoisWALD)
testDispersion(simulationOutput) 
```

### dispersal predictor

```{r}
m.genpoisExP <- glmmTMB(mf, dat, offset = seeds.ExP, family = "genpois",
                        ziformula = ~ age + (1 | locality))
summary(m.genpoisExP)

m.genpoisNULL <- glmmTMB(mf, dat, offset = NULL, family = "genpois",
                        ziformula = ~ age + (1 | locality))
summary(m.genpoisNULL)
```

```{r, include=FALSE}
L_dispersalcomp <- bbmle::ICtab(m.genpoisWALD, m.genpoisExP, base = TRUE, 
                                delta = TRUE, sort = FALSE) %>% 
  as_tibble() %>% 
  add_column(`seed dispersal estimate` = c('WALD', 'ExP'), .before = 1) %>% 
  add_row(`seed dispersal estimate` = 'none', AIC = NA, dAIC = NA, df = NA) 
```

### Residual diagnostics + predictions

```{r}
simulationOutput <- simulateResiduals(fittedModel = m.genpoisWALD)
plot(simulationOutput)
testZeroInflation(simulationOutput)
```

```{r}
L_link <- newdat %>% 
  bind_cols(predict(m.genpoisWALD, newdat, se.fit = TRUE, type = "link")) %>% 
  select(locality, fit, se.fit, nin)
```

```{r, include=FALSE}
sensmod <- update(m.genpoisWALD, 
                  update.formula(formula(m.genpoisWALD), ~ . + seeds.WALD), 
                  offset = NULL)
newdat <- filter(newdat, is.na(locality))
L_cond_sens <- newdat %>% 
  mutate(fit = predict(sensmod, newdat, se.fit = FALSE, type = "conditional")) %>% 
  select(nin, fit)
```

### Types-only null model

```{r}
mf <- formula(paste("wildlings ~", paste(modeltypes, collapse = " + ")))
m.typesonly <- glmmTMB(mf, dat, offset = NULL, family = "genpois",
                       ziformula = ~ age + (1 | locality))
summary(m.typesonly)
```

## Height-stratified models

```{r}
stratified <- DVi %>% 
  select(species, randomseed, hgtclass) %>% 
  nest(dv = geometry) %>% 
  mutate(data = map(dv, ~ add_wildlings(IVi, .))) %>%
  mutate(data = map(data, st_drop_geometry)) %>% 
  select(-dv)

possibly_fit <- possibly(fit_genpoisWALDmodel, otherwise = NA)
plan(multisession, workers = availableCores()-1)
stratified <- stratified %>% 
  mutate(model = future_map(data, ~ possibly_fit(., typenames, contrasttype)))

newdat <- filter(newdat, is.na(locality))
stratified <- stratified %>% 
  filter(!is.na(model)) %>% 
  mutate(preds = future_map(model, ~ predict(., newdat, se.fit = TRUE, type = "link"))) %>% 
  mutate(preds = map(preds, ~ bind_cols(., select(newdat, locality, nin))))

L_stratified <- stratified
```

```{r}
rm(m.poissonWALD, m.nbinom2WALD, m.genpoisWALD, m.genpoisExP, m.genpoisNULL,
   stratified)
```

# All species

```{r}
species <- c("P.sitchensis-lutzii", "P.abies", "Larix")

list(Ps_densities, Pa_densities, L_densities) %>% 
  set_names(species) %>% 
  bind_rows(.id = "species") %>% 
  saveRDS(here("output","results-densities.rds"))

list(Ps_dispersalcomp, Pa_dispersalcomp, L_dispersalcomp) %>% 
  set_names(species) %>% 
  saveRDS(here("output","results-dispersalcomparison.rds"))

list(Ps_link, Pa_link, L_link) %>% 
  set_names(species) %>% 
  bind_rows(.id = "species") %>% 
  nest(preds = c(locality, nin, fit, se.fit)) %>% 
  bind_rows(Ps_stratified, Pa_stratified, L_stratified) %>%
  mutate(preds = map(preds, function(x) {
    x <- mutate(x, ci.l = fit - 1.96*se.fit, ci.u = fit + 1.96*se.fit) %>% 
      mutate(across(c('fit', 'ci.l', 'ci.u'), ~ exp(.))) %>% 
      select(-se.fit) 
    scaler <- filter(x, nin == contrasttype, is.na(locality)) %>% 
      pull(fit)
    mutate(x, across(c('fit', 'ci.l', 'ci.u'), ~ `/`(., scaler)))
  })) %>%
  saveRDS(here("output","results-models.rds"))
```

```{r, include=FALSE}
pred_sens.tbl <- list(Ps_cond_sens, Pa_cond_sens, L_cond_sens) %>% 
  set_names(species) %>% 
  bind_rows(.id = "species") %>% 
  group_by(species) %>% 
  group_split(.keep = TRUE) %>% 
  map(function(x) {
    scaler <- filter(x, nin == contrasttype) %>% 
      pull(fit)
    mutate(x, fit = fit/scaler)
  }) %>% 
  bind_rows()

saveRDS(pred_sens.tbl, here("output","results-sensitivity-offsetting.rds"))
```

```{r sessionInfo}
sessionInfo()
```
