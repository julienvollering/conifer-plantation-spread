---
title: "Modeling relative establishment probability"
output: 
  html_document:
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(here)
library(tidyverse)
source(here("R","functions-createVars.R"))
library(glmmTMB)
library(DHARMa)
library(furrr)
```

# Load data

```{r}
IV <- readRDS(here("output","independentVars.rds")) %>% 
  st_as_sf()
IV <- IV %>% 
  filter(`plantation forest` < 0.5) %>% 
  select(-`plantation forest`)
DV <- readRDS(here("output","dependentVar.rds"))

types <- read_csv(here('data','types.csv'))
contrasttype <- "T4"
contrasthgtclass <- 3
nottypes <- c('species', 'locality','wildlings','age','bio01','bio19',
              'seeds.ExP','seeds.WALD','relelev','geometry')

DV %>% 
  filter(randomseed == 1) %>% 
  group_split(species) %>% 
  map2(group_split(IV, species), ~ add_wildlings(.y,.x)) %>% 
  bind_rows() %>% 
  st_drop_geometry() %>% 
  group_by(species) %>% 
  summarize(per.are = mean(wildlings)) %>% 
  mutate(per.hectare = per.are * 100) # overall wildlings per hectare
```

# P.sitchensis-lutzii

```{r}
IVi <- filter(IV, species == "P.sitchensis-lutzii") %>% 
  remove_zero_cols() %>% 
  mutate(across(c(age,bio01,bio19,relelev), ~ as.vector(scale(.))),
         across(c(seeds.ExP,seeds.WALD), ~ as.vector(scale(log(.), scale = FALSE))))
summary(IVi)
typenames <- names(IVi)[!names(IVi) %in% nottypes]

DVi <- filter(DV, species == "P.sitchensis-lutzii")
```

## Wildling densities

```{r}
dat <- DVi %>% 
  filter(randomseed == 1) %>% 
  group_split(hgtclass) %>% 
  map(~ add_wildlings(IVi, .) %>% 
        st_drop_geometry()) %>% 
  set_names(1:3) %>% 
  bind_rows(.id = "hgtclass")

Ps_arith <- pivot_longer(dat, one_of(typenames), names_to = "nin", values_to = "are") %>%
  group_by(hgtclass, nin) %>% 
  summarize(daa = sum(are)/10, # units from are to decare
            n = sum(wildlings*are), .groups = "drop_last") %>% 
  mutate(density = n/daa) %>%
  arrange(hgtclass, desc(density), desc(n), daa)
scaler <- filter(Ps_arith, nin == contrasttype, hgtclass == contrasthgtclass) %>% 
  pull(density)
Ps_arith <- mutate(Ps_arith, fit = density/scaler)
```

```{r, echo=FALSE, results='asis'}
knitr::kable(Ps_arith, digits = 1)
```

## Pilot model

Disregards height classes.

For choosing:
1. poisson vs. negative binomial vs. generalized poisson
2. seeds.ExP vs. seeds.WALD

```{r}
dat <- add_wildlings(IVi, filter(DVi, randomseed == 1)) %>% 
  st_drop_geometry()

modeltypes <- typenames[!(typenames %in% identify_completeseparation(dat, typenames))]
modellocalities <- unique(pull(dat, locality))
newdat <- diag(length(modeltypes)) %>% 
  as_tibble(.name_repair = "minimal") %>% 
  set_names(modeltypes) %>% 
  slice(rep(1:n(), each = length(modellocalities))) %>% 
  mutate(locality = rep(modellocalities, length(modeltypes)),
         age = 0, bio01 = 0, bio19 = 0, seeds.ExP = 0, seeds.WALD = 0, relelev = 0,
         .before = 1)
```

```{r}
mf <- paste_modelformula(dat, typenames)
m.poissonWALD <- glmmTMB(mf, dat, offset = seeds.WALD, family = "poisson", 
                         ziformula = ~ age + (1 | locality))
simulationOutput <- simulateResiduals(fittedModel = m.poissonWALD)
testDispersion(simulationOutput) #dispersion = 0.004407, p-value = 0.024

m.nbinom2WALD <- update(m.poissonWALD, family = "nbinom2")
summary(m.nbinom2WALD) #Dispersion parameter for nbinom2 family (): 0.274 
simulationOutput <- simulateResiduals(fittedModel = m.nbinom2WALD)
testDispersion(simulationOutput) #dispersion = 0.00039592, p-value < 2.2e-16

m.genpoisWALD <- update(m.poissonWALD, family = "genpois")
summary(m.genpoisWALD) #Dispersion parameter for genpois family (): 7.75
simulationOutput <- simulateResiduals(fittedModel = m.genpoisWALD)
testDispersion(simulationOutput) #dispersion = 0.066341, p-value = 0.136
```

Support for generalized Poisson family.

```{r}
m.genpoisExP <- update(m.genpoisWALD, offset = seeds.ExP)
# Error in optimHess(par.fixed, obj$fn, obj$gr) : 
#   gradient in optim evaluated to length 1 not 37
m.genpoisNULL <- update(m.genpoisWALD, offset = NULL)
```

```{r, include=FALSE}
Ps_modelcomp <- bbmle::ICtab(m.genpoisWALD, m.genpoisNULL, base = TRUE, 
                             delta = TRUE, sort = FALSE) %>% 
  as_tibble() %>% 
  add_column(`seed dispersal estimate` = c('WALD', 'none'), .before = 1) %>% 
  add_row(`seed dispersal estimate` = 'ExP', AIC = NA, dAIC = NA, df = NA, .before = 2) 
```

Support for seeds.WALD.

### Residual diagnostics

```{r}
simulationOutput <- simulateResiduals(fittedModel = m.genpoisWALD)
plot(simulationOutput)
testZeroInflation(simulationOutput)
```

### Model predictions

```{r}
Ps_link <- bind_cols(newdat, predict(m.genpoisWALD, newdat, se.fit = TRUE, type = "link"))
```

## Height-stratified models

```{r}
dat <- DVi %>% 
  group_split(randomseed, hgtclass) %>% 
  map(~ add_wildlings(IVi, .) %>% 
        st_drop_geometry())
newdat <- newdat %>% 
  mutate(locality = NA) %>% 
  distinct()
  
safe_predict <- safely(predict_from_genpoisWALDmodel)
plan(multisession, workers = availableCores()-1)
tictoc::tic()
res <- dat %>% 
  future_map(~ safe_predict(., newdat, typenames))
tictoc::toc()
saveRDS(res, here("output","res-temp.rds"))

modres <- transpose(res)$result
```



## Interpret relative establishment probability

```{r}
Ps_link <- Ps_link %>% 
  select(nin, locality, fit, se.fit) %>% 
  mutate(ci.l = fit - 1.96*se.fit, ci.u = fit + 1.96*se.fit) %>% 
  select(-se.fit) %>% 
  mutate_at(c('fit', 'ci.l', 'ci.u'), ~ exp(.))
scaler <- filter(Ps_link, is.na(locality), nin == "T4") %>% 
  pull(fit)
Ps_link.scaled <- mutate_at(Ps_link, c('fit', 'ci.l', 'ci.u'), ~ `/`(., scaler))
```

```{r}
Ps_link.scaled %>% 
  filter(is.na(locality), nin %in% filter(Ps_arith.scaled, daa > 10, n > 1)$nin) %>% 
  pull(fit) %>% range() %>% log10() %>% diff()
```

```{r}
filter(Ps_link.scaled, is.na(locality)) %>% 
  ggplot(aes(reorder(nin, fit), fit)) + 
  geom_linerange(mapping = aes(ymin = ci.l, ymax = ci.u)) + 
  geom_point()  + 
  geom_point(data = filter(Ps_arith.scaled, nin %in% Ps_link.scaled$nin), 
             col = "grey", pch = 1) + 
  scale_y_log10() + 
  coord_flip()
```

```{r, include=FALSE}
sensmod <- update(selmod, update.formula(formula(selmod), ~ . + seeds.WALD), offset = NULL)
newdat <- filter(newdat, is.na(locality))
Ps_link_sens <- mutate(newdat, fit = predict(sensmod, newdat, se.fit = FALSE, type = "conditional"))
scaler <- filter(Ps_link_sens, nin == "T4") %>% 
  pull(fit)
Ps_link_sens <- mutate(Ps_link_sens, fit = fit/scaler) %>% 
  select(nin, fit)
```

# P.abies

# Larix

# All species

```{r}
species <- c("P.sitchensis-lutzii", "P.abies", "Larix")

arith.list <- list(Ps_arith.scaled, Pa_arith.scaled, L_arith.scaled)
names(arith.list) <- species

modelcomp.list <- list(Ps_modelcomp, Pa_modelcomp, L_modelcomp)
names(modelcomp.list) <- species

link.list <- list(Ps_link.scaled, Pa_link.scaled, L_link.scaled)
names(link.list) <- species

results <- list(arithmetic = arith.list, 
                model.comp = modelcomp.list,
                model.preds = link.list)
str(results, 2)
saveRDS(results, here("output","results.rds"))
```

```{r, include=FALSE}
link_sens.list <- list(Ps_link_sens, Pa_link_sens, L_link_sens)
names(link_sens.list) <- species
saveRDS(link_sens.list, here("output","results-sensitivity.rds"))
```

```{r sessionInfo}
sessionInfo()
```
