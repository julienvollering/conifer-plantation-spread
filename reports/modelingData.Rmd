---
title: "Modeling relative establishment probability"
output: 
  html_document:
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, error=TRUE)
```

```{r}
library(here)
library(tidyverse)
source(here("R","functions.R"))
library(glmmTMB)
library(DHARMa)
library(furrr)
```

# Load data

```{r}
IV <- readRDS(here("output","independentVars.rds")) %>% 
  st_as_sf()
IV <- IV %>% 
  filter(`plantation forest` < 0.5) %>% 
  select(-`plantation forest`)
DV <- readRDS(here("output","dependentVar.rds"))

nrseeds <- length(unique(DV$randomseed))
nrhgtclasses <- length(unique(DV$hgtclass))
types <- read_csv(here('data','types.csv'))
contrasttype <- "T4"
contrasthgtclass <- 2
nottypes <- c('species', 'locality','wildlings','age','bio01','bio19',
              'seeds.ExP','seeds.WALD','relelev','geometry')

DV %>% 
  filter(randomseed == 1) %>% 
  group_split(species) %>% 
  map2(group_split(IV, species), ~ add_wildlings(.y,.x)) %>% 
  bind_rows() %>% 
  st_drop_geometry() %>% 
  group_by(species) %>% 
  summarize(per.are = mean(wildlings)) %>% 
  mutate(per.hectare = per.are * 100) # overall wildlings per hectare
```

```{r}
IV <- IV %>% 
  group_split(species) %>% 
  map(~ mutate(., 
               across(c(age,bio01,bio19,relelev), ~ as.vector(scale(.))),
               across(c(seeds.ExP,seeds.WALD), ~ as.vector(scale(log(.), scale = FALSE))))) %>% 
  bind_rows()
```

# P.sitchensis-lutzii

```{r}
IVi <- filter(IV, species == "P.sitchensis-lutzii") %>% 
  remove_zero_cols()
summary(IVi)
typenames <- names(IVi)[!names(IVi) %in% nottypes]

DVi <- filter(DV, species == "P.sitchensis-lutzii")
```

## Wildling densities

Disregards height classes.

```{r}
dat <- add_wildlings(IVi, filter(DVi, randomseed == 1)) %>% 
  st_drop_geometry()

Ps_arith <- pivot_longer(dat, one_of(typenames), names_to = "nin", values_to = "are") %>%
  group_by(nin) %>% 
  summarize(daa = sum(are)/10, # units from are to decare
            n = sum(wildlings*are), .groups = "drop_last") %>% 
  mutate(density = n/daa) %>%
  arrange(desc(density), desc(n), daa)
scaler <- filter(Ps_arith, nin == contrasttype) %>% 
  pull(density)
Ps_arith <- mutate(Ps_arith, fit = density/scaler)
```

```{r, echo=FALSE, results='asis'}
knitr::kable(Ps_arith, digits = 1)
```

## Height-blind model

Disregards height classes.

For choosing:
1. poisson vs. negative binomial vs. generalized poisson
2. seeds.ExP vs. seeds.WALD

```{r}
modeltypes <- typenames[!(typenames %in% identify_completeseparation(dat, typenames))]
modellocalities <- c(NA, unique(pull(dat, locality)))
newdat <- diag(length(modeltypes)) %>% 
  as_tibble(.name_repair = "minimal") %>% 
  set_names(modeltypes) %>% 
  mutate(nin = modeltypes, .before = 1) %>% 
  slice(rep(1:n(), each = length(modellocalities))) %>% 
  mutate(locality = rep(modellocalities, length(modeltypes)),
         age = 0, bio01 = 0, bio19 = 0, seeds.ExP = 0, seeds.WALD = 0, relelev = 0,
         .before = 1)
```

```{r}
mf <- paste_modelformula(dat, typenames)
m.poissonWALD <- glmmTMB(mf, dat, offset = seeds.WALD, family = "poisson", 
                         ziformula = ~ age + (1 | locality))
summary(m.poissonWALD)
simulationOutput <- simulateResiduals(fittedModel = m.poissonWALD)
testDispersion(simulationOutput) #dispersion = 0.004407, p-value = 0.024

m.nbinom2WALD <- glmmTMB(mf, dat, offset = seeds.WALD, family = "nbinom2",
                         ziformula = ~ age + (1 | locality))
summary(m.nbinom2WALD) #Dispersion parameter for nbinom2 family (): 0.274 
simulationOutput <- simulateResiduals(fittedModel = m.nbinom2WALD)
testDispersion(simulationOutput) #dispersion = 0.00039592, p-value < 2.2e-16

m.genpoisWALD <- glmmTMB(mf, dat, offset = seeds.WALD, family = "genpois",
                         ziformula = ~ age + (1 | locality))
summary(m.genpoisWALD) #Dispersion parameter for genpois family (): 7.75
simulationOutput <- simulateResiduals(fittedModel = m.genpoisWALD)
testDispersion(simulationOutput) #dispersion = 0.066341, p-value = 0.136
```

Support for generalized Poisson family.

```{r}
m.genpoisExP <- glmmTMB(mf, dat, offset = seeds.ExP, family = "genpois",
                        ziformula = ~ age + (1 | locality))
summary(m.genpoisExP)

m.genpoisNULL <- glmmTMB(mf, dat, offset = NULL, family = "genpois",
                         ziformula = ~ age + (1 | locality))
summary(m.genpoisNULL)
```

```{r, include=FALSE}
Ps_modelcomp <- bbmle::ICtab(m.genpoisWALD, m.genpoisNULL, base = TRUE, 
                             delta = TRUE, sort = FALSE) %>% 
  as_tibble() %>% 
  add_column(`seed dispersal estimate` = c('WALD', 'none'), .before = 1) %>% 
  add_row(`seed dispersal estimate` = 'ExP', AIC = NA, dAIC = NA, df = NA, .before = 2) 
```

Support for seeds.WALD.

### Residual diagnostics

```{r}
simulationOutput <- simulateResiduals(fittedModel = m.genpoisWALD)
plot(simulationOutput)
testZeroInflation(simulationOutput)
```

### Model predictions

```{r}
Ps_link <- newdat %>% 
  bind_cols(predict(m.genpoisWALD, newdat, se.fit = TRUE, type = "link")) %>% 
  select(locality, fit, se.fit, nin)
```

```{r, include=FALSE}
sensmod <- update(m.genpoisWALD, 
                  update.formula(formula(m.genpoisWALD), ~ . + seeds.WALD), offset = NULL)
newdat <- filter(newdat, is.na(locality))
Ps_link_sens <- newdat %>% 
  mutate(fit = predict(sensmod, newdat, se.fit = FALSE, type = "conditional")) %>% 
  select(nin, fit)
```

## Height-stratified models

```{r}
dat <- DVi %>% 
  group_split(randomseed, hgtclass) %>% 
  map(~ add_wildlings(IVi, .) %>% 
        st_drop_geometry())
newdat <- filter(newdat, is.na(locality))
  
safe_predict <- safely(predict_from_genpoisWALDmodel)
plan(multisession, workers = availableCores()-1)
res <- dat %>% # 3.6 hours for 10 successfully fitted models on 7 workers
  future_map(~ safe_predict(., newdat, typenames))
transpose(res)$error
saveRDS(here('output', 'res-Ps-byheight.rds'))

modres <- transpose(res)$result
for (i in seq_along(modres)) {
  if(!is.null(modres[[i]])) {
    modres[[i]] <- modres[[i]] %>% 
      mutate(randomseed = rep(seq_len(nrseeds), each = nrhgtclasses)[i],
             hgtclass = rep(seq_len(nrhgtclasses), nrseeds)[i], .before = 1)
  }
}
modres <- modres %>% 
  bind_rows() %>% 
  select(randomseed, hgtclass, fit, se.fit, nin)
```

```{r}
Ps_link <- Ps_link %>% 
  bind_rows(modres)
```


```{r, include = FALSE, eval = FALSE}
res <- readRDS(here('output', 'res-temp.rds'))

modres <- transpose(res)$result
for (i in seq_along(modres)) {
  if(!is.null(modres[[i]])) {
    modres[[i]] <- modres[[i]] %>% 
      mutate(randomseed = rep(seq_len(nrseeds), each = nrhgtclasses)[i],
             hgtclass = rep(seq_len(nrhgtclasses), nrseeds)[i], .before = 1)
  }
}
modres <- modres %>% 
  bind_rows() %>% 
  select(randomseed, hgtclass, fit, se.fit, nin)

plotting <- modres %>% 
  mutate(ci.l = fit - 1.96*se.fit, ci.u = fit + 1.96*se.fit) %>% 
  mutate(across(c('fit', 'ci.l', 'ci.u'), ~ exp(.))) %>% 
  select(-se.fit) %>% 
  group_split(randomseed, hgtclass)
plotting <- map(plotting, function(x) {
  scaler <- filter(x, nin == contrasttype) %>% 
    pull(fit)
  mutate(x, across(c('fit', 'ci.l', 'ci.u'), ~ `/`(., scaler)))
})
plotting <- bind_rows(plotting) %>% 
  mutate(across(c('randomseed', 'hgtclass', 'nin'), as_factor))

ggplot(plotting, aes(fit, reorder(nin, fit), color = hgtclass, group = hgtclass)) + 
  geom_linerange(mapping = aes(xmin = ci.l, xmax = ci.u), position = position_dodge(width=0.4)) + 
  geom_point(position = position_dodge(width=0.4))  + 
  scale_x_log10(limits = c(1e-3, 1e3)) +
  facet_grid(cols = vars(randomseed))

#effect of randomseed
filter(plotting, hgtclass == 3) %>% 
  ggplot(aes(fit, reorder(nin, fit), color = randomseed, group = randomseed)) + 
  geom_linerange(mapping = aes(xmin = ci.l, xmax = ci.u), position = position_dodge(width=0.4)) + 
  geom_point(position = position_dodge(width=0.4))  + 
  scale_x_log10(limits = c(1e-3, 1e3))
```

# P.abies

```{r}
IVi <- filter(IV, species == "P.abies") %>% 
  remove_zero_cols()
summary(IVi)
typenames <- names(IVi)[!names(IVi) %in% nottypes]

DVi <- filter(DV, species == "P.abies")
```

## Wildling densities

Disregards height classes.

```{r}
dat <- add_wildlings(IVi, filter(DVi, randomseed == 1)) %>% 
  st_drop_geometry()

Pa_arith <- pivot_longer(dat, one_of(typenames), names_to = "nin", values_to = "are") %>%
  group_by(nin) %>% 
  summarize(daa = sum(are)/10, # units from are to decare
            n = sum(wildlings*are), .groups = "drop_last") %>% 
  mutate(density = n/daa) %>%
  arrange(desc(density), desc(n), daa)
scaler <- filter(Pa_arith, nin == contrasttype) %>% 
  pull(density)
Pa_arith <- mutate(Pa_arith, fit = density/scaler)
```

```{r, echo=FALSE, results='asis'}
knitr::kable(Pa_arith, digits = 1)
```

## Height-blind model

Disregards height classes.

For choosing:
1. poisson vs. negative binomial vs. generalized poisson
2. seeds.ExP vs. seeds.WALD

```{r}
modeltypes <- typenames[!(typenames %in% identify_completeseparation(dat, typenames))]
modellocalities <- c(NA, unique(pull(dat, locality)))
newdat <- diag(length(modeltypes)) %>% 
  as_tibble(.name_repair = "minimal") %>% 
  set_names(modeltypes) %>% 
  mutate(nin = modeltypes, .before = 1) %>% 
  slice(rep(1:n(), each = length(modellocalities))) %>% 
  mutate(locality = rep(modellocalities, length(modeltypes)),
         age = 0, bio01 = 0, bio19 = 0, seeds.ExP = 0, seeds.WALD = 0, relelev = 0,
         .before = 1)
```

```{r}
mf <- paste_modelformula(dat, typenames)
m.poissonWALD <- glmmTMB(mf, dat, offset = seeds.WALD, family = "poisson", 
                         ziformula = ~ age + (1 | locality))
summary(m.poissonWALD)
simulationOutput <- simulateResiduals(fittedModel = m.poissonWALD)
testDispersion(simulationOutput) #dispersion = 0.49281, p-value = 0.416

m.nbinom2WALD <- glmmTMB(mf, dat, offset = seeds.WALD, family = "nbinom2",
                         ziformula = ~ age + (1 | locality))
summary(m.nbinom2WALD)
simulationOutput <- simulateResiduals(fittedModel = m.nbinom2WALD)
testDispersion(simulationOutput) #dispersion = 0.028817, p-value < 2.2e-16

m.genpoisWALD <- glmmTMB(mf, dat, offset = seeds.WALD, family = "genpois",
                         ziformula = ~ age + (1 | locality))
summary(m.genpoisWALD) 
simulationOutput <- simulateResiduals(fittedModel = m.genpoisWALD)
testDispersion(simulationOutput) #dispersion = 0.62164, p-value = 0.424
```

Support for generalized Poisson family.

```{r}
m.genpoisExP <- glmmTMB(mf, dat, offset = seeds.ExP, family = "genpois",
                        ziformula = ~ age + (1 | locality))
summary(m.genpoisExP)

m.genpoisNULL <- glmmTMB(mf, dat, offset = NULL, family = "genpois",
                         ziformula = ~ age + (1 | locality))
summary(m.genpoisNULL)
```

```{r, include=FALSE}
Pa_modelcomp <- bbmle::ICtab(m.genpoisWALD, m.genpoisExP, m.genpoisNULL, 
                             base = TRUE, delta = TRUE, sort = FALSE) %>% 
  as_tibble() %>% 
  add_column(`seed dispersal estimate` = c('WALD', 'ExP', 'none'), .before = 1)
```

Support for seeds.WALD.

### Residual diagnostics

```{r}
simulationOutput <- simulateResiduals(fittedModel = m.genpoisWALD)
plot(simulationOutput)
testZeroInflation(simulationOutput)
```

### Model predictions

```{r}
Pa_link <- newdat %>% 
  bind_cols(predict(m.genpoisWALD, newdat, se.fit = TRUE, type = "link")) %>% 
  select(locality, fit, se.fit, nin)
```

```{r, include=FALSE}
sensmod <- update(m.genpoisWALD, 
                  update.formula(formula(m.genpoisWALD), ~ . + seeds.WALD), offset = NULL)
newdat <- filter(newdat, is.na(locality))
Pa_link_sens <- newdat %>% 
  mutate(fit = predict(sensmod, newdat, se.fit = FALSE, type = "conditional")) %>% 
  select(nin, fit)
```

## Height-stratified models

```{r}
dat <- DVi %>% 
  group_split(randomseed, hgtclass) %>% 
  map(~ add_wildlings(IVi, .) %>% 
        st_drop_geometry())
newdat <- filter(newdat, is.na(locality))
  
safe_predict <- safely(predict_from_genpoisWALDmodel)
plan(multisession, workers = availableCores()-1)
res <- dat %>% # 
  future_map(~ safe_predict(., newdat, typenames))
transpose(res)$error
saveRDS(here('output', 'res-Pa-byheight.rds'))

modres <- transpose(res)$result
for (i in seq_along(modres)) {
  if(!is.null(modres[[i]])) {
    modres[[i]] <- modres[[i]] %>% 
      mutate(randomseed = rep(seq_len(nrseeds), each = nrhgtclasses)[i],
             hgtclass = rep(seq_len(nrhgtclasses), nrseeds)[i], .before = 1)
  }
}
modres <- modres %>% 
  bind_rows() %>% 
  select(randomseed, hgtclass, fit, se.fit, nin)
```

```{r}
Pa_link <- Pa_link %>% 
  bind_rows(modres)
```

# Larix

```{r}
IVi <- filter(IV, species == "Larix") %>% 
  remove_zero_cols()
summary(IVi)
typenames <- names(IVi)[!names(IVi) %in% nottypes]

DVi <- filter(DV, species == "Larix")
```

## Wildling densities

Disregards height classes.

```{r}
dat <- add_wildlings(IVi, filter(DVi, randomseed == 1)) %>% 
  st_drop_geometry()

L_arith <- pivot_longer(dat, one_of(typenames), names_to = "nin", values_to = "are") %>%
  group_by(nin) %>% 
  summarize(daa = sum(are)/10, # units from are to decare
            n = sum(wildlings*are), .groups = "drop_last") %>% 
  mutate(density = n/daa) %>%
  arrange(desc(density), desc(n), daa)
scaler <- filter(L_arith, nin == contrasttype) %>% 
  pull(density)
L_arith <- mutate(L_arith, fit = density/scaler)
```

```{r, echo=FALSE, results='asis'}
knitr::kable(L_arith, digits = 1)
```

## Height-blind model

Disregards height classes.

For choosing:
1. poisson vs. negative binomial vs. generalized poisson
2. seeds.ExP vs. seeds.WALD

```{r}
modeltypes <- typenames[!(typenames %in% identify_completeseparation(dat, typenames))]
modellocalities <- c(NA, unique(pull(dat, locality)))
newdat <- diag(length(modeltypes)) %>% 
  as_tibble(.name_repair = "minimal") %>% 
  set_names(modeltypes) %>% 
  mutate(nin = modeltypes, .before = 1) %>% 
  slice(rep(1:n(), each = length(modellocalities))) %>% 
  mutate(locality = rep(modellocalities, length(modeltypes)),
         age = 0, bio01 = 0, bio19 = 0, seeds.ExP = 0, seeds.WALD = 0, relelev = 0,
         .before = 1)
```

```{r}
mf <- paste_modelformula(dat, typenames)
m.poissonWALD <- glmmTMB(mf, dat, offset = seeds.WALD, family = "poisson", 
                         ziformula = ~ age + (1 | locality))
summary(m.poissonWALD)
simulationOutput <- simulateResiduals(fittedModel = m.poissonWALD)
testDispersion(simulationOutput)

m.nbinom2WALD <- glmmTMB(mf, dat, offset = seeds.WALD, family = "nbinom2",
                         ziformula = ~ age + (1 | locality))
summary(m.nbinom2WALD)
simulationOutput <- simulateResiduals(fittedModel = m.nbinom2WALD)
testDispersion(simulationOutput)

m.genpoisWALD <- glmmTMB(mf, dat, offset = seeds.WALD, family = "genpois",
                         ziformula = ~ age + (1 | locality))
summary(m.genpoisWALD)
simulationOutput <- simulateResiduals(fittedModel = m.genpoisWALD)
testDispersion(simulationOutput) 
```

Support for generalized Poisson family.

```{r}
m.genpoisExP <- glmmTMB(mf, dat, offset = seeds.ExP, family = "genpois",
                        ziformula = ~ age + (1 | locality))
summary(m.genpoisExP)

m.genpoisNULL <- glmmTMB(mf, dat, offset = NULL, family = "genpois",
                        ziformula = ~ age + (1 | locality))
summary(m.genpoisNULL)
```

```{r, include=FALSE}
L_modelcomp <- bbmle::ICtab(m.genpoisWALD, m.genpoisExP, base = TRUE, 
                             delta = TRUE, sort = FALSE) %>% 
  as_tibble() %>% 
  add_column(`seed dispersal estimate` = c('WALD', 'ExP'), .before = 1) %>% 
  add_row(`seed dispersal estimate` = 'none', AIC = NA, dAIC = NA, df = NA) 
```



### Residual diagnostics

```{r}
simulationOutput <- simulateResiduals(fittedModel = m.genpoisWALD)
plot(simulationOutput)
testZeroInflation(simulationOutput)
```

### Model predictions

```{r}
L_link <- newdat %>% 
  bind_cols(predict(m.genpoisWALD, newdat, se.fit = TRUE, type = "link")) %>% 
  select(locality, fit, se.fit, nin)
```

```{r, include=FALSE}
sensmod <- update(m.genpoisWALD, 
                  update.formula(formula(m.genpoisWALD), ~ . + seeds.WALD), offset = NULL)
newdat <- filter(newdat, is.na(locality))
L_link_sens <- newdat %>% 
  mutate(fit = predict(sensmod, newdat, se.fit = FALSE, type = "conditional")) %>% 
  select(nin, fit)
```

## Height-stratified models

```{r}
dat <- DVi %>% 
  group_split(randomseed, hgtclass) %>% 
  map(~ add_wildlings(IVi, .) %>% 
        st_drop_geometry())
newdat <- filter(newdat, is.na(locality))
  
safe_predict <- safely(predict_from_genpoisWALDmodel)
plan(multisession, workers = availableCores()-1)
res <- dat %>%
  future_map(~ safe_predict(., newdat, typenames))
transpose(res)$error
saveRDS(here('output', 'res-L-byheight.rds'))

modres <- transpose(res)$result
for (i in seq_along(modres)) {
  if(!is.null(modres[[i]])) {
    modres[[i]] <- modres[[i]] %>% 
      mutate(randomseed = rep(seq_len(nrseeds), each = nrhgtclasses)[i],
             hgtclass = rep(seq_len(nrhgtclasses), nrseeds)[i], .before = 1)
  }
}
modres <- modres %>% 
  bind_rows() %>% 
  select(randomseed, hgtclass, fit, se.fit, nin)
```

```{r}
L_link <- L_link %>% 
  bind_rows(modres)
```

# All species

```{r}
species <- c("P.sitchensis-lutzii", "P.abies", "Larix")

arith.list <- list(Ps_arith, Pa_arith, L_arith) %>% 
  set_names(species)

modelcomp.list <- list(Ps_modelcomp, Pa_modelcomp, L_modelcomp) %>% 
  set_names(species)

link.list <- list(Ps_link, Pa_link, L_link) %>% 
  set_names(species)

results <- list(arithmetic = arith.list, 
                model.comp = modelcomp.list,
                model.preds = link.list)
str(results, 2)
saveRDS(results, here("output","results.rds"))
```

```{r, include=FALSE}
link_sens.list <- list(Ps_link_sens, Pa_link_sens, L_link_sens) %>% 
  set_names(species)
saveRDS(link_sens.list, here("output","results-sensitivity.rds"))
```

```{r sessionInfo}
sessionInfo()
```
