---
title: "Modeling relative establishment probability"
output: 
  html_document:
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(here)
library(tidyverse)
library(glmmTMB)
library(DHARMa)
```

# Load data

```{r}
datlist <- readRDS(here("output","data.rds"))
types <- read_csv(here('data','types.csv'))

datlist <- datlist %>% 
  map(~ filter_at(., "plantation forest", all_vars(. < 0.5)) %>% 
        select(-"plantation forest")
  )

locality.preds <- c('age','bio01','bio19','seeds.ExP','seeds.WALD','relelev')
locality.preds.vals <- datlist %>% 
  map(~ select(., !!!syms(locality.preds))) %>% 
  bind_rows() 
gmeans <- map_dbl(locality.preds.vals, mean, na.rm = TRUE)
gsds <- map_dbl(locality.preds.vals, sd, na.rm = TRUE)

contrast <- "T4"
str(datlist, 1)
```

# P.sitchensis-lutzii

```{r}
#Remove types (columns) that do not exist in the species' data
Ps_dat <- Filter(function(x)!all(is.na(x)), datlist$`P.sitchensis-lutzii`) 
```

```{r}
typenames <- names(Ps_dat)[!names(Ps_dat) %in% c('species', 'locality', 
                                                 'wildlings', locality.preds)]
Ps_arith <- pivot_longer(Ps_dat, one_of(typenames), names_to = "nin", values_to = "are") %>%
  group_by(nin) %>% 
  summarize(daa = sum(are)/10, # units from are to decare
            n = sum(wildlings*are)) %>% 
  mutate(density = n/daa) %>%
  arrange(desc(density), desc(n), daa)
scaler <- filter(Ps_arith, nin == contrast) %>% 
  pull(density)
Ps_arith.scaled <- mutate(Ps_arith, fit = density/scaler)
```

```{r, echo=FALSE, results='asis'}
knitr::kable(Ps_arith.scaled, digits = 1)
```

```{r}
perfectlyseparated <- c("T42", "T18", "T3", "T33", "V4")
Ps_dat <- Ps_dat %>% 
  filter_at(perfectlyseparated, all_vars(. < 0.5)) %>%
  filter_at(c('seeds.ExP', 'seeds.WALD'), all_vars(!is.na(.))) %>% 
  select(-c('species'))
sum(complete.cases(Ps_dat)) == nrow(Ps_dat)
```

```{r}
Ps_means <- Ps_dat[, locality.preds] %>% map_dbl(mean)
Ps_sds <- Ps_dat[, locality.preds] %>% map_dbl(sd)
for (i in locality.preds) {
  Ps_dat <- modify_at(Ps_dat, .at = i, ~ (. - Ps_means[i]) / Ps_sds[i])
}
summary(Ps_dat)

paste(typenames[!(typenames %in% c(contrast, perfectlyseparated))], 
      collapse = " + ")
```

### Compare WALD vs ExP

```{r}
Ps_f1 <- formula("wildlings ~ seeds.WALD * age + bio01 + bio19 + relelev + 
                 T45 + artificial + T44 + T32 + V9 + T34 + V12 + V1 + T13 + 
                 T41 + T1 + V2 + T2 + T40 + V10 + T27 + T17 + T29 + T16 + V8 + 
                 T31 + V3 + T6 + V13 + T12 + T24 + T21 + T36 + (1 | locality)")
Ps_m1 <- glmmTMB(Ps_f1, Ps_dat, family = "nbinom2", ziformula = ~ 0)
summary(Ps_m1)
```

```{r}
Ps_m2 <- update(Ps_m1, formula = update.formula(Ps_f1, ~ . - seeds.WALD + seeds.ExP))
summary(Ps_m2)
```

```{r, echo=FALSE}
bbmle::AICtab(Ps_m1, Ps_m2)
```

Continue with WALD.

### Compare zero inflation effects

```{r}
Ps_m3 <- update(Ps_m1, ziformula = ~ 1)
summary(Ps_m3)
```

```{r}
Ps_m4 <- update(Ps_m1, ziformula = ~ age)
summary(Ps_m4)
```

```{r}
Ps_m5 <- update(Ps_m1, ziformula = ~ age + (1 | locality))
summary(Ps_m5)
```

```{r, echo=FALSE}
bbmle::AICtab(Ps_m1, Ps_m3, Ps_m4, Ps_m5)
```

m5 is better than m1, m3, and m4: much better AIC, clear zero-inflation effects

```{r}
simulationOutput <- simulateResiduals(fittedModel = Ps_m5)
plot(simulationOutput)
testDispersion(simulationOutput)
testZeroInflation(simulationOutput)
```

Diagnostics look OK.

### Interpret relative establishment probability

```{r}
selmod <- Ps_m5

terms <- attributes(selmod$frame)$terms
localities <- c(NA, unique(selmod$frame$locality))
newdat <- attributes(terms)$factors %>% 
  as_tibble() %>% 
  select(-`seeds.WALD:age`, -locality) %>% 
  mutate(seeds.WALD = 0, age = 0, bio01 = 0, bio19 = 0, relelev = 0) %>%   
  distinct()
newdat <- newdat %>% 
  mutate(nin = names(newdat)[apply(newdat, 1, match, x = 1)]) %>% 
  replace_na(list(nin = "T4")) %>% 
  expand_grid(locality = c(NA_character_, unique(selmod$frame$locality)))
```

```{r}
Ps_link <- bind_cols(newdat, predict(selmod, newdat, se.fit = TRUE, type = "link"))
Ps_link <- Ps_link %>% 
  select(nin, locality, fit, se.fit) %>% 
  mutate(ci.l = fit - 1.96*se.fit, ci.u = fit + 1.96*se.fit) %>% 
  select(-se.fit) %>% 
  mutate_at(c('fit', 'ci.l', 'ci.u'), ~ exp(.))
scaler <- filter(Ps_link, is.na(locality), nin == "T4") %>% 
  pull(fit)
Ps_link.scaled <- mutate_at(Ps_link, c('fit', 'ci.l', 'ci.u'), ~ `/`(., scaler))
```

```{r}
filter(Ps_link.scaled, is.na(locality)) %>% 
  ggplot(aes(reorder(nin, fit), fit)) + 
  geom_linerange(mapping = aes(ymin = ci.l, ymax = ci.u)) + 
  geom_point()  + 
  geom_point(data = filter(Ps_arith.scaled, nin %in% Ps_link.scaled$nin), 
             col = "grey", pch = 1) + 
  scale_y_log10() + 
  coord_flip()
```

```{r, eval=FALSE, include=FALSE}
cond <- bind_cols(newdat, predict(selmod, newdat, se.fit = TRUE, type = "conditional"))
cond <- cond %>% 
  select(nin, locality, fit, se.fit) %>% 
  mutate(se.l = fit - se.fit, se.u = fit + se.fit) %>% 
  mutate_at(.vars = c('fit', 'se.l', 'se.u'), ~ log(.)) %>% 
  mutate(ci.l = fit + 1.96*(se.l - fit),
         ci.u = fit + 1.96*(se.u - fit)) %>% 
  mutate_at(.vars = c('fit', 'se.l', 'se.u', 'ci.l', 'ci.u'), ~ exp(.))
scaler <- filter(cond, is.na(locality), nin == "T4") %>% 
  pull(fit)
cond.scaled <- mutate_at(cond, .vars = c('fit', 'se.l', 'se.u', 'ci.l', 'ci.u'),
                         ~ `/`(., scaler))

filter(cond.scaled, is.na(locality)) %>% 
  ggplot(aes(reorder(nin, fit), fit)) + 
  geom_linerange(mapping = aes(ymin = ci.l, ymax = ci.u)) + 
  geom_point()  + 
  geom_point(data = filter(Ps_arith.scaled, nin %in% cond.scaled$nin), 
             col = "grey", pch = 1) + 
  scale_y_log10() + 
  coord_flip()
```


# P.abies

```{r}
#Remove types (columns) that do not exist in the species' data
Pa_dat <- Filter(function(x)!all(is.na(x)), datlist$P.abies)
```

```{r}
typenames <- names(Pa_dat)[!names(Pa_dat) %in% c('species', 'locality', 
                                                 'wildlings', locality.preds)]
Pa_arith <- pivot_longer(Pa_dat, one_of(typenames), names_to = "nin", values_to = "are") %>%
  group_by(nin) %>% 
  summarize(daa = sum(are)/10, # units from are to decare
            n = sum(wildlings*are)) %>% 
  mutate(density = n/daa) %>%
  arrange(desc(density), desc(n), daa)
scaler <- filter(Pa_arith, nin == contrast) %>% 
  pull(density)
Pa_arith.scaled <- mutate(Pa_arith, fit = density/scaler)
```

```{r, echo=FALSE, results='asis'}
knitr::kable(Pa_arith.scaled, digits = 1)
```

```{r}
perfectlyseparated <- c("T40", "T42", "T6", "T30", "V8", "T16")
Pa_dat <- Pa_dat %>% 
  filter_at(perfectlyseparated, all_vars(. < 0.5)) %>% 
  filter_at(c('seeds.ExP', 'seeds.WALD'), all_vars(!is.na(.))) %>% 
  select(-c('species'))
sum(complete.cases(Pa_dat)) == nrow(Pa_dat)
```

```{r}
Pa_means <- Pa_dat[, locality.preds] %>% map_dbl(mean)
Pa_sds <- Pa_dat[, locality.preds] %>% map_dbl(sd)
for (i in locality.preds) {
  Pa_dat <- modify_at(Pa_dat, .at = i, ~ (. - Pa_means[i])/Pa_sds[i])
}
summary(Pa_dat)

paste(typenames[!(typenames %in% c(contrast, perfectlyseparated))], 
      collapse = " + ")
```

### Compare WALD vs ExP

```{r}
Pa_f1 <- formula("wildlings ~ seeds.WALD * age + bio01 + bio19 + relelev + 
                 T45 + artificial + T44 + T32 + V9 + V12 + V1 + T13 + T41 + T1 +
                 V2 + T2 + V10 + T31 + V4 + V3 + (1 | locality)")
Pa_m1 <- glmmTMB(Pa_f1, Pa_dat, family = "nbinom2", ziformula = ~ 0)
summary(Pa_m1)
```

```{r}
Pa_m2 <- update(Pa_m1, formula = update.formula(Pa_f1, ~ . - seeds.WALD + seeds.ExP))
summary(Pa_m2)
```

```{r, echo=FALSE}
bbmle::AICtab(Pa_m1, Pa_m2)
```

Continue with WALD.

### Compare zero inflation effects

```{r}
Pa_m3 <- update(Pa_m1, ziformula = ~ 1)
summary(Pa_m3)
```

```{r}
Pa_m4 <- update(Pa_m1, ziformula = ~ age)
summary(Pa_m4)
```

```{r}
Pa_m5 <- update(Pa_m1, ziformula = ~ age + (1 | locality))
summary(Pa_m5)
```

```{r, echo=FALSE}
bbmle::AICtab(Pa_m1, Pa_m3, Pa_m4, Pa_m5)
```

m5 is better than m1, m3, and m4: much better AIC, zero-inflation effects

```{r}
simulationOutput <- simulateResiduals(fittedModel = Pa_m5)
plot(simulationOutput)
testDispersion(simulationOutput)
testZeroInflation(simulationOutput)
```

Model residuals are underdispersed.

```{r}
Pa_m6 <- update(Pa_m5, family = "genpois")
summary(Pa_m6)
```

```{r}
simulationOutput <- simulateResiduals(fittedModel = Pa_m6)
plot(simulationOutput)
testDispersion(simulationOutput)
testZeroInflation(simulationOutput)
```

Diagnostics OK with generalized poisson --- including dispersion.

```{r}
Pa_m7 <- update(Pa_m5, family = "poisson")
summary(Pa_m7)
```

```{r}
simulationOutput <- simulateResiduals(fittedModel = Pa_m7)
plot(simulationOutput)
testDispersion(simulationOutput)
testZeroInflation(simulationOutput)
```

Diagnostics OK with poisson --- including dispersion.

```{r, echo=FALSE}
bbmle::AICtab(Pa_m5, Pa_m6, Pa_m7)
```

Continue with generalized poisson model: best AIC and diagnostics OK. 

### Interpret relative establishment probability

```{r}
selmod <- Pa_m6

terms <- attributes(selmod$frame)$terms
localities <- c(NA, unique(selmod$frame$locality))
newdat <- attributes(terms)$factors %>% 
  as_tibble() %>% 
  select(-`seeds.WALD:age`, -locality) %>% 
  mutate(seeds.WALD = 0, age = 0, bio01 = 0, bio19 = 0, relelev = 0) %>%   
  distinct()
newdat <- newdat %>% 
  mutate(nin = names(newdat)[apply(newdat, 1, match, x = 1)]) %>% 
  replace_na(list(nin = "T4")) %>% 
  expand_grid(locality = c(NA_character_, unique(selmod$frame$locality)))
```

```{r}
Pa_link <- bind_cols(newdat, predict(selmod, newdat, se.fit = TRUE, type = "link"))
Pa_link <- Pa_link %>% 
  select(nin, locality, fit, se.fit) %>% 
  mutate(ci.l = fit - 1.96*se.fit, ci.u = fit + 1.96*se.fit) %>% 
  select(-se.fit) %>% 
  mutate_at(c('fit', 'ci.l', 'ci.u'), ~ exp(.))
scaler <- filter(Pa_link, is.na(locality), nin == "T4") %>% 
  pull(fit)
Pa_link.scaled <- mutate_at(Pa_link, c('fit', 'ci.l', 'ci.u'), ~ `/`(., scaler))
```

```{r}
filter(Pa_link.scaled, is.na(locality)) %>% 
  ggplot(aes(reorder(nin, fit), fit)) + 
  geom_linerange(mapping = aes(ymin = ci.l, ymax = ci.u)) + 
  geom_point()  + 
  geom_point(data = filter(Pa_arith.scaled, nin %in% Pa_link.scaled$nin), 
             col = "grey", pch = 1) + 
  scale_y_log10() + 
  coord_flip()
```

```{r, eval=FALSE, include=FALSE}
cond <- bind_cols(newdat, predict(selmod, newdat, se.fit = TRUE, type = "conditional"))
cond <- cond %>% 
  select(nin, locality, fit, se.fit) %>% 
  mutate(se.l = fit - se.fit, se.u = fit + se.fit) %>% 
  mutate_at(.vars = c('fit', 'se.l', 'se.u'), ~ log(.)) %>% 
  mutate(ci.l = fit + 1.96*(se.l - fit),
         ci.u = fit + 1.96*(se.u - fit)) %>% 
  mutate_at(.vars = c('fit', 'se.l', 'se.u', 'ci.l', 'ci.u'), ~ exp(.))
scaler <- filter(cond, is.na(locality), nin == "T4") %>% 
  pull(fit)
cond.scaled <- mutate_at(cond, .vars = c('fit', 'se.l', 'se.u', 'ci.l', 'ci.u'),
                         ~ `/`(., scaler))

filter(cond.scaled, is.na(locality)) %>% 
  ggplot(aes(reorder(nin, fit), fit)) + 
  geom_linerange(mapping = aes(ymin = ci.l, ymax = ci.u)) + 
  geom_point()  + 
  geom_point(data = filter(Pa_arith.scaled, nin %in% cond.scaled$nin), 
             col = "grey", pch = 1) + 
  scale_y_log10() + 
  coord_flip()
```


# Larix

```{r}
#Remove types (columns) that do not exist in the species' data
L_dat <- Filter(function(x)!all(is.na(x)), datlist$Larix)
```

```{r}
typenames <- names(L_dat)[!names(L_dat) %in% c('species', 'locality', 
                                               'wildlings', locality.preds)]
L_arith <- pivot_longer(L_dat, one_of(typenames), names_to = "nin", values_to = "are") %>%
  group_by(nin) %>% 
  summarize(daa = sum(are)/10, # units from are to decare
            n = sum(wildlings*are)) %>% 
  mutate(density = n/daa) %>%
  arrange(desc(density), desc(n), daa)
scaler <- filter(L_arith, nin == contrast) %>% 
  pull(density)
L_arith.scaled <- mutate(L_arith, fit = density/scaler)
```

```{r, echo=FALSE, results='asis'}
knitr::kable(L_arith.scaled, digits = 1)
```

```{r}
perfectlyseparated <- c("T18", "T29", "T27", "T2", "T40", "T30", "T13", "T42", 
                        "V12", "V10")
L_dat <- L_dat %>% 
  filter_at(perfectlyseparated, all_vars(. < 0.5)) %>%
  filter_at(c('seeds.ExP', 'seeds.WALD'), all_vars(!is.na(.))) %>% 
  select(-c('species'))
sum(complete.cases(L_dat)) == nrow(L_dat)
```

```{r}
L_means <- L_dat[, locality.preds] %>% map_dbl(mean)
L_sds <- L_dat[, locality.preds] %>% map_dbl(sd)
for (i in locality.preds) {
  L_dat <- modify_at(L_dat, .at = i, ~ (. - L_means[i])/L_sds[i])
}
summary(L_dat)

paste(typenames[!(typenames %in% c(contrast, perfectlyseparated))], 
      collapse = " + ")
```

### Compare WALD vs ExP

```{r}
L_f1 <- formula("wildlings ~ seeds.WALD * age + bio01 + bio19 + relelev + 
                T45 + artificial + T44 + T32 + V9 + T34 + V1 + T41 + T1 + V2 + 
                T17 + (1 | locality)")
L_m1 <- glmmTMB(L_f1, L_dat, family = "nbinom2", ziformula = ~ 0)
summary(L_m1)
```

```{r}
L_m2 <- update(L_m1, formula = update.formula(L_f1, ~ . - seeds.WALD + seeds.ExP))
summary(L_m2)
```

```{r, echo=FALSE}
bbmle::AICtab(L_m1, L_m2)
```

Continue with WALD.

### Compare zero inflation effects

```{r}
L_m3 <- update(L_m1, ziformula = ~ 1)
summary(L_m3)
```

```{r}
L_m4 <- update(L_m1, ziformula = ~ age)
summary(L_m4)
```

```{r}
L_m5 <- update(L_m1, ziformula = ~ age + (1 | locality))
summary(L_m5)
```

```{r, echo=FALSE}
bbmle::AICtab(L_m1, L_m3, L_m4, L_m5)
```

m5 is better than m1, m3, and m4: much better AIC, clear zero-inflation effects

```{r}
simulationOutput <- simulateResiduals(fittedModel = L_m5)
plot(simulationOutput)
testDispersion(simulationOutput)
testZeroInflation(simulationOutput)
```

Diagnostics look OK.

### Interpret relative establishment probability

```{r}
selmod <- L_m5

terms <- attributes(selmod$frame)$terms
localities <- c(NA, unique(selmod$frame$locality))
newdat <- attributes(terms)$factors %>% 
  as_tibble() %>% 
  select(-`seeds.WALD:age`, -locality) %>% 
  mutate(seeds.WALD = 0, age = 0, bio01 = 0, bio19 = 0, relelev = 0) %>%   
  distinct()
newdat <- newdat %>% 
  mutate(nin = names(newdat)[apply(newdat, 1, match, x = 1)]) %>% 
  replace_na(list(nin = "T4")) %>% 
  expand_grid(locality = c(NA_character_, unique(selmod$frame$locality)))
```

```{r}
L_link <- bind_cols(newdat, predict(selmod, newdat, se.fit = TRUE, type = "link"))
L_link <- L_link %>% 
  select(nin, locality, fit, se.fit) %>% 
  mutate(ci.l = fit - 1.96*se.fit, ci.u = fit + 1.96*se.fit) %>% 
  select(-se.fit) %>% 
  mutate_at(c('fit', 'ci.l', 'ci.u'), ~ exp(.))
scaler <- filter(L_link, is.na(locality), nin == "T4") %>% 
  pull(fit)
L_link.scaled <- mutate_at(L_link, c('fit', 'ci.l', 'ci.u'), ~ `/`(., scaler))
```

```{r}
filter(L_link.scaled, is.na(locality)) %>% 
  ggplot(aes(reorder(nin, fit), fit)) + 
  geom_linerange(mapping = aes(ymin = ci.l, ymax = ci.u)) + 
  geom_point()  + 
  geom_point(data = filter(L_arith.scaled, nin %in% L_link.scaled$nin), 
             col = "grey", pch = 1) + 
  scale_y_log10() + 
  coord_flip()
```

```{r, eval=FALSE, include=FALSE}
cond <- bind_cols(newdat, predict(selmod, newdat, se.fit = TRUE, type = "conditional"))
cond <- cond %>% 
  select(nin, locality, fit, se.fit) %>% 
  mutate(se.l = fit - se.fit, se.u = fit + se.fit) %>% 
  mutate_at(.vars = c('fit', 'se.l', 'se.u'), ~ log(.)) %>% 
  mutate(ci.l = fit + 1.96*(se.l - fit),
         ci.u = fit + 1.96*(se.u - fit)) %>% 
  mutate_at(.vars = c('fit', 'se.l', 'se.u', 'ci.l', 'ci.u'), ~ exp(.))
scaler <- filter(cond, is.na(locality), nin == "T4") %>% 
  pull(fit)
cond.scaled <- mutate_at(cond, .vars = c('fit', 'se.l', 'se.u', 'ci.l', 'ci.u'),
                         ~ `/`(., scaler))

filter(cond.scaled, is.na(locality)) %>% 
  ggplot(aes(reorder(nin, fit), fit)) + 
  geom_linerange(mapping = aes(ymin = ci.l, ymax = ci.u)) + 
  geom_point()  + 
  geom_point(data = filter(L_arith.scaled, nin %in% cond.scaled$nin), 
             col = "grey", pch = 1) + 
  scale_y_log10() + 
  coord_flip()
```


# P.contorta

```{r}
#Remove types (columns) that do not exist in the species' data
Pc_dat <- Filter(function(x)!all(is.na(x)), datlist$P.contorta)
```

```{r}
typenames <- names(Pc_dat)[!names(Pc_dat) %in% c('species', 'locality', 
                                                 'wildlings', locality.preds)]
Pc_arith <- pivot_longer(Pc_dat, one_of(typenames), names_to = "nin", values_to = "are") %>%
  group_by(nin) %>% 
  summarize(daa = sum(are)/10, # units from are to decare
            n = sum(wildlings*are)) %>% 
  mutate(density = n/daa) %>%
  arrange(desc(density), desc(n), daa)
scaler <- filter(Pc_arith, nin == contrast) %>% 
  pull(density)
Pc_arith.scaled <- mutate(Pc_arith, fit = density/scaler)
```

```{r, echo=FALSE, results='asis'}
knitr::kable(Pc_arith, digits = 1)
```

```{r}
perfectlyseparated <- c("V10", "V11", "V2", "T45", "T27", "T32")
Pc_dat <- Pc_dat %>% 
  filter_at(perfectlyseparated, all_vars(. < 0.5)) %>%
  filter_at(c('seeds.ExP', 'seeds.WALD'), all_vars(!is.na(.))) %>%
  select(-c('species'))
sum(complete.cases(Pc_dat)) == nrow(Pc_dat)
```

```{r}
Pc_means <- Pc_dat[, locality.preds] %>% map_dbl(mean)
Pc_sds <- Pc_dat[, locality.preds] %>% map_dbl(sd)
for (i in locality.preds) {
  Pc_dat <- modify_at(Pc_dat, .at = i, ~ (. - Pc_means[i])/Pc_sds[i])
}
summary(Pc_dat)

paste(typenames[!(typenames %in% c(contrast, perfectlyseparated))], 
      collapse = " + ")
```

### Compare WALD vs ExP

```{r}
Pc_f1 <- formula("wildlings ~ seeds.WALD * age + bio01 + bio19 + relelev + 
                 artificial + T34 + V1 + T1 + T40 + T30 + V8 + V3 + (1 | locality)")
Pc_m1 <- glmmTMB(Pc_f1, Pc_dat, family = "nbinom2", ziformula = ~ 0)
summary(Pc_m1)
```

```{r}
Pc_m2 <- update(Pc_m1, formula = update.formula(Pc_f1, ~ . - seeds.WALD + seeds.ExP))
summary(Pc_m2)
```

```{r, echo=FALSE}
bbmle::AICtab(Pc_m1, Pc_m2)
```

Continue with WALD.

### Compare zero inflation effects

```{r}
Pc_m3 <- update(Pc_m1, ziformula = ~ 1)
summary(Pc_m3)
```

```{r}
Pc_m4 <- update(Pc_m1, ziformula = ~ age)
summary(Pc_m4)
```

```{r}
Pc_m5 <- update(Pc_m1, ziformula = ~ age + (1 | locality))
# Warning messages:
# 1: In fitTMB(TMBStruc) :
#   Model convergence problem; non-positive-definite Hessian matrix. See vignette('troubleshooting')
# 2: In fitTMB(TMBStruc) :
#   Model convergence problem; false convergence (8). See vignette('troubleshooting')
summary(Pc_m5)
```

From glmmTMB troubleshooting vignette: 

> "This warning (Model convergence problem; non-positive-definite Hessian matrix) states that at glmmTMB’s maximum-likelihood estimate, the curvature of the negative log-likelihood surface is inconsistent with glmmTMB really having found the best fit (minimum): instead, the surface is downward-curving, or flat, in some direction(s). 
>
> These problems are most likely:  
> - when a model is overparameterized (i.e. the data does not contain enough information to estimate the parameters reliably)  
> - when a random-effect variance is estimated to be zero, or random-effect terms are estimated to be perfectly correlated (“singular fit”: often caused by having too few levels of the random-effect grouping variable)  
> - when zero-inflation is estimated to be near zero (a strongly negative zero-inflation parameter)  
> - when dispersion is estimated to be near zero  

> In general models with non-positive definite Hessian matrices should be excluded from further consideration."

The six P.contorta localities are in two small regional clusters, and we have two climatic predictors in the model. Coefficients also suggest this may be a source of overparameterization. Try dropping climatic predictors:

```{r, eval=FALSE}
Pc_m6 <- update(Pc_m5, formula = update.formula(Pc_f1, ~ . - bio01 - bio19))
# Error in optimHess(par.fixed, obj$fn, obj$gr) : 
#   gradient in optim evaluated to length 1 not 18
```

The random effect variance of locality in the conditional model is estimated to be near zero. Try dropping:

```{r}
ranef(Pc_m5)$cond
Pc_m7 <- update(Pc_m5, formula = update.formula(Pc_f1, ~ . - (1 | locality)))
# Warning messages:
# 1: In fitTMB(TMBStruc) :
#   Model convergence problem; non-positive-definite Hessian matrix. See vignette('troubleshooting')
# 2: In fitTMB(TMBStruc) :
#   Model convergence problem; false convergence (8). See vignette('troubleshooting')
```

```{r, echo=FALSE}
bbmle::AICtab(Pc_m3, Pc_m4)
```

```{r}
simulationOutput <- simulateResiduals(fittedModel = Pc_m4)
plot(simulationOutput)
testDispersion(simulationOutput)
testZeroInflation(simulationOutput)
```

Continue with m4 (ziformula = ~ age): best AIC and diagnostics OK. 

### Interpret relative establishment probability

```{r}
selmod <- Pc_m4

terms <- attributes(selmod$frame)$terms
localities <- c(NA, unique(selmod$frame$locality))
newdat <- attributes(terms)$factors %>% 
  as_tibble() %>% 
  select(-`seeds.WALD:age`, -locality) %>% 
  mutate(seeds.WALD = 0, age = 0, bio01 = 0, bio19 = 0, relelev = 0) %>%   
  distinct()
newdat <- newdat %>% 
  mutate(nin = names(newdat)[apply(newdat, 1, match, x = 1)]) %>% 
  replace_na(list(nin = "T4")) %>% 
  expand_grid(locality = c(NA_character_, unique(selmod$frame$locality)))
```

```{r}
Pc_link <- bind_cols(newdat, predict(selmod, newdat, se.fit = TRUE, type = "link"))
Pc_link <- Pc_link %>% 
  select(nin, locality, fit, se.fit) %>% 
  mutate(ci.l = fit - 1.96*se.fit, ci.u = fit + 1.96*se.fit) %>% 
  select(-se.fit) %>% 
  mutate_at(c('fit', 'ci.l', 'ci.u'), ~ exp(.))
scaler <- filter(Pc_link, is.na(locality), nin == "T4") %>% 
  pull(fit)
Pc_link.scaled <- mutate_at(Pc_link, c('fit', 'ci.l', 'ci.u'), ~ `/`(., scaler))
```

```{r}
filter(Pc_link.scaled, is.na(locality)) %>% 
  ggplot(aes(reorder(nin, fit), fit)) + 
  geom_linerange(mapping = aes(ymin = ci.l, ymax = ci.u)) + 
  geom_point()  + 
  geom_point(data = filter(Pc_arith.scaled, nin %in% Pc_link.scaled$nin), 
             col = "grey", pch = 1) + 
  scale_y_log10() + 
  coord_flip()
```

```{r, eval=FALSE, include=FALSE}
cond <- bind_cols(newdat, predict(selmod, newdat, se.fit = TRUE, type = "conditional"))
cond <- cond %>% 
  select(nin, locality, fit, se.fit) %>% 
  mutate(se.l = fit - se.fit, se.u = fit + se.fit) %>% 
  mutate_at(.vars = c('fit', 'se.l', 'se.u'), ~ log(.)) %>% 
  mutate(ci.l = fit + 1.96*(se.l - fit),
         ci.u = fit + 1.96*(se.u - fit)) %>% 
  mutate_at(.vars = c('fit', 'se.l', 'se.u', 'ci.l', 'ci.u'), ~ exp(.))
scaler <- filter(cond, is.na(locality), nin == "T4") %>% 
  pull(fit)
cond.scaled <- mutate_at(cond, .vars = c('fit', 'se.l', 'se.u', 'ci.l', 'ci.u'),
                         ~ `/`(., scaler))

filter(cond.scaled, is.na(locality)) %>% 
  ggplot(aes(reorder(nin, fit), fit)) + 
  geom_linerange(mapping = aes(ymin = ci.l, ymax = ci.u)) + 
  geom_point()  + 
  geom_point(data = filter(Pc_arith.scaled, nin %in% cond.scaled$nin), 
             col = "grey", pch = 1) + 
  scale_y_log10() + 
  coord_flip()
```


# All species

```{r}
species <- c("P.sitchensis-lutzii", "P.abies", "Larix", "P.contorta")

arith.list <- list(Ps_arith.scaled, Pa_arith.scaled, L_arith.scaled, Pc_arith.scaled)
names(arith.list) <- species

means <- rbind(Ps_means, Pa_means, L_means, Pc_means) %>% 
  as_tibble() %>% 
  add_column(species = species, .before = "age")
sds <- rbind(Ps_sds, Pa_sds, L_sds, Pc_sds) %>% 
  as_tibble() %>% 
  add_column(species = species, .before = "age")

models.list <- list(Ps_m5, Pa_m6, L_m5, Pc_m4)
names(models.list) <- species

link.list <- list(Ps_link.scaled, Pa_link.scaled, L_link.scaled, Pc_link.scaled)
names(link.list) <- species

results <- list(arithmetic = arith.list, 
                predictor.means = means, 
                predictor.sds = sds, 
                models = models.list, 
                model.preds = link.list)
str(results, 2)
saveRDS(results, here("output","results.rds"))
```

# sessionInfo

```{r sessionInfo}
sessionInfo()
```

