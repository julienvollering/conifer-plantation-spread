---
title: "Exploring WALD"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Below I compare two WALD models: one defined based on equations from Skarpaas & Shea 2007 (including appendix) and one defined as in the 'conifer dispersal functions.R' script.

## From Skarpaas & Shea 2007 

```{r statmod dinvgauss, include=FALSE}
plot(statmod::dinvgauss(1:100, mean=10, shape=5),
     SuppDists::dinvGauss(1:100, nu=10, lambda=5)) 
```

Eq. 6 and 7:

```{r define nu lambda}
nu <- function(H, U, Fm) {H*U/Fm}
lambda <- function(H, sigma) {(H/sigma)^2}
```

Eq. A1:
(note that the lower bound of integration was changed to match the conifer dispersal functions.)

```{r eq A1}
integral <- function(z, ustar, K=0.4, d, z0) {
  (ustar/K)*log((z-d)/z0)
}
U <- function(H, ustar, K=0.4, d, z0) {
  (1/H)*integrate(integral, 
                  lower=z0+d, upper=H, # 0 set to z0, +dhat to avoid log(negative)
                  ustar=ustar, d=d, z0=z0)$value 
}
```

Eq. A2:

```{r eq A2}
ustar <- function(K=0.4, Um, z, d, z0) {
  K*Um/log((z-d)/z0)
}
```

Eq. A4:
(note K)

```{r eq A4}
sigma <- function(Aw=1.3, K=0.4, z, d, ustar, C0=3.125, U) {
  (2*Aw^2)*sqrt((K*(z-d)*ustar)/(C0*U))
}
```

## From 'conifer dispersal functions.R'

```{r script}
logprofile <- function(z,K=0.4,z0,d,zm) {log((z-d)/z0)/K}   # Wind profile, for parameters z and d see Wieringa 1993

getWALDpar <- function(Fval,H,U10,sigma=NULL,z0,d, K=0.4)
{
  ustar <- K*U10/log((10-d)/z0)
  U <- (ustar/H)*integrate(logprofile,lower=z0+d,upper=H,K=0.4,z0=z0,d=d,zm=10)$value  # compute average wind speed between H and z0+d
  if(is.null(sigma)) sigma <- sqrt( (4*((1.3)^4)*(10-d)/3.125) * ustar/U ) #JV: missing K compared to eq. A4?
  nu <- H*U/Fval
  lambda <- (H/sigma)^2
  pars <- c(Fval,H,U10,sigma,z0,d,ustar,nu,lambda)
  if(any(is.na(pars))) print(pars)
  list(nu,lambda)
}

dWALD.UF <- function(r,U10,H,sigma,Fm,z0,d)
{
  p <- getWALDpar(Fm,H,U10,sigma,z0,d)
  SuppDists::dinvGauss(r,nu=p[[1]],lambda=p[[2]])
}
```

## Test parameters

Set some parameters to compare specific kernels. Aiming for parameters within realistic ranges for the current study (release height 15 m, terminal velocity of Lutz seeds, wind speed 12 m/s, vegetation height 1 m).

```{r params}
Hhat <- 15
Fmhat <- mean(c(0.94,0.62))
Umhat <- 12 
zhat <- 10
hhat <- 1
dhat <- 0.7*hhat
z0hat <- 0.1*hhat
```

```{r WALD}
mod1 <- function(x, H, Fm, Um, z, h, d, z0) {
  ustarhat <- ustar(Um=Umhat, z=zhat, d=dhat, z0=z0hat)
  Uhat <- U(H=Hhat, ustar=ustarhat, d=dhat, z0=z0hat)
  sigmahat <- sigma(z=zhat, d=dhat, ustar=ustarhat, U=Uhat)
  nuhat <- nu(H=Hhat, U=Uhat, Fm=Fmhat)
  lambdahat <- lambda(H=Hhat, sigma=sigmahat)
  statmod::dinvgauss(x, mean=nuhat, shape=lambdahat)
}

mod2 <- function(r,U10=Umhat,H=Hhat,sigma=NULL,Fm=Fmhat,z0=z0hat,d=dhat) {
  dWALD.UF(r,U10,H,sigma,Fm,z0,d)
}
```

Comparing graphically up to 250 m:

```{r plot}
i <- seq(0, 250, by=5)
plot(i, mod2(i))
points(i, mod1(i), pch=2)
legend("topright", c("kernel from conifer dispersal functions", "kernel from Skarpass 2007 app"), pch=c(1,2))
```

To my eye, the difference in probability density seems sufficient to affect estimation of relative establishment probabilities substantially. That is why I'm concerned about the difference. 

Now, to confirm that the difference is attributable to eq. A4, delete K and compare to the same kernel from conifer dispersal functions:

```{r model difference}
sigma.modified <- function(Aw=1.3, K=0.4, z, d, ustar, C0=3.125, U) {
  (2*Aw^2)*sqrt(((z-d)*ustar)/(C0*U))
}

mod3 <- function(x, H, Fm, Um, z, h, d, z0) {
  ustarhat <- ustar(Um=Umhat, z=zhat, d=dhat, z0=z0hat)
  Uhat <- U(H=Hhat, ustar=ustarhat, d=dhat, z0=z0hat)
  sigmahat <- sigma.modified(z=zhat, d=dhat, ustar=ustarhat, U=Uhat)
  nuhat <- nu(H=Hhat, U=Uhat, Fm=Fmhat)
  lambdahat <- lambda(H=Hhat, sigma=sigmahat)
  statmod::dinvgauss(x, mean=nuhat, shape=lambdahat)
}

plot(i, mod2(i))
points(i, mod3(i), pch=3)
legend("topright", c("kernel from script", "kernel from Skarpass 2007 (K deleted from eq A4)"), pch=c(1,3))
```
 
 
```{r sessionInfo}
sessionInfo()
```
 
 